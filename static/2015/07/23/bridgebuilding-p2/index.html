<!DOCTYPE html>
<html lang="en-GB">

<head>
	<meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="pingback" href="https://samnicholls.net/xmlrpc.php">

	
	<title>The Tolls of Bridge Building: Part II, Construction &#8211; Samposium</title>
<meta name='robots' content='max-image-preview:large' />
<link rel='dns-prefetch' href='//s0.wp.com' />
<link rel='dns-prefetch' href='//fonts.googleapis.com' />
<link rel='dns-prefetch' href='//s.w.org' />
<link rel="alternate" type="application/rss+xml" title="Samposium &raquo; Feed" href="https://samnicholls.net/feed/" />
<link rel="alternate" type="application/rss+xml" title="Samposium &raquo; Comments Feed" href="https://samnicholls.net/comments/feed/" />
<link rel="alternate" type="application/rss+xml" title="Samposium &raquo; The Tolls of Bridge Building: Part II, Construction Comments Feed" href="https://samnicholls.net/2015/07/23/bridgebuilding-p2/feed/" />
		<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/13.0.1\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/13.0.1\/svg\/","svgExt":".svg","source":{"concatemoji":"https:\/\/samnicholls.net\/wp-includes\/js\/wp-emoji-release.min.js?ver=5.7.5"}};
			!function(e,a,t){var n,r,o,i=a.createElement("canvas"),p=i.getContext&&i.getContext("2d");function s(e,t){var a=String.fromCharCode;p.clearRect(0,0,i.width,i.height),p.fillText(a.apply(this,e),0,0);e=i.toDataURL();return p.clearRect(0,0,i.width,i.height),p.fillText(a.apply(this,t),0,0),e===i.toDataURL()}function c(e){var t=a.createElement("script");t.src=e,t.defer=t.type="text/javascript",a.getElementsByTagName("head")[0].appendChild(t)}for(o=Array("flag","emoji"),t.supports={everything:!0,everythingExceptFlag:!0},r=0;r<o.length;r++)t.supports[o[r]]=function(e){if(!p||!p.fillText)return!1;switch(p.textBaseline="top",p.font="600 32px Arial",e){case"flag":return s([127987,65039,8205,9895,65039],[127987,65039,8203,9895,65039])?!1:!s([55356,56826,55356,56819],[55356,56826,8203,55356,56819])&&!s([55356,57332,56128,56423,56128,56418,56128,56421,56128,56430,56128,56423,56128,56447],[55356,57332,8203,56128,56423,8203,56128,56418,8203,56128,56421,8203,56128,56430,8203,56128,56423,8203,56128,56447]);case"emoji":return!s([55357,56424,8205,55356,57212],[55357,56424,8203,55356,57212])}return!1}(o[r]),t.supports.everything=t.supports.everything&&t.supports[o[r]],"flag"!==o[r]&&(t.supports.everythingExceptFlag=t.supports.everythingExceptFlag&&t.supports[o[r]]);t.supports.everythingExceptFlag=t.supports.everythingExceptFlag&&!t.supports.flag,t.DOMReady=!1,t.readyCallback=function(){t.DOMReady=!0},t.supports.everything||(n=function(){t.readyCallback()},a.addEventListener?(a.addEventListener("DOMContentLoaded",n,!1),e.addEventListener("load",n,!1)):(e.attachEvent("onload",n),a.attachEvent("onreadystatechange",function(){"complete"===a.readyState&&t.readyCallback()})),(n=t.source||{}).concatemoji?c(n.concatemoji):n.wpemoji&&n.twemoji&&(c(n.twemoji),c(n.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
	<link rel='stylesheet' id='crayon-css'  href='https://samnicholls.net/wp-content/plugins/crayon-syntax-highlighter/css/min/crayon.min.css?ver=_2.7.2_beta' type='text/css' media='all' />
<link rel='stylesheet' id='crayon-theme-github-css'  href='https://samnicholls.net/wp-content/plugins/crayon-syntax-highlighter/themes/github/github.css?ver=_2.7.2_beta' type='text/css' media='all' />
<link rel='stylesheet' id='crayon-font-monaco-css'  href='https://samnicholls.net/wp-content/plugins/crayon-syntax-highlighter/fonts/monaco.css?ver=_2.7.2_beta' type='text/css' media='all' />
<link rel='stylesheet' id='wp-block-library-css'  href='https://samnicholls.net/wp-includes/css/dist/block-library/style.min.css?ver=5.7.5' type='text/css' media='all' />
<link rel='stylesheet' id='css-style-css'  href='https://samnicholls.net/wp-content/themes/responsive-deluxe/css/style.css?ver=5.7.5' type='text/css' media='all' />
<link rel='stylesheet' id='child-style-css'  href='https://samnicholls.net/wp-content/themes/responsive-deluxe-child/style.css?ver=5.7.5' type='text/css' media='all' />
<link rel='stylesheet' id='lato-css'  href='//fonts.googleapis.com/css?family=Lato%3A400%2C700%2C400italic&#038;ver=5.7.5' type='text/css' media='all' />
<link rel='stylesheet' id='slabo-css'  href='//fonts.googleapis.com/css?family=Slabo+27px&#038;ver=5.7.5' type='text/css' media='all' />
<link rel='stylesheet' id='fa-css'  href='https://samnicholls.net/wp-content/themes/responsive-deluxe/css/font-awesome.css?ver=5.7.5' type='text/css' media='all' />
<link rel='stylesheet' id='rd-style-css'  href='https://samnicholls.net/wp-content/themes/responsive-deluxe-child/style.css?ver=5.7.5' type='text/css' media='all' />
<link rel='stylesheet' id='css-custom-css'  href='https://samnicholls.net/wp-content/themes/responsive-deluxe/css/custom.css?ver=5.7.5' type='text/css' media='all' />
<link rel='stylesheet' id='jetpack_css-css'  href='https://samnicholls.net/wp-content/plugins/jetpack/css/jetpack.css?ver=4.9' type='text/css' media='all' />
<script type='text/javascript' src='https://samnicholls.net/wp-includes/js/jquery/jquery.min.js?ver=3.5.1' id='jquery-core-js'></script>
<script type='text/javascript' src='https://samnicholls.net/wp-includes/js/jquery/jquery-migrate.min.js?ver=3.3.2' id='jquery-migrate-js'></script>
<script type='text/javascript' id='crayon_js-js-extra'>
/* <![CDATA[ */
var CrayonSyntaxSettings = {"version":"_2.7.2_beta","is_admin":"0","ajaxurl":"https:\/\/samnicholls.net\/wp-admin\/admin-ajax.php","prefix":"crayon-","setting":"crayon-setting","selected":"crayon-setting-selected","changed":"crayon-setting-changed","special":"crayon-setting-special","orig_value":"data-orig-value","debug":""};
var CrayonSyntaxStrings = {"copy":"Press %s to Copy, %s to Paste","minimize":"Click To Expand Code"};
/* ]]> */
</script>
<script type='text/javascript' src='https://samnicholls.net/wp-content/plugins/crayon-syntax-highlighter/js/min/crayon.min.js?ver=_2.7.2_beta' id='crayon_js-js'></script>
<script type='text/javascript' src='https://samnicholls.net/wp-content/plugins/fd-footnotes/fdfootnotes.js?ver=1.34' id='fdfootnote_script-js'></script>
<script type='text/javascript' src='https://samnicholls.net/wp-content/themes/responsive-deluxe/js/bootstrap.js?ver=5.7.5' id='bootstrap-js'></script>
<script type='text/javascript' src='https://samnicholls.net/wp-content/themes/responsive-deluxe/js/custom.js?ver=5.7.5' id='js-custom-js'></script>
<link rel="https://api.w.org/" href="https://samnicholls.net/wp-json/" /><link rel="alternate" type="application/json" href="https://samnicholls.net/wp-json/wp/v2/posts/174" /><link rel="EditURI" type="application/rsd+xml" title="RSD" href="https://samnicholls.net/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="https://samnicholls.net/wp-includes/wlwmanifest.xml" /> 
<meta name="generator" content="WordPress 5.7.5" />
<link rel="canonical" href="https://samnicholls.net/2015/07/23/bridgebuilding-p2/" />
<link rel='shortlink' href='https://wp.me/p6RfP0-2O' />
<link rel="alternate" type="application/json+oembed" href="https://samnicholls.net/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fsamnicholls.net%2F2015%2F07%2F23%2Fbridgebuilding-p2%2F" />
<link rel="alternate" type="text/xml+oembed" href="https://samnicholls.net/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fsamnicholls.net%2F2015%2F07%2F23%2Fbridgebuilding-p2%2F&#038;format=xml" />
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-62206786-1', 'auto');
  ga('send', 'pageview');

</script>


<link rel='dns-prefetch' href='//v0.wordpress.com'>
<style type='text/css'>img#wpstats{display:none}</style>
<!-- Jetpack Open Graph Tags -->
<meta property="og:type" content="article" />
<meta property="og:title" content="The Tolls of Bridge Building: Part II, Construction" />
<meta property="og:url" content="https://samnicholls.net/2015/07/23/bridgebuilding-p2/" />
<meta property="og:description" content="Last time on Samposium, I gave a more detailed look at the project I&#8217;m working on and an overview of what has been done so far. We have 870 lanelets to pre-process and improve into samples. Iâ€¦" />
<meta property="article:published_time" content="2015-07-23T11:00:47+00:00" />
<meta property="article:modified_time" content="2016-01-18T12:26:04+00:00" />
<meta property="og:site_name" content="Samposium" />
<meta property="og:image" content="http://samnicholls.net/wp-content/uploads/2015/07/bridge_builder_v1-418x1024.png" />
<meta property="og:locale" content="en_GB" />
<meta name="twitter:card" content="summary" />
</head>

<body class="post-template-default single single-post postid-174 single-format-standard">


        
<header id="main-header">
    <nav class="navbar-default navbar-static-top navbar" role="navigation">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#rd-collapse">
                    <span class="fa fa-bars"></span>
                    <span class="sr-only screen-reader-text">Toggle navigation</span>
                </button>
                <a class="navbar-brand" href=" https://samnicholls.net/">Samposium</a>            </div>
            
            <div id="rd-collapse" class="collapse navbar-collapse">
            
            <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<html><body class="post-template-default single single-post postid-174 single-format-standard">

<div id="main-menu" class="navbar-nav nav"><ul>
<li class="page_item page-item-8"><a href="https://samnicholls.net/about/">About Me</a></li>
<li class="page_item page-item-11"><a href="https://samnicholls.net/talks/">Talks</a></li>
<li class="page_item page-item-15"><a href="https://samnicholls.net/things-i-have-learned/">Things I Have Learned</a></li>
</ul></div></body></html>
        </div>

        </div>
    </nav>
</header>

<div class="container">

    <div class="row"><!-- Content -->
<section class="col-md-8 content-container">
                          <article class="card post hentry post-174 type-post status-publish format-standard category-sanger-qc tag-bridgebuilder tag-quality-control tag-reference tag-remapping tag-sanger" id="post-174">
                <header class="entry-header">
                        <h1 class="entry-title">The Tolls of Bridge Building: Part II, Construction</h1>                </header><!-- .entry-header -->

                <div class="meta-well">
                    <span style="margin-right:15px;" class=""><span class="fa fa-user"></span>&nbsp;&nbsp;&nbsp;<span class="author vcard"><a class="url fn n" href="https://samnicholls.net/about/">Sam Nicholls</a></span></span>

                    <span style="margin-right:15px;" class="entry-date published updated post-date"><span class="fa fa-clock-o"></span>&nbsp;&nbsp; <time class="entry-date published" datetime="2015-07-23T12:00:47+01:00">23rd July 2015</time><time class="updated" datetime="2016-01-18T12:26:04+00:00">18th January 2016</time></span>                    <span style="margin-right:15px;" class=""><span class="fa fa-comments-o"></span>&nbsp;&nbsp; <a href="https://samnicholls.net/2015/07/23/bridgebuilding-p2/#comments"><span class="dsq-postid" data-dsqidentifier="174 http://blog.ironowl.io/?p=174">One Comment</span></a></span>
                    <span class=""><span class="fa fa-folder-open"></span>&nbsp;&nbsp;&nbsp;<a href="https://samnicholls.net/category/bioinf/sanger-qc/" rel="category tag">Sanger-QC</a></span>
                </div>

                <div class="entry-content"><p><a href="/2015/07/22/bridgebuilding/">Last time</a> on Samposium, I gave a more detailed look at the project I&#8217;m working on and an overview of what has been done so far. We have <strong>870</strong> <strong>lanelets</strong> to pre-process and improve into <strong>samples</strong>. In this post, I explain how the project has turned into a dangerous construction site.</p>
<p>While trying to anticipate expected work to be done in a <a href="/2015/06/24/sanger-sequel/">previous post</a>, I wrote:</p>
<blockquote><p>I also recall having some major trouble with needing to re-align the failed samples to a different reference: these samples having failed, were not subjected to all the processing of their QC approved counterparts, which we&#8217;ll need to apply ourselves manually, presumably painstakingly.</p></blockquote>
<p>&#8216;Painstakingly&#8217; could probably be described as an understatement now. For the past few weeks I&#8217;ve spent most of my time overseeing the construction of bridges.</p>
<h2>Bridgebuilding</h2>
<h3>References</h3>
<p>Pretty much one of the first stops for genomic data spewed out of the instruments here is an alignment to a known human reference. It&#8217;s this step that allows most of our downstream analysis to happen, we can &#8220;pileup&#8221; sequenced reads where they belong along the human genome, compare them to each-other or other samples and attempt to make inferences about where variation lies and what its effects may be.</p>
<p>Without a reference &#8212; like the metagenomic work I do back in Aberystwyth &#8212; one has to turn to more complicated de novo assembly methods and look for how the reads themselves overlap and line up in respect to eachother rather than a reference.</p>
<p>Releases of the &#8220;canonical&#8221; human reference genome are managed by the <a href="http://www.ncbi.nlm.nih.gov/projects/genome/assembly/grc/">Genome Reference Consortium</a>, of which the Wellcome Trust Sanger Institute is a member. The GRC released <code>GRCh37</code> in March 2009, seemingly also known as <code>hg19</code>. It is to this reference that our data was aligned to. However, to combat some perceived issues with <code>GRCh37</code>, the 1000 Genomes Project team constructed their own derivative reference: <code>hs37d5</code>.</p>
<p>To improve accuracy and reduce mis-alignment, <code>hs37d5</code> includes additional subsequences termed &#8220;decoy sequences&#8221;. These decoys prevent reads whose true origin is not adequately represented in the reference from mapping to an arbitrarily similar looking location somewhere else in the genome. Sequences of potential bacterial or viral contaminants, such as Epstein-Barr virus which is used in immortalisation of some types of cell line are also included to prevent contaminated reads incorrectly aligning to the human genome.</p>
<p>The benefits are obvious, fewer false positives and more mapped sequence for the cost of a re-alignment? Understandably, our study decided to remap all good lanelets from <code>GRCh37</code> to <code>hs37d5</code> and re-run the sample improvement process.</p>
<h3>Recipe</h3>
<p>Of course, to execute our quality control pipeline fairly, we too must remap all of our lanelets to <code>hs37d5</code>. Luckily, Josh and his team had already conuured some software to solve this problem in the form of <a href="https://github.com/wtsi-hgi/bridgebuilder"><code>bridgebuilder</code></a> whose components and workflow are modelled in the diagram below:</p>
<p><a href="http://samnicholls.net/wp-content/uploads/2015/07/bridge_builder_v1.png"><img loading="lazy" class="alignnone size-large wp-image-280" src="http://samnicholls.net/wp-content/uploads/2015/07/bridge_builder_v1-418x1024.png" alt="bridge_builder_v1" width="418" height="1024" srcset="https://samnicholls.net/wp-content/uploads/2015/07/bridge_builder_v1-418x1024.png 418w, https://samnicholls.net/wp-content/uploads/2015/07/bridge_builder_v1-122x300.png 122w, https://samnicholls.net/wp-content/uploads/2015/07/bridge_builder_v1.png 809w" sizes="(max-width: 418px) 100vw, 418px" /></a></p>
<p><code>bridgebuilder</code> has three main components summarised thus:</p>
<ul>
<li><strong>baker</strong><br />
Responsible for the generation of the &#8220;reference bridge&#8221;, mapping the old reference to the new reference. In our case, the actual <code>GRCh37</code> reference itself is bridged to <code>hs37d5</code>. The result is metaphorically a collection of bridges representing parts of <code>GRCh37</code> and their new destination somewhere in <code>hs37d5</code>.</li>
<li><strong>binnie</strong><br />
Takes the original lanelet as aligned to the old reference and using the <code>baker</code>&#8216;s reference bridge works out whether reads can stay where they are, or whether they fall in genomic regions covered by a bridge. For each of the 870 lanelets, the result is the population of three bins:<br />
&#8212; <strong>Unbridged reads</strong><br />
Reads whose location in <code>hs37d5</code> is the same as in <code>GRCh37</code> and do not require re-mapping.<br />
&#8212; <strong>Bridged reads</strong><br />
Reads that do fall on a bridge and are mapped across from <code>GRCh37</code> to <code>hs37d5</code>.<br />
&#8212; <strong>Unmapped reads that are now mapped</strong><br />
Reads that did not have an alignment to <code>GRCh37</code> but now align to <code>hs37d5</code>.</li>
<li><strong>brunel</strong><br />
Takes the <code>binnie</code> bins as &#8220;blueprints&#8221; and merges all reads to generate the new lanelet.</li>
</ul>
<p>Whilst designed to function together and co-existing in the same package, <code>bridgebuilder</code> is not currently a <em>push button and acquire bridges</em> process. Luckily for me, back in 2014 while I was frantically finishing the write-up of my undergraduate thesis, Josh had <strong>quickly</strong> prepared a <strong>prototype</strong> <code>Makefile</code> with the purpose of orchestrating our construction project.</p>
<p>This was neat, as it accepted a file of filenames (a &#8220;fofn&#8221;) and automatically took care of each step and all of the many intermediate files inbetween. More importantly it provided a wrapper for handling submission of jobs to the compute cluster (the &#8220;farm&#8221;). The latter was especially great news for me, having spent <a href="/2015/04/27/what-am-i-doing/">most of my first year battling</a> our <a href="/2015/02/17/sun-grid-engine/">job management system</a> back in Aberystwyth.</p>
<p>In theory remapping all 870 lanelets should have been accomplished through one simple submission of <code>Make</code> to the farm. As you may have guessed by my tone, this was not the case.</p>
<h3>Ruins</h3>
<p>Shortly before calling it a day back in 2014, Josh gave the orchestrating Makefile a few shots. The results were hit and miss, a majority of the required files failed to generate and the &#8220;<em>superlog</em>&#8221; containing over a million lines aggregated <code>stdout</code> from each of the submitted jobs was a monolithic mish-mash of unnavigable segmentation faults, samtools errors, debugging and scheduling information. Repeated application of the <code>Makefile</code> superjob yielded a handful more desired files and the errors appeared to tail off, yet we were still missing several hundred of the final lanelets. Diagnosing where the errors were arising was particular problematic due to two assumptions in the albeit rushed design of our <code>Makefile</code>:</p>
<ul>
<li><strong>Error Handling</strong><br />
The <code>Makefile</code> did not expect to have to handle the potential for error between one step and the next. Many but by no means all of the errors pumped to the superlog pertained to the absence of intermediate files, rather than a problem with execution of the commands themselves.</li>
<li><strong>Error Tracing</strong><br />
There was no convenient mechanism to trace back entries from the superlog to the actual cluster job (and thus particular lanelet) to try and reproduce and investigate errors. The superlog was just a means of establishing a heartbeat on the superjob and to roughly guage progress.</li>
</ul>
<p>This is where the project left off and to where we must now return.</p>
<h3>Revisiting Wreckage</h3>
<p>As expected, given nothing had been messed around with in the project&#8217;s year long hiatus, rebooting the bridgebuilding pipeline via the <code>Makefile</code> provided similar results as before: some extra files and a heap of errors of unknown job origin. However, given there was non-trivial set of files that the pipeline marked as complete, there were less files to process overall and so many less jobs were submitted as a result, thus inspecting the superlog was somewhat easier.</p>
<p>I figured a reasonable starting point would be to see whether errors could be narrowed down by looking for cluster jobs that exited with a failed status code. Unfortunately the superlog doesn&#8217;t contain the LSF summary output for any of the spawned jobs and so I had to try and recover this myself. I pulled out job numbers with <code>grep</code> and <code>cut</code> and fed them to an LSF command that returns status information for completed jobs. I noticed a pattern and with a little grep-fu I was able to pull-out jobs that failed specifically due to resource constraints, a <a href="/2015/04/27/what-am-i-doing/">familiar problem</a>. Though in this case, the resource constraints were imposed on each job by rules in the <code>Makefile</code>, the cure was to merely be less frugal.</p>
<p>Generously doubling or tripling the requested RAM for each job step and launching the bridgebuilder pipeline created an explosion of work on the cluster and within hours we had apparently falled in to a scenario where we had a majority of the files desired.</p>
<p>But wielding a strong distrust for anything that a computer does, I was not satisfied with the progress.</p>
<h3>Reaping with <code>quickcheck</code></h3>
<p>Pretty much all of the intermediary files, as well as the final output files are &#8220;BAMs&#8221;. BAM (Binary sAM) files are compressed binary representations of SAM files that contain data pertaining to DNA sequences and alignments thereof. <code>samtools</code> is a suite of bioinformatics tools primarily designed to work with such files. After anticipated of <a href="https://github.com/samtools/samtools/issues/362"><code>samtools index</code> proved unreliable</a> for catching more subtle errors, Josh wrote a new subcommand for <code>samtools</code> called: <a href="https://github.com/samtools/samtools/pull/406"><strong><code>quickcheck</code></strong></a>.</p>
<p><code>samtools quickcheck</code> is capable of quickly checking (shocker) whether a BAM, SAM or CRAM file appears &#8220;intact&#8221;; <em>i.e.</em> the header is valid, the file contains at least one target sequence and for BAMs that the compressed end-of-file (EOF) block is present, which is elsewise a pretty good sign your BAM is truncated. I fed each of the now thousands of BAM files to <code>quickcheck</code> and hundreds of filenames began to flow up the terminal, revealing a new problem with the bridgebuilder pipeline&#8217;s <code>Makefile</code>:</p>
<ul>
<li><strong>File Creation is Success</strong><br />
The existence of a file, be it an intermediate or final output file is viewed as a success, regardless of the exit status of the job that created that file.</li>
</ul>
<p>The <code>Makefile</code> was set-up to remove files that are left broken or unfinished if a job fails, but this does not happen if the job is forcibly terminated by LSF for exceeding its time or memory allocation, which was unfortunately the case for hundreds of jobs. This rule also does not cover cases where a failure occurs but the command does not return a failing exit code, a problem that still plagues older parts of <code>samtools</code>. Thus, <code>quickchecking</code> the results is the only assuring step that can be performed.</p>
<p>Worse still, once a file existed, the next step was executed under the assumption the input intermediate file must be valid as it had not been cleaned away. Yet this step would likely fail itself due to the invalid input, it too leaving behind an invalid output file to go on to the next step, and so on.</p>
<p>As an inexpensive operation, it was simple to run <code>quickcheck</code> on every BAM file in a reasonable amount of time. Any file that failed a <code>quickcheck</code> was removed from the directory, forcing it to be regenerated anew on the next iteration of the <span style="text-decoration: line-through;">carousel</span> pipeline.</p>
<h3>Rinse and Repeat</h3>
<p>After going full-nuclear on files that upset <code>quickcheck</code>, the next iteration of the pipeline took much longer, but thankfully the superlog was quieter with respect to errors. It seemed that having increased limits on the requests for time and memory, most of the jobs were happy to go about their business successfully.</p>
<p>But why repeat what should be a deterministic process?</p>
<ul>
<li><strong>Jobs and nodes fail stochastically</strong><br />
We&#8217;re running a significant number of simultaneous jobs, all reading and writing large files to the same directory. It&#8217;s just a statistical question of <em>when</em> rather than if at least one bit goes awry, and indeed it clearly does. Repeating the process and removing any files that fail <code>quickcheck</code> allows us to ensure we&#8217;re only running the jobs where something has gone wrong.</li>
<li><strong>The <code>Makefile</code> stalls</strong><br />
Submitting a <code>Makefile</code> to a node with the intention for it to then submit jobs of its own to other nodes and keep a line of communication with each of them open, is potentially not ideal. Occasionally server blips would cause these comm lines to fail and the <code>Makefile</code> would stall waiting to hear back from its children. In this scenario the superjob would have to be killed which can leave quite a mess behind.</li>
</ul>
<p>Following a few rounds of repeated application of the pipeline and rinsing with <code>quickcheck</code>, we once again appeared in the reasonable position of having the finish line in sight. We were just around 200 lanelets off our 870 total. A handful of errors implied that some jobs wanted even more resources and due to the less monolithic nature of the superlog, a repetitive error with the final <code>brunel</code> step throwing a segmentation fault came to my attention.</p>
<p>But not being easily satisfied, I set out to find something wrong with our latest fresh batch of bridges.</p>
<h3>Clobbering with <code>sort</code></h3>
<p>After killing a set of intermediary jobs that appeared to have stalled &#8212; all sorting operations using <code>samtools sort</code> &#8212; I inspected the damage; unsurprisingly there were several invalid output file, but upon inspection of the assigned temporary directory, only a handful of files named <code>.tmp.NNNN.bam</code> (where <code>NNNN</code> is some sequential index). That&#8217;s odd&#8230; There should have been a whole host of temporary files&#8230;</p>
<p>I checked the <code>Makefile</code>, we were using <code>samtools sort</code>&#8216;s <code>-T</code> argument to provide a path to the temporary directory. Except <code>-T</code> is not supposed to be a directory path:</p>
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-64f105f4aa008949578638" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea  class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
-T PREFIX Write temporary files to PREFIX.nnnn.bam
</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-64f105f4aa008949578638-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105f4aa008949578638-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-64f105f4aa008949578638-1"><span class="crayon-o">-</span><span class="crayon-i">T</span><span class="crayon-h"> </span><span class="crayon-e">PREFIX </span><span class="crayon-e">Write </span><span class="crayon-e">temporary </span><span class="crayon-e">files </span><span class="crayon-st">to</span><span class="crayon-h"> </span><span class="crayon-v">PREFIX</span><span class="crayon-sy">.</span><span class="crayon-v">nnnn</span><span class="crayon-sy">.</span><span class="crayon-i">bam</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105f4aa008949578638-2">&nbsp;</div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0001 seconds] -->
<p></p>
<p>So, providing a directory path to <code>-T</code> sets the <code>PREFIX</code> to <code>\path\to\tmp\.NNNN.bam</code>.</p>
<p>Oh shit. Each job shared the same <code>-T</code> and must therefore have shared a <code>PREFIX</code>, this is <strong>very bad</strong>. Immediately I knocked up a quick test case on my laptop to see whether a hunch would prove correct, it did: I found a &#8220;bug&#8221; in <code>samtools sort</code>: <a href="https://github.com/samtools/samtools/issues/432"><code>samtools sort</code> clobbers temporary files if &#8220;misusing&#8221; <code>-T</code></a>.</p>
<p>Although this was caused by our mistaken use of <code>-T</code> as a path to a temporary directory not a &#8220;prefix&#8221;, the resulting behaviour is dangerous, rather unexpected and as explained in my bug report below, woefully beautiful:</p>
<blockquote>
<h4>Reproduce</h4>
<p>  Execute two sorts providing a duplicate prefix or duplicate directory path to <code>-T</code>:</p>
<h4>Result</h4>
<p>  output1.sam contains input2.sam&#8217;s header along with read groups appearing in input2.sam and potentially some from input1.sam. output2.sam is not created as the job aborts.</p>
<h4>Behaviour</h4>
<ul>
<li>Job A begins executing, creating temporary files in tmp/ with the name <code>.0000.tmp</code> to <code>.NNNN.tmp</code>.</li>
<li>Job B begins, chasing Job A, clobbering temporary files in tmp/ from <code>.0000.tmp</code> to <code>.MMMM.tmp</code>.</li>
<li>Job A completes sorting temporary files and merges <code>.0000.tmp</code> to <code>.NNNN.tmp</code>. Thus incorrectly including read groups from Job B in place of the desired read groups from Job A, where N &lt;= M.</li>
<li>Job A completes merging and deletes temporary files.</li>
<li>Job B crashes attempting to read <code>.0000.tmp</code> as it no longer exists.</li>
</ul>
</blockquote>
<p>By default, <code>samtools sort</code> starts writing temporary files to disk if it exceeds 768MB of RAM in a sorting thread. Initially, none of the sorting jobs performed by the <code>Makefile</code> were alloted more than 512MB of RAM total and thus any job on track to exceed 768MB RAM should have been killed by LSF and a temporary file would never have touched disk. When I showed up and liberally applied RAM to the affected area, sorting operations with a need for temporary files became possible and the clobbering occurred, detected only by luck.</p>
<p>What&#8217;s elegantly disconcerting about this bug is that the resulting file is valid and thus <strong>cannot be identified by <code>quickcheck</code></strong>, my only weapon against bad BAMs. A solution would be to extract the header and every readgroup that occurs in the file and look for at least one contradiction. However, due to the size of these BAMs (upwards of 5GB, containing tens of millions of alignment records) it turned out to be faster to regenerate them all, rather than trying to diagnose which specifically might have fallen prey to the bug for targeted regneration.</p>
<p>I altered the <code>Makefile</code> to use the name of the input file after the path when creating the <code>PREFIX</code> to use for temporary files in future, side-stepping the clobbering (and using <code>-T</code> as intended).</p>
<h3><code>brunel</code> and The 33</h3>
<p>Following the regeneration of any sorted file (and all files that use those sorted files thereafter), it was time to tackle the mysterious stack of segementation faults occuring at the final hurdle of the process, <code>brunel</code>. Our now rather uncluttered superlog made finding cases for reproducing simple, especially given the obvious thirty eight line backtrace and memory map spewed out after <code>brunel</code> encountered an <code>abort</code>:</p>
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-64f105f4aa011208737162" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea  class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
*** glibc detected *** /software/hgi/pkglocal/bridgebuilder-0.3.6/bin/brunel: munmap_chunk(): invalid pointer: 0x00000000022ec900 ***
[...]
/tmp/1436571537.7566550: line 8: 21818 Aborted /software/hgi/pkglocal/bridgebuilder-0.3.6/bin/brunel 8328_1#15.GRCh37-hs37d5_bb_bam_header.txt 8328_1#15_GRCh37-hs37d5_unchanged.bam:GRCh37-hs37d5.trans.txt 8328_1#15_GRCh37-hs37d5_remap.queryname_sort.map_hs37d5.fixmate.coordinate_sort.bam 8328_1#15_GRCh37-hs37d5_bridged.queryname_sort.fixmate.coordinate_sort.bam 8328_1#15.GRCh37-hs37d5_bb.bam
</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-64f105f4aa011208737162-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105f4aa011208737162-2">2</div><div class="crayon-num" data-line="crayon-64f105f4aa011208737162-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105f4aa011208737162-4">4</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-64f105f4aa011208737162-1"><span class="crayon-o">*</span><span class="crayon-o">*</span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-e">glibc </span><span class="crayon-e ">detected *</span><span class="crayon-o">*</span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-v">software</span><span class="crayon-o">/</span><span class="crayon-v">hgi</span><span class="crayon-o">/</span><span class="crayon-v">pkglocal</span><span class="crayon-o">/</span><span class="crayon-v">bridgebuilder</span><span class="crayon-o">-</span><span class="crayon-cn">0.3.6</span><span class="crayon-o">/</span><span class="crayon-v">bin</span><span class="crayon-o">/</span><span class="crayon-v">brunel</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-e">munmap_chunk</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-e">invalid </span><span class="crayon-v">pointer</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-cn">0x00000000022ec900</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-o">*</span><span class="crayon-o">*</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105f4aa011208737162-2"><span class="crayon-sy">[</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-64f105f4aa011208737162-3"><span class="crayon-o">/</span><span class="crayon-v">tmp</span><span class="crayon-o">/</span><span class="crayon-cn">1436571537.7566550</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-i">line</span><span class="crayon-h"> </span><span class="crayon-cn">8</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-cn">21818</span><span class="crayon-h"> </span><span class="crayon-v">Aborted</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-v">software</span><span class="crayon-o">/</span><span class="crayon-v">hgi</span><span class="crayon-o">/</span><span class="crayon-v">pkglocal</span><span class="crayon-o">/</span><span class="crayon-v">bridgebuilder</span><span class="crayon-o">-</span><span class="crayon-cn">0.3.6</span><span class="crayon-o">/</span><span class="crayon-v">bin</span><span class="crayon-o">/</span><span class="crayon-i">brunel</span><span class="crayon-h"> </span><span class="crayon-cn">8328_1</span><span class="crayon-p">#15.GRCh37-hs37d5_bb_bam_header.txt 8328_1#15_GRCh37-hs37d5_unchanged.bam:GRCh37-hs37d5.trans.txt 8328_1#15_GRCh37-hs37d5_remap.queryname_sort.map_hs37d5.fixmate.coordinate_sort.bam 8328_1#15_GRCh37-hs37d5_bridged.queryname_sort.fixmate.coordinate_sort.bam 8328_1#15.GRCh37-hs37d5_bb.bam</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105f4aa011208737162-4">&nbsp;</div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0004 seconds] -->
<p></p>
<p>Back with our old friend, <code>gdb</code>, I found the error seemed to occur when <code>brunel</code> attempted to free a pointer to what should have been a line of text from one of the input files:</p>
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-64f105f4aa014241738125" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea  class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
char* linepointer = NULL;
[...]
while (!feof(trans_file) &amp;&amp; !ferror(trans_file) &amp;&amp; counter &gt; 0) {
    getline(&amp;linepointer, &amp;read, trans_file);
    [...]
}
free(linepointer);
</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-64f105f4aa014241738125-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105f4aa014241738125-2">2</div><div class="crayon-num" data-line="crayon-64f105f4aa014241738125-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105f4aa014241738125-4">4</div><div class="crayon-num" data-line="crayon-64f105f4aa014241738125-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105f4aa014241738125-6">6</div><div class="crayon-num" data-line="crayon-64f105f4aa014241738125-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105f4aa014241738125-8">8</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-64f105f4aa014241738125-1"><span class="crayon-t">char</span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">linepointer</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">NULL</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105f4aa014241738125-2"><span class="crayon-sy">[</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-64f105f4aa014241738125-3"><span class="crayon-st">while</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-o">!</span><span class="crayon-e">feof</span><span class="crayon-sy">(</span><span class="crayon-v">trans_file</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&amp;&amp;</span><span class="crayon-h"> </span><span class="crayon-o">!</span><span class="crayon-e">ferror</span><span class="crayon-sy">(</span><span class="crayon-v">trans_file</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&amp;&amp;</span><span class="crayon-h"> </span><span class="crayon-v">counter</span><span class="crayon-h"> </span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105f4aa014241738125-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">getline</span><span class="crayon-sy">(</span><span class="crayon-o">&amp;</span><span class="crayon-v">linepointer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-v">read</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">trans_file</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-64f105f4aa014241738125-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">[</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105f4aa014241738125-6"><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-64f105f4aa014241738125-7"><span class="crayon-e">free</span><span class="crayon-sy">(</span><span class="crayon-v">linepointer</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105f4aa014241738125-8">&nbsp;</div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0004 seconds] -->
<p></p>
<p>Yet if <code>linepointer</code> was never assigned to, perhaps because <code>trans_file</code> was empty, <code>brunel</code> would attempt to free <code>NULL</code> and everything would catch fire and <code>abort</code>, case closed. However whilst this <em>could</em> happen, my theory was disproved with some good old-fashion print statement debugging &#8212; <code>trans_file</code> was indeed not empty and <code>linepointer</code> was in fact being used.</p>
<p>After much head-scratching, more print-debugging and commenting out various lines, I discovered all ran well if I removed the line that updates the i-th element of the translation array, <code>trans</code>. How strange? I debugged some more and uncovered a bug in <code>brunel</code>:</p>
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-64f105f4aa016257561602" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea  class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
int *trans = malloc(sizeof(int)*file_entries);

char* linepointer = NULL;
[...]
while (!feof(trans_file) &amp;&amp; !ferror(trans_file) &amp;&amp; counter &gt; 0) {
    getline(&amp;linepointer, &amp;read, trans_file);
    [...]

    // lookup tid of original and replacement
    int i = 0;
    for ( ; i &lt; file_entries; i++ ) {
      char* item = file_header-&gt;target_name[i];
      if (!strcmp(item,linepointer)) { break; }
    }
    int j = 0;
    for ( ; j &lt; replace_entries; j++ ) {
        char* item = replace_header-&gt;target_name[j];
        if (!strcmp(item,sep)) { break; }
    }
    trans[i] = j;
    counter--;
}
free(linepointer);
</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-64f105f4aa016257561602-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105f4aa016257561602-2">2</div><div class="crayon-num" data-line="crayon-64f105f4aa016257561602-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105f4aa016257561602-4">4</div><div class="crayon-num" data-line="crayon-64f105f4aa016257561602-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105f4aa016257561602-6">6</div><div class="crayon-num" data-line="crayon-64f105f4aa016257561602-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105f4aa016257561602-8">8</div><div class="crayon-num" data-line="crayon-64f105f4aa016257561602-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105f4aa016257561602-10">10</div><div class="crayon-num" data-line="crayon-64f105f4aa016257561602-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105f4aa016257561602-12">12</div><div class="crayon-num" data-line="crayon-64f105f4aa016257561602-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105f4aa016257561602-14">14</div><div class="crayon-num" data-line="crayon-64f105f4aa016257561602-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105f4aa016257561602-16">16</div><div class="crayon-num" data-line="crayon-64f105f4aa016257561602-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105f4aa016257561602-18">18</div><div class="crayon-num" data-line="crayon-64f105f4aa016257561602-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105f4aa016257561602-20">20</div><div class="crayon-num" data-line="crayon-64f105f4aa016257561602-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105f4aa016257561602-22">22</div><div class="crayon-num" data-line="crayon-64f105f4aa016257561602-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105f4aa016257561602-24">24</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-64f105f4aa016257561602-1"><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-v">trans</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">malloc</span><span class="crayon-sy">(</span><span class="crayon-e">sizeof</span><span class="crayon-sy">(</span><span class="crayon-t">int</span><span class="crayon-sy">)</span><span class="crayon-o">*</span><span class="crayon-v">file_entries</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105f4aa016257561602-2">&nbsp;</div><div class="crayon-line" id="crayon-64f105f4aa016257561602-3"><span class="crayon-t">char</span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">linepointer</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">NULL</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105f4aa016257561602-4"><span class="crayon-sy">[</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-64f105f4aa016257561602-5"><span class="crayon-st">while</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-o">!</span><span class="crayon-e">feof</span><span class="crayon-sy">(</span><span class="crayon-v">trans_file</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&amp;&amp;</span><span class="crayon-h"> </span><span class="crayon-o">!</span><span class="crayon-e">ferror</span><span class="crayon-sy">(</span><span class="crayon-v">trans_file</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&amp;&amp;</span><span class="crayon-h"> </span><span class="crayon-v">counter</span><span class="crayon-h"> </span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105f4aa016257561602-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">getline</span><span class="crayon-sy">(</span><span class="crayon-o">&amp;</span><span class="crayon-v">linepointer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-v">read</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">trans_file</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-64f105f4aa016257561602-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">[</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105f4aa016257561602-8">&nbsp;</div><div class="crayon-line" id="crayon-64f105f4aa016257561602-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// lookup tid of original and replacement</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105f4aa016257561602-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-64f105f4aa016257561602-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-h"> </span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-v">file_entries</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-o">++</span><span class="crayon-h"> </span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105f4aa016257561602-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-t">char</span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">item</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">file_header</span><span class="crayon-o">-&gt;</span><span class="crayon-v">target_name</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-sy">]</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-64f105f4aa016257561602-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-o">!</span><span class="crayon-e">strcmp</span><span class="crayon-sy">(</span><span class="crayon-v">item</span><span class="crayon-sy">,</span><span class="crayon-v">linepointer</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-h"> </span><span class="crayon-st">break</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105f4aa016257561602-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-64f105f4aa016257561602-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">j</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105f4aa016257561602-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-h"> </span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">j</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-v">replace_entries</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">j</span><span class="crayon-o">++</span><span class="crayon-h"> </span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-64f105f4aa016257561602-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-t">char</span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">item</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">replace_header</span><span class="crayon-o">-&gt;</span><span class="crayon-v">target_name</span><span class="crayon-sy">[</span><span class="crayon-v">j</span><span class="crayon-sy">]</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105f4aa016257561602-18"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-o">!</span><span class="crayon-e">strcmp</span><span class="crayon-sy">(</span><span class="crayon-v">item</span><span class="crayon-sy">,</span><span class="crayon-v">sep</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-h"> </span><span class="crayon-st">break</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-64f105f4aa016257561602-19"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105f4aa016257561602-20"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">trans</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">j</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-64f105f4aa016257561602-21"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">counter</span><span class="crayon-o">--</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105f4aa016257561602-22"><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-64f105f4aa016257561602-23"><span class="crayon-e">free</span><span class="crayon-sy">(</span><span class="crayon-v">linepointer</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105f4aa016257561602-24">&nbsp;</div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0012 seconds] -->
<p></p>
<p>Look closely. Assignments to the <code>trans</code> array rely on setting both <code>i</code> and <code>j</code> by breaking those two loops when a condition is met. However if the condition is never met, the loop counter will be equal to the loop end condition. This is particularly important for <code>i</code>, as it is used to index <code>trans</code>.</p>
<p>At a length of <code>file_entries</code>, assigning an element at the maximum bound of loop counter <code>i</code>: <code>file_entries</code>, causes <code>brunel</code> to write to memory beyond that which was allocated to the storing of <code>trans</code>, likely in to the variable that was assigned immediately afterwards&#8230; <code>linepointer</code>.</p>
<p>So it seems that <code>linepointer</code> is not <code>NULL</code>but is infact mangled with the value of <code>file_entries</code>. I <a href="https://github.com/wtsi-hgi/bridgebuilder/pull/6">added a quick patch</a> that checked whether <code>i &amp;lt; file_entries</code> before trying to update the <code>trans</code> array and all was well.</p>
<p>Yet, curiosity got the better of me, only a small subset (33/870) files were throwing an <code>abort</code> at this <code>brunel</code> step, why not all of them? What&#8217;s more, after some grepping over our old pipeline logs, the same 33 lanelets each time too. Weird.</p>
<p>Clearly they all shared some property. The lanelet inputs were definitely valid and a brief manual inspection of the headers and scroll through the body showed nothing glaringly out of place. Focussing back on the function of <code>brunel</code> and the nature of this error: the <code>i</code> loop not encountering a <code>break</code> because the exit condition is not met, gives us a good place to start.</p>
<p>These loops in <code>brunel</code> are designed to &#8220;translate&#8221; the sequence identifiers from the old reference, to that of the new reference. For example: the label for the first chromosome in GRCh37 is &#8220;Chr1&#8221; but in hs37d5, it&#8217;s known simply as &#8220;1&#8221;. It&#8217;s obviously important these match up and ensuring that is in the purpose of the <code>build_translation_file</code> function. This mapping is defined by a text file that is also passed to <code>brunel</code> at invocation. If there is a valid mapping to be made, the loops meet their conditions and when <code>trans[i] = j</code>: <code>i</code> refers to the SQ line in the header to be translated and <code>j</code> refers to the new SQ line in the new file that will contain all the reads. Lovely.</p>
<p>What about when there are no valid mappings to be made? Under what conditions could this even happen? The <code>i</code>-loop would never meet its break condition if a chromosome to be translated (as listed in the translation text file) was never seen in the first place. <em>i.e.</em> There were no sequence identifiers using the GRCh37 syntax. A sprinkling of debugging print statements confirmed no translations ever occurred, and <code>trans[i] = file_entries</code> was always the result for each iteration through the translation file&#8230;</p>
<p>I opened the headers for one of &#8220;the 33&#8221; lanelets again and confusingly, it was already mapped to hs37d5.</p>
<p>Turns out, these 33 lanelets were from a later phase of the study from which they originated and thus had already been mapped to hs37d5 as part of that phase&#8217;s pipeline. We&#8217;d been trying to forcibly remap them to the same reference they were already mapped to.</p>
<p>The solution was simple, remove the lanelet identifiers for &#8220;the 33&#8221; from our pipeline and pull the raw lanelets (as they&#8217;ve already been mapped to hs37d5) from the database later. We now had <em>just</em> <strong>837 lanelets</strong> to care for.</p>
<h3>The 177</h3>
<p>That should have been the end of things, the 837 lanelets we needed to worry about had made their way through the entire pipeline from start to finish and we had <strong>837 bridged BAMs</strong>. But, with my paranoia getting out of hand (and given the events so far, perhaps it was now justified), I collected the file sizes for each class of intermediate file and calculated summary statistics.</p>
<p>Unsurprisingly, I found an anomaly. For one class of file, BAM files that were supposed to contain all reads that <code>binnie</code> determined as requiring re-alignment as they fell on a bridge: a high standard deviation and rather postively skewed looking set of quartiles. Looking at the files in question, 387 had a size of <code>177</code> bytes. Opening just one with <code>samtools view -h</code> drew a deep but unexpected sigh:</p>
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-64f105f4aa019721162317" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea  class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
@SQ SN:MT LN:16569
@SQ SN:NC_007605 LN:171823
@SQ SN:hs37d5 LN:35477943
@PG ID:bwa PN:bwa VN:0.5.9-r16
</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-64f105f4aa019721162317-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105f4aa019721162317-2">2</div><div class="crayon-num" data-line="crayon-64f105f4aa019721162317-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105f4aa019721162317-4">4</div><div class="crayon-num" data-line="crayon-64f105f4aa019721162317-5">5</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-64f105f4aa019721162317-1"><span class="crayon-sy">@</span><span class="crayon-e">SQ </span><span class="crayon-v">SN</span><span class="crayon-o">:</span><span class="crayon-e">MT </span><span class="crayon-v">LN</span><span class="crayon-o">:</span><span class="crayon-cn">16569</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105f4aa019721162317-2"><span class="crayon-sy">@</span><span class="crayon-e">SQ </span><span class="crayon-v">SN</span><span class="crayon-o">:</span><span class="crayon-e">NC_007605 </span><span class="crayon-v">LN</span><span class="crayon-o">:</span><span class="crayon-cn">171823</span></div><div class="crayon-line" id="crayon-64f105f4aa019721162317-3"><span class="crayon-sy">@</span><span class="crayon-e">SQ </span><span class="crayon-v">SN</span><span class="crayon-o">:</span><span class="crayon-e">hs37d5 </span><span class="crayon-v">LN</span><span class="crayon-o">:</span><span class="crayon-cn">35477943</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105f4aa019721162317-4"><span class="crayon-sy">@</span><span class="crayon-e">PG </span><span class="crayon-v">ID</span><span class="crayon-o">:</span><span class="crayon-e">bwa </span><span class="crayon-v">PN</span><span class="crayon-o">:</span><span class="crayon-e">bwa </span><span class="crayon-v">VN</span><span class="crayon-o">:</span><span class="crayon-cn">0.5.9</span><span class="crayon-o">-</span><span class="crayon-i">r16</span></div><div class="crayon-line" id="crayon-64f105f4aa019721162317-5">&nbsp;</div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0002 seconds] -->
<p></p>
<p>Empty other than a modest header. Damn. Damn damn damn. I went for a walk.</p>
<p>The LSF records didn&#8217;t reach far back enough to let me find out how this might have happened, September 2014 was millions of jobs ago. The important thing is that this problem didn&#8217;t seem to be happening to newer jobs that had generated this particular class of file more recently.</p>
<p>Why was this still causing trouble now? Remember: <strong>File Creation is Success</strong>!</p>
<p>The solution was to nuke these &#8220;has_177&#8221; files and let the <code>Makefile</code> take careof the rest.</p>
<h3><em>The Class of 2014</em></h3>
<p>Once that was complete, we had a healthier looking set of 837 lanelets and your average &#8220;bridged&#8221; BAM looked bigger too, which is good news. Ultra paranoid, despite the results now passing <code>quickcheck</code>, I decided to regenerate a small subset of the 450 non-177 lanelets from scratch and compare the size and <code>md5</code> of the resulting files to the originals.</p>
<p>They were different.</p>
<p>The culprit this time? Indexes built by <code>bwa</code> that were generated in 2014 were much smaller than their 2015 counterparts. In a bid to not keep repeating the past, I nuked any intermediate file that was not from that week and let the <code>Makefile</code> regenerate the gaps and final outputs.</p>
<p>All now seemed well.</p>
<p><a name="finalchecks"></a></p>
<h3>Final Checks</h3>
<p>Not content with finally reaching this point, I tried to rigorously prove the data was ready for the sample improvement step via <code>vr-pipe</code>:</p>
<ul>
<li><strong><code>quickcheck</code></strong><br />
Ensure the EOF block was present and intact.</li>
<li><strong><code>bsub -e</code></strong><br />
Checked that none of the submissions had actually reported an error to LSF during execution.</li>
<li><strong><code>bsub -d UNKN</code></strong><br />
Ensured that submissions did not spend any time during execution in an &#8220;UNKNOWN&#8221; state, an indicator of the job stalling and likely producing bad output.</li>
<li><strong><code>samtools view -c</code></strong><br />
Used the counting argument of <code>samtools view</code> to confirm the number of reads in the final bridged BAM matched the number of reads in the input lanelet. Using <code>samtools view</code> to count records in the entire file will also catch issues with truncation or corruption (albeit in a time consuming fashion).</li>
<li><strong><code>gzip -tf</code></strong><br />
Ensure the compression of each block in the BAM was correct.</li>
</ul>
<p>Now equipped with 870 lanelets that passed these checks, it was time to <a href="http://blog.ironowl.io/2015/07/31/bridgebuilding-p3/">attempt BAM improvement</a>.</p>
<hr />
<h1>tl;dr</h1>
<ul>
<li>Finally completed the <code>bridgebuilding</code> process that made this project impossible last year.</li>
<li>When files are <em>huge</em>, it is probably faster to simply regenerate data that is suspected broken, than to diagnose and triage what may or may not be invalid.</li>
<li>LSF is almost as bad as Sun Grid Engine.</li>
<li><a href="https://github.com/samtools/samtools/issues/432"><code>samtools sort</code> clobbers temporary files if &#8220;misusing&#8221; <code>-T</code></a>.</li>
<li><a href="https://github.com/wtsi-hgi/bridgebuilder/issues/5">Brunel translation writes beyond <code>trans</code> and mangles <code>linepointer</code></a></li>
</ul>
</div>
                
                        <div class="tag-well"><span><span class="fa fa-tags"></span>&nbsp;&nbsp; <a href="https://samnicholls.net/tag/bridgebuilder/" rel="tag">bridgebuilder</a>,&nbsp; <a href="https://samnicholls.net/tag/quality-control/" rel="tag">quality control</a>,&nbsp; <a href="https://samnicholls.net/tag/reference/" rel="tag">reference</a>,&nbsp; <a href="https://samnicholls.net/tag/remapping/" rel="tag">remapping</a>,&nbsp; <a href="https://samnicholls.net/tag/sanger/" rel="tag">sanger</a></span></div>
                
                <nav class="further-reading">
	<div class="previous">
		<span>Previous Post</span>
		<a href="https://samnicholls.net/2015/07/22/bridgebuilding/">The Tolls of Bridge Building: Part I, Background</a>
	</div>
	<div class="next">
		<span>Next Post</span>
		<a href="https://samnicholls.net/2015/07/31/bridgebuilding-p3/">The Tolls of Bridge Building: Part III, Sample (Un)Improvement</a>
	</div>
</nav>            </article>
                                <div class="card">

<div id="disqus_thread"></div>
                </div>
    
</section>

        <!-- Sidebar -->
        <aside class="col-md-4 sidebar-container">
		            <div id="widget-area" class="widget-area" role="complementary">
                <div id="custom_html-3" class="widget_text card widget widget_custom_html"><div class="textwidget custom-html-widget"><img src="https://pbs.twimg.com/profile_images/1044255545610436609/wt33ZbtU_400x400.jpg" height=120 style="margin-top: 20px; margin-right:10px; float: left;" alt="Sam Nicholls" />
<div style="padding-top:15px; line-height: normal"><b style="font-size: 1.2em">Sam Nicholls</b><br><span style="font-size: 0.9em;">Haplotype Wrangler at University of Birmingham.<br>I tell computers to do things, then I write about how it all went wrong.</span></div></div></div><div id="search-2" class="card widget widget_search"><form style="margin-top:15px" action="https://samnicholls.net/" id="searchform" method="get" role="form">
    <div class="form-group">
        <input type="text" class="form-control" name="s" id="s" placeholder="e.g. Search...">
    </div>
</form>
</div><div id="twitter_timeline-5" class="card widget widget_twitter_timeline"><a class="twitter-timeline" data-height="400" data-theme="light" data-link-color="#f96e5b" data-border-color="#e8e8e8" data-lang="EN" data-partner="jetpack" data-chrome="noheader nofooter noborders" href="https://twitter.com/samstudio8">My Tweets</a></div><div id="categories-5" class="card widget widget_categories"><h2>Categories</h2>
			<ul>
					<li class="cat-item cat-item-2"><a href="https://samnicholls.net/category/bioinf/">Bioinformatics</a>
<ul class='children'>
	<li class="cat-item cat-item-8"><a href="https://samnicholls.net/category/bioinf/au-phd/">AU-PhD</a>
</li>
	<li class="cat-item cat-item-3"><a href="https://samnicholls.net/category/bioinf/sanger-qc/" title="Sanger QC Project">Sanger-QC</a>
</li>
	<li class="cat-item cat-item-61"><a href="https://samnicholls.net/category/bioinf/tools/">Tools</a>
	<ul class='children'>
	<li class="cat-item cat-item-185"><a href="https://samnicholls.net/category/bioinf/tools/chitin/">chitin</a>
</li>
	</ul>
</li>
</ul>
</li>
	<li class="cat-item cat-item-80"><a href="https://samnicholls.net/category/devops/">Devops</a>
</li>
	<li class="cat-item cat-item-114"><a href="https://samnicholls.net/category/event/">Event</a>
</li>
	<li class="cat-item cat-item-21"><a href="https://samnicholls.net/category/gadgets/">Gadgets</a>
</li>
	<li class="cat-item cat-item-176"><a href="https://samnicholls.net/category/hardware/">Hardware</a>
<ul class='children'>
	<li class="cat-item cat-item-223"><a href="https://samnicholls.net/category/hardware/beehive-monitor/">Beehive Monitor</a>
</li>
	<li class="cat-item cat-item-178"><a href="https://samnicholls.net/category/hardware/esp8266/">ESP8266</a>
</li>
	<li class="cat-item cat-item-236"><a href="https://samnicholls.net/category/hardware/lego-sequencer/">Lego Sequencer</a>
</li>
	<li class="cat-item cat-item-177"><a href="https://samnicholls.net/category/hardware/lightstick/">Lightstick</a>
</li>
</ul>
</li>
	<li class="cat-item cat-item-151"><a href="https://samnicholls.net/category/lab/">Lab</a>
<ul class='children'>
	<li class="cat-item cat-item-150"><a href="https://samnicholls.net/category/lab/protocol-guides/">Protocol Guides</a>
</li>
</ul>
</li>
	<li class="cat-item cat-item-5"><a href="https://samnicholls.net/category/meta/">Meta</a>
</li>
	<li class="cat-item cat-item-62"><a href="https://samnicholls.net/category/mysteries/">Mysteries</a>
</li>
	<li class="cat-item cat-item-22"><a href="https://samnicholls.net/category/personal/">Personal</a>
</li>
	<li class="cat-item cat-item-4"><a href="https://samnicholls.net/category/photo/">Photography</a>
</li>
	<li class="cat-item cat-item-143"><a href="https://samnicholls.net/category/programming/">Programming</a>
<ul class='children'>
	<li class="cat-item cat-item-145"><a href="https://samnicholls.net/category/programming/documentation/">Documentation</a>
</li>
	<li class="cat-item cat-item-144"><a href="https://samnicholls.net/category/programming/python/">Python</a>
</li>
</ul>
</li>
	<li class="cat-item cat-item-48"><a href="https://samnicholls.net/category/status-report/">Status Report</a>
</li>
	<li class="cat-item cat-item-60"><a href="https://samnicholls.net/category/sysadm/">System Administration</a>
</li>
	<li class="cat-item cat-item-1"><a href="https://samnicholls.net/category/uncategorised/">Uncategorised</a>
</li>
			</ul>

			</div>            </div>
		        </aside>
    </div>

</div> <!-- /container -->

<footer id="main-footer" class="bg-primary">
	<div id="footer-widgets" class="container">
		    </div>
</footer>



	<div style="display:none">
	</div>
<script type='text/javascript' src='https://samnicholls.net/wp-includes/js/comment-reply.min.js?ver=5.7.5' id='comment-reply-js'></script>
<script type='text/javascript' id='disqus_count-js-extra'>
/* <![CDATA[ */
var countVars = {"disqusShortname":"samposium-blog"};
/* ]]> */
</script>
<script type='text/javascript' src='https://samnicholls.net/wp-content/plugins/disqus-comment-system/public/js/comment_count.js?ver=3.0.17' id='disqus_count-js'></script>
<script type='text/javascript' id='disqus_embed-js-extra'>
/* <![CDATA[ */
var embedVars = {"disqusConfig":{"integration":"wordpress 3.0.17"},"disqusIdentifier":"174 http:\/\/blog.ironowl.io\/?p=174","disqusShortname":"samposium-blog","disqusTitle":"The Tolls of Bridge Building: Part II, Construction","disqusUrl":"https:\/\/samnicholls.net\/2015\/07\/23\/bridgebuilding-p2\/","postId":"174"};
/* ]]> */
</script>
<script type='text/javascript' src='https://samnicholls.net/wp-content/plugins/disqus-comment-system/public/js/comment_embed.js?ver=3.0.17' id='disqus_embed-js'></script>
<script type='text/javascript' src='https://s0.wp.com/wp-content/js/devicepx-jetpack.js?ver=202335' id='devicepx-js'></script>
<script type='text/javascript' src='https://samnicholls.net/wp-content/plugins/jetpack/_inc/twitter-timeline.js?ver=4.0.0' id='jetpack-twitter-timeline-js'></script>
<script type='text/javascript' src='https://samnicholls.net/wp-includes/js/wp-embed.min.js?ver=5.7.5' id='wp-embed-js'></script>
<script type='text/javascript' src='https://stats.wp.com/e-202335.js' async defer></script>
<script type='text/javascript'>
	_stq = window._stq || [];
	_stq.push([ 'view', {v:'ext',j:'1:4.9',blog:'101350222',post:'174',tz:'1',srv:'samnicholls.net'} ]);
	_stq.push([ 'clickTrackerInit', '101350222', '174' ]);
</script>

<script type="text/javascript">
(function() {
  if (navigator.userAgent.match(/IEMobile\/10\.0/)) {
    var msViewportStyle = document.createElement("style");
    msViewportStyle.appendChild(
      document.createTextNode("@-ms-viewport{width:auto!important}")
    );
    document.getElementsByTagName("head")[0].appendChild(msViewportStyle);
  }
})();

var collapsed = false;
jQuery( document ).ready(function($) {
    $('.navbar-toggle').click(function(){
        console.log(collapsed);
        if(collapsed) {
            $('.navbar-header > button').html('<i class="fa fa-bars"></i>');
        } else {
            $('.navbar-header > button').html('<i class="fa fa-times"></i>');
        }
        $('.navbar-collapse').toggle(200);
        collapsed = !collapsed;
    });
});
</script>
	
</body>

</html>
