<!DOCTYPE html>
<html lang="en-GB">

<head>
	<meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="pingback" href="https://samnicholls.net/xmlrpc.php">

	
	<title>The Tolls of Bridge Building: Part III, Sample (Un)Improvement &#8211; Samposium</title>
<meta name='robots' content='max-image-preview:large' />
<link rel='dns-prefetch' href='//s0.wp.com' />
<link rel='dns-prefetch' href='//fonts.googleapis.com' />
<link rel='dns-prefetch' href='//s.w.org' />
<link rel="alternate" type="application/rss+xml" title="Samposium &raquo; Feed" href="https://samnicholls.net/feed/" />
<link rel="alternate" type="application/rss+xml" title="Samposium &raquo; Comments Feed" href="https://samnicholls.net/comments/feed/" />
<link rel="alternate" type="application/rss+xml" title="Samposium &raquo; The Tolls of Bridge Building: Part III, Sample (Un)Improvement Comments Feed" href="https://samnicholls.net/2015/07/31/bridgebuilding-p3/feed/" />
		<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/13.0.1\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/13.0.1\/svg\/","svgExt":".svg","source":{"concatemoji":"https:\/\/samnicholls.net\/wp-includes\/js\/wp-emoji-release.min.js?ver=5.7.5"}};
			!function(e,a,t){var n,r,o,i=a.createElement("canvas"),p=i.getContext&&i.getContext("2d");function s(e,t){var a=String.fromCharCode;p.clearRect(0,0,i.width,i.height),p.fillText(a.apply(this,e),0,0);e=i.toDataURL();return p.clearRect(0,0,i.width,i.height),p.fillText(a.apply(this,t),0,0),e===i.toDataURL()}function c(e){var t=a.createElement("script");t.src=e,t.defer=t.type="text/javascript",a.getElementsByTagName("head")[0].appendChild(t)}for(o=Array("flag","emoji"),t.supports={everything:!0,everythingExceptFlag:!0},r=0;r<o.length;r++)t.supports[o[r]]=function(e){if(!p||!p.fillText)return!1;switch(p.textBaseline="top",p.font="600 32px Arial",e){case"flag":return s([127987,65039,8205,9895,65039],[127987,65039,8203,9895,65039])?!1:!s([55356,56826,55356,56819],[55356,56826,8203,55356,56819])&&!s([55356,57332,56128,56423,56128,56418,56128,56421,56128,56430,56128,56423,56128,56447],[55356,57332,8203,56128,56423,8203,56128,56418,8203,56128,56421,8203,56128,56430,8203,56128,56423,8203,56128,56447]);case"emoji":return!s([55357,56424,8205,55356,57212],[55357,56424,8203,55356,57212])}return!1}(o[r]),t.supports.everything=t.supports.everything&&t.supports[o[r]],"flag"!==o[r]&&(t.supports.everythingExceptFlag=t.supports.everythingExceptFlag&&t.supports[o[r]]);t.supports.everythingExceptFlag=t.supports.everythingExceptFlag&&!t.supports.flag,t.DOMReady=!1,t.readyCallback=function(){t.DOMReady=!0},t.supports.everything||(n=function(){t.readyCallback()},a.addEventListener?(a.addEventListener("DOMContentLoaded",n,!1),e.addEventListener("load",n,!1)):(e.attachEvent("onload",n),a.attachEvent("onreadystatechange",function(){"complete"===a.readyState&&t.readyCallback()})),(n=t.source||{}).concatemoji?c(n.concatemoji):n.wpemoji&&n.twemoji&&(c(n.twemoji),c(n.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
	<link rel='stylesheet' id='crayon-css'  href='https://samnicholls.net/wp-content/plugins/crayon-syntax-highlighter/css/min/crayon.min.css?ver=_2.7.2_beta' type='text/css' media='all' />
<link rel='stylesheet' id='crayon-theme-github-css'  href='https://samnicholls.net/wp-content/plugins/crayon-syntax-highlighter/themes/github/github.css?ver=_2.7.2_beta' type='text/css' media='all' />
<link rel='stylesheet' id='crayon-font-monaco-css'  href='https://samnicholls.net/wp-content/plugins/crayon-syntax-highlighter/fonts/monaco.css?ver=_2.7.2_beta' type='text/css' media='all' />
<link rel='stylesheet' id='wp-block-library-css'  href='https://samnicholls.net/wp-includes/css/dist/block-library/style.min.css?ver=5.7.5' type='text/css' media='all' />
<link rel='stylesheet' id='css-style-css'  href='https://samnicholls.net/wp-content/themes/responsive-deluxe/css/style.css?ver=5.7.5' type='text/css' media='all' />
<link rel='stylesheet' id='child-style-css'  href='https://samnicholls.net/wp-content/themes/responsive-deluxe-child/style.css?ver=5.7.5' type='text/css' media='all' />
<link rel='stylesheet' id='lato-css'  href='//fonts.googleapis.com/css?family=Lato%3A400%2C700%2C400italic&#038;ver=5.7.5' type='text/css' media='all' />
<link rel='stylesheet' id='slabo-css'  href='//fonts.googleapis.com/css?family=Slabo+27px&#038;ver=5.7.5' type='text/css' media='all' />
<link rel='stylesheet' id='fa-css'  href='https://samnicholls.net/wp-content/themes/responsive-deluxe/css/font-awesome.css?ver=5.7.5' type='text/css' media='all' />
<link rel='stylesheet' id='rd-style-css'  href='https://samnicholls.net/wp-content/themes/responsive-deluxe-child/style.css?ver=5.7.5' type='text/css' media='all' />
<link rel='stylesheet' id='css-custom-css'  href='https://samnicholls.net/wp-content/themes/responsive-deluxe/css/custom.css?ver=5.7.5' type='text/css' media='all' />
<link rel='stylesheet' id='jetpack_css-css'  href='https://samnicholls.net/wp-content/plugins/jetpack/css/jetpack.css?ver=4.9' type='text/css' media='all' />
<script type='text/javascript' src='https://samnicholls.net/wp-includes/js/jquery/jquery.min.js?ver=3.5.1' id='jquery-core-js'></script>
<script type='text/javascript' src='https://samnicholls.net/wp-includes/js/jquery/jquery-migrate.min.js?ver=3.3.2' id='jquery-migrate-js'></script>
<script type='text/javascript' id='crayon_js-js-extra'>
/* <![CDATA[ */
var CrayonSyntaxSettings = {"version":"_2.7.2_beta","is_admin":"0","ajaxurl":"https:\/\/samnicholls.net\/wp-admin\/admin-ajax.php","prefix":"crayon-","setting":"crayon-setting","selected":"crayon-setting-selected","changed":"crayon-setting-changed","special":"crayon-setting-special","orig_value":"data-orig-value","debug":""};
var CrayonSyntaxStrings = {"copy":"Press %s to Copy, %s to Paste","minimize":"Click To Expand Code"};
/* ]]> */
</script>
<script type='text/javascript' src='https://samnicholls.net/wp-content/plugins/crayon-syntax-highlighter/js/min/crayon.min.js?ver=_2.7.2_beta' id='crayon_js-js'></script>
<script type='text/javascript' src='https://samnicholls.net/wp-content/plugins/fd-footnotes/fdfootnotes.js?ver=1.34' id='fdfootnote_script-js'></script>
<script type='text/javascript' src='https://samnicholls.net/wp-content/themes/responsive-deluxe/js/bootstrap.js?ver=5.7.5' id='bootstrap-js'></script>
<script type='text/javascript' src='https://samnicholls.net/wp-content/themes/responsive-deluxe/js/custom.js?ver=5.7.5' id='js-custom-js'></script>
<link rel="https://api.w.org/" href="https://samnicholls.net/wp-json/" /><link rel="alternate" type="application/json" href="https://samnicholls.net/wp-json/wp/v2/posts/165" /><link rel="EditURI" type="application/rsd+xml" title="RSD" href="https://samnicholls.net/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="https://samnicholls.net/wp-includes/wlwmanifest.xml" /> 
<meta name="generator" content="WordPress 5.7.5" />
<link rel="canonical" href="https://samnicholls.net/2015/07/31/bridgebuilding-p3/" />
<link rel='shortlink' href='https://wp.me/p6RfP0-2F' />
<link rel="alternate" type="application/json+oembed" href="https://samnicholls.net/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fsamnicholls.net%2F2015%2F07%2F31%2Fbridgebuilding-p3%2F" />
<link rel="alternate" type="text/xml+oembed" href="https://samnicholls.net/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fsamnicholls.net%2F2015%2F07%2F31%2Fbridgebuilding-p3%2F&#038;format=xml" />
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-62206786-1', 'auto');
  ga('send', 'pageview');

</script>


<link rel='dns-prefetch' href='//v0.wordpress.com'>
<style type='text/css'>img#wpstats{display:none}</style>
<!-- Jetpack Open Graph Tags -->
<meta property="og:type" content="article" />
<meta property="og:title" content="The Tolls of Bridge Building: Part III, Sample (Un)Improvement" />
<meta property="og:url" content="https://samnicholls.net/2015/07/31/bridgebuilding-p3/" />
<meta property="og:description" content="Previously, on Samposium: I finally had the 870 lanelets required for the sample improvement process. But in this post, I explain how my deep-seated paranoia in the quality of my data just wasn&amp;#82â€¦" />
<meta property="article:published_time" content="2015-07-31T11:00:53+00:00" />
<meta property="article:modified_time" content="2016-01-13T00:10:00+00:00" />
<meta property="og:site_name" content="Samposium" />
<meta property="og:image" content="https://s0.wp.com/i/blank.jpg" />
<meta property="og:locale" content="en_GB" />
<meta name="twitter:card" content="summary" />
</head>

<body class="post-template-default single single-post postid-165 single-format-standard">


        
<header id="main-header">
    <nav class="navbar-default navbar-static-top navbar" role="navigation">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#rd-collapse">
                    <span class="fa fa-bars"></span>
                    <span class="sr-only screen-reader-text">Toggle navigation</span>
                </button>
                <a class="navbar-brand" href=" https://samnicholls.net/">Samposium</a>            </div>
            
            <div id="rd-collapse" class="collapse navbar-collapse">
            
            <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<html><body class="post-template-default single single-post postid-165 single-format-standard">

<div id="main-menu" class="navbar-nav nav"><ul>
<li class="page_item page-item-8"><a href="https://samnicholls.net/about/">About Me</a></li>
<li class="page_item page-item-11"><a href="https://samnicholls.net/talks/">Talks</a></li>
<li class="page_item page-item-15"><a href="https://samnicholls.net/things-i-have-learned/">Things I Have Learned</a></li>
</ul></div></body></html>
        </div>

        </div>
    </nav>
</header>

<div class="container">

    <div class="row"><!-- Content -->
<section class="col-md-8 content-container">
                          <article class="card post hentry post-165 type-post status-publish format-standard category-sanger-qc tag-bridgebuilder tag-pipeline tag-quality-control tag-sample-improvement tag-sanger" id="post-165">
                <header class="entry-header">
                        <h1 class="entry-title">The Tolls of Bridge Building: Part III, Sample (Un)Improvement</h1>                </header><!-- .entry-header -->

                <div class="meta-well">
                    <span style="margin-right:15px;" class=""><span class="fa fa-user"></span>&nbsp;&nbsp;&nbsp;<span class="author vcard"><a class="url fn n" href="https://samnicholls.net/about/">Sam Nicholls</a></span></span>

                    <span style="margin-right:15px;" class="entry-date published updated post-date"><span class="fa fa-clock-o"></span>&nbsp;&nbsp; <time class="entry-date published" datetime="2015-07-31T12:00:53+01:00">31st July 2015</time><time class="updated" datetime="2016-01-13T00:10:00+00:00">13th January 2016</time></span>                    <span style="margin-right:15px;" class=""><span class="fa fa-comments-o"></span>&nbsp;&nbsp; <a href="https://samnicholls.net/2015/07/31/bridgebuilding-p3/#comments"><span class="dsq-postid" data-dsqidentifier="165 http://blog.ironowl.io/?p=165">One Comment</span></a></span>
                    <span class=""><span class="fa fa-folder-open"></span>&nbsp;&nbsp;&nbsp;<a href="https://samnicholls.net/category/bioinf/sanger-qc/" rel="category tag">Sanger-QC</a></span>
                </div>

                <div class="entry-content"><p><a href="/2015/07/23/bridgebuilding-p2/">Previously, on Samposium</a>: I finally had the <strong>870 lanelets</strong> required for the sample improvement process. But in this post, I explain how my deep-seated paranoia in the quality of my data just wasn&#8217;t enough to prevent what happened next.</p>
<p>I submitted my 870 bridged BAMs to <code>vr-pipe</code>, happy to essentially be rid of having to deal with the data for a while. <code>vr-pipe</code> is a complex bioinformatics pipeline that in fact consists of a series of pipelines that each perform some task or another with many steps required for each. The end result is &#8220;improved sample&#8221; BAMs, though perhaps due to the nature of our inclusion of failed lanelets we should title them &#8220;unimproved sample&#8221; BAMs. Having just defeated the supposedly automated bridging process was pretty happy to not have to be doing this stuff manually and could finally get on with something else for a while&#8230; Or so I thought.</p>
<h3>A Quiet Weekend</h3>
<p>It was Friday and I was determined to leave on-time to see my family in Swansea at a reasonable hour<sup id="fnref-165-1"><a href="#fn-165-1" rel="footnote">1</a></sup>. After knocking up a quick Python script to automatically generate the metadata file <code>vr-pipe</code> requires, describing the lanelets to be submitted and what sample they should be included in the &#8220;improvement&#8221; of, I turfed the job over to Micheal who has fabled <code>mercury</code> access<sup id="fnref-165-2"><a href="#fn-165-2" rel="footnote">2</a></sup> and could set-up <code>vr-pipe</code> for me.</p>
<p>Being the sad soul that I am, I occasionally checked in on my job over the weekend via the <code>vr-pipe</code> web interface, only to be confused by the apparent lack of progress. The pipeline appeared to just be juggling jobs around various states of pending. But without <code>mercury</code> access to inspect more, I was left to merely enjoy my weekend.</p>
<p>Between trouble on the server farm and the fact that my job is not particularly high priority, the team suggested I be more patient and so I gave it a few more days before pestering Josh to take a look.</p>
<h3>Pausing for Permissions</h3>
<p>As suspected, something had indeed gone wrong. Instead of telling anybody, <code>vr-pipe</code> sat on a small mountain of errors, hoping the problem would just go away. I&#8217;ve come to understand this is expected behaviour. Delving deep in to the logs revealed the simple problem: <code>vr-pipe</code> did not have sufficient write permissions to the directory I had provided the lanelet files in, because I didn&#8217;t provide group-write access to it.</p>
<p>One <code>chmod 775 .</code> later and the pipeline burst in to life, albeit very briefly, before painting the <code>vr-pipe</code> web interface bright red. Evidently, the problem was more serious.</p>
<h3>Sorting Names and Numbers</h3>
<p>The first proper step for <code>vr-pipe</code> is creating an index of each input file with <code>samtools index</code>. Probably the most important thing to note for an index file, is that to create one, your file must be correctly sorted. Micheal checked the logs for me and found that the indexing job had failed on all but 33 (shocker) of the input files, complaining that they were all unsorted.</p>
<p>But how could this be? <code>brunel</code> requires sorted input to work, our orchestrating <code>Makefile</code> takes care of sorting files as and when needed with <code>samtools sort</code>. There must be some mistake!</p>
<p>I manually invoked <code>samtools index</code> on a handful of my previous bridged BAMs and indeed, they are unsorted. I traced back through the various intermediate files to see when the sort was damaged before finally referring to the <code>Makefile</code>. My heart sank:</p>
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-64f105f4c7672115545950" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-mixed-highlight" title="Contains Mixed Languages"></span><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea  class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
[...]
# sort by queryname
%.queryname_sort.bam: LSF_MEM=10000
%.queryname_sort.bam: LSF_CPU=4
%.queryname_sort.bam: %.bam
${SAMTOOLS_BIN} sort -@ ${LSF_CPU} -n -T ${TMP_DIR}$(word 1,$+) -O bam -o $@ $&lt;

# sort by coordinate position
%.coordinate_sort.bam: LSF_MEM=10000
%.coordinate_sort.bam: LSF_CPU=4
%.coordinate_sort.bam: %.bam
${SAMTOOLS_BIN} sort -@ ${LSF_CPU} -n -T ${TMP_DIR}$(word 1,$+) -O bam -o $@ $&lt;
[...]
</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-64f105f4c7672115545950-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105f4c7672115545950-2">2</div><div class="crayon-num" data-line="crayon-64f105f4c7672115545950-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105f4c7672115545950-4">4</div><div class="crayon-num" data-line="crayon-64f105f4c7672115545950-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105f4c7672115545950-6">6</div><div class="crayon-num" data-line="crayon-64f105f4c7672115545950-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105f4c7672115545950-8">8</div><div class="crayon-num" data-line="crayon-64f105f4c7672115545950-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105f4c7672115545950-10">10</div><div class="crayon-num" data-line="crayon-64f105f4c7672115545950-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105f4c7672115545950-12">12</div><div class="crayon-num" data-line="crayon-64f105f4c7672115545950-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105f4c7672115545950-14">14</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-64f105f4c7672115545950-1"><span class="crayon-sy">[</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105f4c7672115545950-2"><span class="crayon-p"># sort by queryname</span></div><div class="crayon-line" id="crayon-64f105f4c7672115545950-3"><span class="crayon-ta">%</span><span class="crayon-sy">.</span><span class="crayon-v">queryname_sort</span><span class="crayon-sy">.</span><span class="crayon-v">bam</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">LSF_MEM</span><span class="crayon-o">=</span><span class="crayon-cn">10000</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105f4c7672115545950-4"><span class="crayon-ta">%</span><span class="crayon-sy">.</span><span class="crayon-v">queryname_sort</span><span class="crayon-sy">.</span><span class="crayon-v">bam</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">LSF_CPU</span><span class="crayon-o">=</span><span class="crayon-cn">4</span></div><div class="crayon-line" id="crayon-64f105f4c7672115545950-5"><span class="crayon-ta">%</span><span class="crayon-sy">.</span><span class="crayon-v">queryname_sort</span><span class="crayon-sy">.</span><span class="crayon-v">bam</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-sy">.</span><span class="crayon-i">bam</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105f4c7672115545950-6"><span class="crayon-sy">$</span><span class="crayon-sy">{</span><span class="crayon-v">SAMTOOLS_BIN</span><span class="crayon-sy">}</span><span class="crayon-h"> </span><span class="crayon-e">sort</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-sy">@</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-sy">{</span><span class="crayon-v">LSF_CPU</span><span class="crayon-sy">}</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-e">n</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-e">T</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-sy">{</span><span class="crayon-v">TMP_DIR</span><span class="crayon-sy">}</span><span class="crayon-sy">$</span><span class="crayon-sy">(</span><span class="crayon-t">word</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-sy">$</span><span class="crayon-o">+</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-e">O</span><span class="crayon-h"> </span><span class="crayon-e">bam</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-e">o</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-sy">@</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-o">&lt;</span></div><div class="crayon-line" id="crayon-64f105f4c7672115545950-7">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-64f105f4c7672115545950-8"><span class="crayon-p"># sort by coordinate position</span></div><div class="crayon-line" id="crayon-64f105f4c7672115545950-9"><span class="crayon-ta">%</span><span class="crayon-sy">.</span><span class="crayon-v">coordinate_sort</span><span class="crayon-sy">.</span><span class="crayon-v">bam</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">LSF_MEM</span><span class="crayon-o">=</span><span class="crayon-cn">10000</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105f4c7672115545950-10"><span class="crayon-ta">%</span><span class="crayon-sy">.</span><span class="crayon-v">coordinate_sort</span><span class="crayon-sy">.</span><span class="crayon-v">bam</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">LSF_CPU</span><span class="crayon-o">=</span><span class="crayon-cn">4</span></div><div class="crayon-line" id="crayon-64f105f4c7672115545950-11"><span class="crayon-ta">%</span><span class="crayon-sy">.</span><span class="crayon-v">coordinate_sort</span><span class="crayon-sy">.</span><span class="crayon-v">bam</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-sy">.</span><span class="crayon-i">bam</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105f4c7672115545950-12"><span class="crayon-sy">$</span><span class="crayon-sy">{</span><span class="crayon-v">SAMTOOLS_BIN</span><span class="crayon-sy">}</span><span class="crayon-h"> </span><span class="crayon-e">sort</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-sy">@</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-sy">{</span><span class="crayon-v">LSF_CPU</span><span class="crayon-sy">}</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-e">n</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-e">T</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-sy">{</span><span class="crayon-v">TMP_DIR</span><span class="crayon-sy">}</span><span class="crayon-sy">$</span><span class="crayon-sy">(</span><span class="crayon-t">word</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-sy">$</span><span class="crayon-o">+</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">O</span><span class="crayon-h"> </span><span class="crayon-v">bam</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">o</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-sy">@</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-o">&lt;</span></div><div class="crayon-line" id="crayon-64f105f4c7672115545950-13"><span class="crayon-sy">[</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105f4c7672115545950-14">&nbsp;</div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0038 seconds] -->
<p></p>
<p><code>samtools sort</code> accepts an <code>-n</code> flag, to sort by query name, rather than the default co-ordinate position (<em>i.e.</em> chromosome and base position on the reference sequence). Yet <em>somehow</em> the <code>Makefile</code> had been configured to use query name sorting for both. I knew I was the last one to edit this part of the file, as I&#8217;d altered the <code>-T</code> argument to prevent the temporary file clobbering discovered in the <a href="/2015/07/23/bridgebuilding-p2/">last episode</a>.</p>
<p>Had I been lazy and naughty and copied the line from one stanza to the next? I was sure I hadn&#8217;t. But the knowing-grin Josh shot at me when I showed him the file, had me determined to try and prove my innocence. Although, it should be first noted that a spot in a special part of hell must be first reserved for the both of us, as the <code>Makefile</code> was not under version control.</p>
<p>I&#8217;d squirrelled away many of the original files from 2014, including the intermediates and selecting any co-ordinate sorted file yielded a set of query name sorted reads. My name was cleared! Of course, whilst this was apparently Josh&#8217;s mistake, it&#8217;s not entirely fair to point the finger given I never noticed the bug despite spending more time nosing around the <code>Makefile</code> than anyone else. As mentioned, I&#8217;d even obliviously edited right next to the extraneous <code>-n</code> in question.</p>
<p>But I am compelled to point the finger elsewhere: <code>brunel</code> <strong>requires</strong> sorted inputs to work correctly, else it creates files that clearly can&#8217;t be used in the sample (un)improvement pipeline! How was this allowed to happen?</p>
<p>Sadly, it&#8217;s a matter of design. <code>brunel</code> never anticipated that somebody might attempt to provide incorrect input and just gets on with its job regardless. Frustratingly, had this been a feature of <code>brunel</code>, we&#8217;d have caught this problem a year ago on the first run of the pipeline.</p>
<p>The co-ordinate sorting step does at least immediately precede invocation of <code>brunel</code>, which is relatively fast. So after correcting the Makefile, nuking the incorrectly sorted BAMs and restarting the pipeline, it wasn&#8217;t a long wait before I was ready to hassle somebody with <code>mercury</code> access to push the button.</p>
<p><a name="translations"></a></p>
<h3>Untranslated Translations</h3>
<p>Before blindly resubmitting everything, I figured I&#8217;d save some time and face by adding <code>samtools index</code> to the rest of my checking procedures, to be sure that this first indexing step would at least work on <code>vr-pipe</code>.</p>
<p>The indexing still failed. The final lanelet bridged BAMs were still unsorted.</p>
<p>Despite feeding our now correctly co-ordinate sorted inputs to <code>brunel</code>, we still get an incorrectly sorted output &#8212; clearly a faux pas with <code>brunel</code>&#8216;s handling of the inputs. Taking just one of the 837 failed lanelets (all but the already mapped 33 lanelets failed to index) under my wing, I ran <code>brunel</code> manually to try and diagnose the problem.</p>
<p>The error is a little different from the last run, whereas before <code>samtools index</code> complained about co-ordinates appearing out of order, this time, chromosomes appear non-continuously. Unfortunately, several <code>samtools</code> errors still do not give specific information and this is one of them. I knew that <em>somewhere</em> a read, on <em>some</em> chromosome appears somewhere it shouldn&#8217;t, but with each of these bridged BAMs containing tens of millions of records, finding it manually could be almost impossible.</p>
<p>I manually inspected the first 20 or so records in the bridged BAM, all the reads were on TID 1, as expected. The co-ordinates were indeed sorted, starting with the first read at position 10,000.</p>
<p>10,000? Seems a little high? On a hunch I grepped the bridged BAM to try and find a record on TID 1 starting at position 0:</p>
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-64f105f4c767a107658354" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea  class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
grep -Pn -m1 "^[A-z0-9:#]*\t[0-9]*\t1\t1\t" &lt;(samtools view 7500_7#8.GRCh37-hs37d5_bb.bam)
</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-64f105f4c767a107658354-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105f4c767a107658354-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-64f105f4c767a107658354-1"><span class="crayon-v">grep</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">Pn</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">m1</span><span class="crayon-h"> </span><span class="crayon-s">"^[A-z0-9:#]*\t[0-9]*\t1\t1\t"</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-sy">(</span><span class="crayon-e">samtools </span><span class="crayon-i">view</span><span class="crayon-h"> </span><span class="crayon-cn">7500_7</span><span class="crayon-p">#8.GRCh37-hs37d5_bb.bam)</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105f4c767a107658354-2">&nbsp;</div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0001 seconds] -->
<p></p>
<p>I got a hit. Read <code>HS29_07500:7:1206:5383:182635#8</code> appears on TID 1, position 1. Its line number in the bridged BAM? 64,070,629. There&#8217;s our non-continuous chromosome.</p>
<p>I took the read name and checked the three sorted inputs to <code>brunel</code>. It appears in the &#8220;unchanged&#8221; BAM. You may recall these &#8220;unchanged&#8221; reads are those that <code>binnie</code> deemed as not requiring re-mapping to the new reference and can effectively &#8220;stay put&#8221;. The interesting part of the hit? In the unchanged BAM, it doesn&#8217;t appear on chromosome 1 at all but on &#8220;HSCHRUN_RANDOM_CTG19&#8221;, presumably some form of decoy sequence.</p>
<p>This appears to be a serious bug in <code>brunel</code>. This &#8220;HSCHRUN_RANDOM_CTG19&#8221; sequence (and presumably others) seem to be leaving <code>brunel</code> as aligned to chromosome 1 in the new reference. Adding some weight to the theory, the unchanged BAM is the only input that goes through translation too.</p>
<p>Let&#8217;s revisit <a href="https://github.com/wtsi-hgi/bridgebuilder/blob/673f8aa57abe7acbd688accbeda163c9f6b4eb6a/brunel/src/main.c#L86"><code>build_translation_file</code></a>, you recall that the i-th SQ line of the input BAM &#8212; the &#8220;unchanged&#8221; BAM &#8212; is mapped to the j-th entry of the user-provided translation table text file. The translation itself is recorded with <code>trans[i] = j</code> where both <code>i</code> and <code>j</code> rely on two loops meeting particular exit conditions.</p>
<p>But note the while loop:</p>
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-64f105f4c767d193535646" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea  class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
int counter = file_entries;
[...]
while (!feof(trans_file) &amp;&amp; !ferror(trans_file) &amp;&amp; counter &gt; 0) {
    getline(&amp;linepointer, &amp;read, trans_file);
    [...]
    trans[i] = j;
    counter--;
}
[...] 
</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-64f105f4c767d193535646-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105f4c767d193535646-2">2</div><div class="crayon-num" data-line="crayon-64f105f4c767d193535646-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105f4c767d193535646-4">4</div><div class="crayon-num" data-line="crayon-64f105f4c767d193535646-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105f4c767d193535646-6">6</div><div class="crayon-num" data-line="crayon-64f105f4c767d193535646-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105f4c767d193535646-8">8</div><div class="crayon-num" data-line="crayon-64f105f4c767d193535646-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105f4c767d193535646-10">10</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-64f105f4c767d193535646-1"><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">counter</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">file_entries</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105f4c767d193535646-2"><span class="crayon-sy">[</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-64f105f4c767d193535646-3"><span class="crayon-st">while</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-o">!</span><span class="crayon-e">feof</span><span class="crayon-sy">(</span><span class="crayon-v">trans_file</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&amp;&amp;</span><span class="crayon-h"> </span><span class="crayon-o">!</span><span class="crayon-e">ferror</span><span class="crayon-sy">(</span><span class="crayon-v">trans_file</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&amp;&amp;</span><span class="crayon-h"> </span><span class="crayon-v">counter</span><span class="crayon-h"> </span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105f4c767d193535646-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">getline</span><span class="crayon-sy">(</span><span class="crayon-o">&amp;</span><span class="crayon-v">linepointer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-v">read</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">trans_file</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-64f105f4c767d193535646-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">[</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105f4c767d193535646-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">trans</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">j</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-64f105f4c767d193535646-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">counter</span><span class="crayon-o">--</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105f4c767d193535646-8"><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-64f105f4c767d193535646-9"><span class="crayon-sy">[</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">]</span><span class="crayon-h"> </span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105f4c767d193535646-10">&nbsp;</div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0004 seconds] -->
<p></p>
<p>This while loop, that houses the <code>i</code> and <code>j</code> loops, as well as the assignment of <code>trans[i] = j</code>, may not run for as many SQ lines (<code>file_entries</code>) found in the unchanged BAM, as stored in counter, if the length of the <code>trans_file</code> is shorter than the number of <code>file_entries</code>. Which in our case, it is &#8212; as there are only entries in the translation text file for chromosomes that actually need translating (Chr1 -&gt; 1).</p>
<p>Thus not every element in <code>trans</code> is set with a value by the while loop. Though we&#8217;ve <a href="/2015/07/23/bridgebuilding-p2/">already seen</a> where there is no translation to be made, this doesn&#8217;t work either.</p>
<p>This is particularly troubling, as the <a href="https://github.com/wtsi-hgi/bridgebuilder/blob/673f8aa57abe7acbd688accbeda163c9f6b4eb6a/brunel/src/main.c#L279">check for whether a translation should be performed</a> relies on the default value of <code>trans</code> being <code>NULL</code>. As no default value is set and 0 is the most likely value to turn up in the memory allocated by <code>malloc</code>, the default value for <code>trans[i]</code> for all <code>i</code>, is 0. Or in <code>brunel</code> terms, <strong>if I can&#8217;t find a better translation, translate SQ line <code>i</code>, to the 0th line (first chromosome) in the user translation file</strong>.</p>
<p>Holy crap. <a href="https://github.com/wtsi-hgi/bridgebuilder/issues/8">That&#8217;s a nasty bug</a>.</p>
<p>As described in the bug report, I toyed with quick fixes based on initialising <code>trans</code> with default values:</p>
<blockquote>
<ul>
<li><strong>Initialise <code>trans[i] = i</code></strong><br />
  This will likely incorrectly label reads as aligning to the i-th SQ line in the new file. If the number of SQ lines in the input is greater than that of the output, this will also likely cause samtools index to error or segfault as it attempts to index a TID that is outside the range of SQ.</li>
<li><strong>Initialise <code>trans[i] = NULL</code></strong><br />
  Prevents translation of TID but actually has the same effect as above</li>
<li><strong>Initialise <code>trans[i] = -1</code></strong><br />
  The only quick-fix grade solution that works, causes any read on a TID that has no translation to be regarded as &#8220;unmapped&#8221;. Its TID will be set to &#8220;*&#8221; and the read is placed at the end of the result file. The output file is however, valid and indexable.</li>
</ul>
</blockquote>
<p>In the end the question of where these reads should actually end up is a little confusing. Josh seems to think that the new bridged BAM should contain all the old reads on their old decoy sequences if a better place in the new reference could not be found for them. In my opinion, these reads effectively &#8220;don&#8217;t map&#8221; to hs37d5 as they still lie on old decoy sequences not found in the new reference, which is convinient as my <code>trans[i] = -1</code> initialisation marks all such reads as unmapped whilst also remaining the most simple fix to the problem.</p>
<p>Either way, the argument as to what should be done with these reads is particularly moot for me and the QC study, because we&#8217;re only going to be calling SNPs and focussing on our <a href="/2015/07/22/bridgebuilding/"><strong>Goldilocks Region</strong></a> on Chromosome 3, which is neither a decoy region or Chromosome 1.</p>
<p>Having deployed my <a href="https://github.com/SamStudio8/bridgebuilder/tree/fix6">own fix</a>, I re-ran our pipeline for what I hoped to be the final time, re-ran the various checks that I&#8217;ve picked up along the way (including <code>samtools index</code>) and was finally left with <strong>870 lanelets</strong> ready for unimprovement.</p>
<p><a name="vanish-rg"></a></p>
<h3>Vanishing Read Groups</h3>
<p>Or so I thought.</p>
<p>Having convinced Micheal that I wouldn&#8217;t demand he assume the role of <code>mercury</code> for me at short notice again, he informed me that whilst all my lanelets had successfully passed the <em>first step</em> of the <em>first pipeline</em> in the entire <code>vr-pipe</code> workflow &#8212; indexing. All but (you guessed it), 33 lanelets, failed the following step. <code>GATK</code> was upset that some reads were missing an <code>RG</code> tag.</p>
<p>Sigh. Sigh. Sigh. Table flip.</p>
<p><code>GATK</code> at least gave me a read name to look up with grep and indeed, these reads <em>were</em> missing their RG tag. I traced the reads backward through each intermediate file to see where these tags were lost. I found that these reads had been binned by <code>binnie</code> as requiring re-mapping to the new reference with <code>bwa</code>. The resulting file from <code>bwa</code> was missing an <code>@RG</code> line and thus each read had no <code>RG</code> tag.</p>
<p>Crumbs. I hit the web to see whether this was anticipated behaviour. The <a href="http://gatkforums.broadinstitute.org/discussion/1903/question-about-rg-tags">short answer</a> was yes, but the longer answer was &#8220;you should have used <code>-r</code> to provide <code>bwa</code> with an <code>RG</code> line to use&#8221;. Though I throw my hands up in the air a little here to say &#8220;I didn&#8217;t write the <code>Makefile</code> and I&#8217;ve never used <code>bwa</code>&#8220;.</p>
<p>Luckily, Martin has recently <a href="https://github.com/samtools/samtools/pull/371">drafted a pull request</a> to <code>samtools</code> for a new subcommand: <code>addreplacerg</code>. Its purpose? Adding and replacing RG lines and tags in BAM files. More usefully, at least to us, <span style="text-decoration: line-through;">its default</span><sup id="fnref-165-3"><a href="#fn-165-3" rel="footnote">3</a></sup> it offers an operation &#8220;mode&#8221; to tag &#8220;orphan&#8221; records (reads that have no RG line &#8212; exactly the problem I am facing) with the first RG line found in the header.</p>
<p>Perfect. I&#8217;ll just feed each final bridged BAM I have to <code>samtools addreplacerg</code> and maybe, just maybe, we&#8217;ll be able to pull the trigger on <code>vr-pipe</code> for the final time.</p>
<p>I hope.</p>
<p><a name="queuequeue"></a></p>
<h3>Queue Queue <em>Update: 1 day later</em></h3>
<p>For those still following at home, my run of <code>samtools addreplacerg</code> seemed to go without a hitch, which in retrospect should have been suspicious. I manually inspected just a handful of the files to ensure both the &#8220;orphaned&#8221; reads now had an <code>RG</code> tag (and more specifically that it was the correct and only <code>RG</code> line in the file) and that the already tagged reads had not been interfered with. All seemed well.</p>
<p>After hitting the button on <code>vr-pipe</code> once more, it took a few hours for the web interface to catch up and throw up glaring red progress bars. It seems the first step &#8211; the BAM indexing was now failing? I had somehow managed to go a step backwards?</p>
<p>The bridged BAMs were truncated&#8230; Immediately I begun scouring the source code of <code>samtools addreplacerg</code> before realising in my excitement I had skipped my usual quality control test suite. I consulted <code>bhist -e</code>, a command to display recently submitted cluster jobs that had exited with error and was bombarded with line after line of <code>addreplacerg</code> job metadata. Inquiring specifically, each and every job in the array had violated its run time limit.</p>
<p>I anticipated <code>addreplacerg</code> would not require much processing, it just iterates over the input BAM, slapping an <code>RG</code> sticker on any record missing one and throws it on the output pile. Of course, with tens of millions of records per file even the quickest of operations can aggregate into considerable time. Thus placing the <code>addreplacerg</code> jobs on Sanger&#8217;s <code>short</code> queue was clearly an oversight of mine.</p>
<p>I resubmitted to the <code>normal</code> queue which permits a longer default run time limit and applied quality control to <strong>all</strong> files. We had the green light to re-launch <code>vr-pipe</code>.</p>
<h3>Conquering Quotas <em>Update: 4 days later</em></h3>
<p>Jobs slowly crawled through the indexing and integrity checking stages and eventually began their way through the more time-consuming and intensive GATK indel discovery and re-alignment steps, before suddenly and uncontrollably failing in their hundreds. I watched a helpless <code>vr-pipe</code> attempt to resuscitate each job three times before calling a time of death on my project and shutting down the pipeline entirely.</p>
<p>Other than debugging output from <code>vr-pipe</code> scheduling and submitting the jobs, the error logs were empty. <code>vr-pipe</code> had no idea what was happening, and neither did I.</p>
<p>I escalated the situation to Martin, who could dig a little deeper with his <code>mercury</code> mask on. The problem appeared somewhat more widespread than just my pipeline; in fact all pipelines writing to the same storage cluster had come down with a case of sudden unexpected rapid job death. It was serious.</p>
<p>The situation: pipelines are orchestrated by <code>vr-pipe</code>, which is responsible for submitting jobs to the LSF scheduler for execution. LSF requires a user to be named as the owner of a job and so <code>vr-pipe</code> uses <code>mercury</code>. I am unsure whether this is just practical, or whether it is to ensure jobs get a fair share of resources by all having the same owner though I suspect it could just be an inflexibility in <code>vr-pipe</code>. The net result of jobs being run as <code>mercury</code> is that every output file is also owned by <code>mercury</code>. The relevance of this is that every storage cluster has user quotas, an upper bound on the amount of disk space files owned by that user may occupy before being denied write access.</p>
<p>Presumably you can see where this is going. In short, my job pushed <code>mercury</code> 28TB over-quota and so disk write operations failed. Jobs, unable to write to disk aborted immediately but the nature of the error was not propagated to <code>vr-pipe</code>.</p>
<p>Martin is kindly taking care of the necessary juggling to rebalance the books. Will keep you posted.</p>
<hr />
<h1>tl;dr</h1>
<ul>
<li>Make sure your pipeline has the correct permissions to do what it needs with your directory, idiot.</li>
<li>There&#8217;s a special place in hell reserved for those who know <code>git</code> and don&#8217;t use it<sup id="fnref-165-4"><a href="#fn-165-4" rel="footnote">4</a></sup>.</li>
<li><a href="https://github.com/wtsi-hgi/bridgebuilder/issues/7">Brunel naively assumes inputs are sorted</a></li>
<li><a href="https://github.com/wtsi-hgi/bridgebuilder/issues/8">[critical] Brunel unintentionally translates untranlated entries</a></li>
<li>You should use the <code>-r</code> argument of <code>bwa sampe</code> to ensure your resulting BAM has an RG line</li>
<li>Bioinformatics is <em>never</em> <strong>ever</strong> simple.</li>
<li>There are bugs <strong>everywhere</strong>, you probably just haven&#8217;t found them yet.</li>
</ul>
<div class="footnotes">
<hr />
<ol>
<li id="fn-165-1">
Unfortunately somebody towing a caravan decided to have their car burst in to flame on the southbound M11, this and several other incidents turned a boring five hour journey in to a nine hour tiresome ordeal.&#160;<a href="#fnref-165-1" rev="footnote">&#8617;</a>
</li>
<li id="fn-165-2">
Somewhat like a glorified <code>sudo</code> for humgen projects.&#160;<a href="#fnref-165-2" rev="footnote">&#8617;</a>
</li>
<li id="fn-165-3">
<a href="https://github.com/mp15/samtools/pull/4">Turns out</a>, its default mode is <code>overwrite_all</code>.&#160;<a href="#fnref-165-3" rev="footnote">&#8617;</a>
</li>
<li id="fn-165-4">
Honestly, it doesn&#8217;t matter how trivial the file is, if it&#8217;s going to be messed around with frequently, or is a pinnacle piece of code for orchestrating a pipeline, put it under version control. Nobody is going to judge you for trivial use of version control.&#160;<a href="#fnref-165-4" rev="footnote">&#8617;</a>
</li>
</ol>
</div>
</div>
                
                        <div class="tag-well"><span><span class="fa fa-tags"></span>&nbsp;&nbsp; <a href="https://samnicholls.net/tag/bridgebuilder/" rel="tag">bridgebuilder</a>,&nbsp; <a href="https://samnicholls.net/tag/pipeline/" rel="tag">pipeline</a>,&nbsp; <a href="https://samnicholls.net/tag/quality-control/" rel="tag">quality control</a>,&nbsp; <a href="https://samnicholls.net/tag/sample-improvement/" rel="tag">sample improvement</a>,&nbsp; <a href="https://samnicholls.net/tag/sanger/" rel="tag">sanger</a></span></div>
                
                <nav class="further-reading">
	<div class="previous">
		<span>Previous Post</span>
		<a href="https://samnicholls.net/2015/07/23/bridgebuilding-p2/">The Tolls of Bridge Building: Part II, Construction</a>
	</div>
	<div class="next">
		<span>Next Post</span>
		<a href="https://samnicholls.net/2015/08/04/belgian/">Belgian</a>
	</div>
</nav>            </article>
                                <div class="card">

<div id="disqus_thread"></div>
                </div>
    
</section>

        <!-- Sidebar -->
        <aside class="col-md-4 sidebar-container">
		            <div id="widget-area" class="widget-area" role="complementary">
                <div id="custom_html-3" class="widget_text card widget widget_custom_html"><div class="textwidget custom-html-widget"><img src="https://pbs.twimg.com/profile_images/1044255545610436609/wt33ZbtU_400x400.jpg" height=120 style="margin-top: 20px; margin-right:10px; float: left;" alt="Sam Nicholls" />
<div style="padding-top:15px; line-height: normal"><b style="font-size: 1.2em">Sam Nicholls</b><br><span style="font-size: 0.9em;">Haplotype Wrangler at University of Birmingham.<br>I tell computers to do things, then I write about how it all went wrong.</span></div></div></div><div id="search-2" class="card widget widget_search"><form style="margin-top:15px" action="https://samnicholls.net/" id="searchform" method="get" role="form">
    <div class="form-group">
        <input type="text" class="form-control" name="s" id="s" placeholder="e.g. Search...">
    </div>
</form>
</div><div id="twitter_timeline-5" class="card widget widget_twitter_timeline"><a class="twitter-timeline" data-height="400" data-theme="light" data-link-color="#f96e5b" data-border-color="#e8e8e8" data-lang="EN" data-partner="jetpack" data-chrome="noheader nofooter noborders" href="https://twitter.com/samstudio8">My Tweets</a></div><div id="categories-5" class="card widget widget_categories"><h2>Categories</h2>
			<ul>
					<li class="cat-item cat-item-2"><a href="https://samnicholls.net/category/bioinf/">Bioinformatics</a>
<ul class='children'>
	<li class="cat-item cat-item-8"><a href="https://samnicholls.net/category/bioinf/au-phd/">AU-PhD</a>
</li>
	<li class="cat-item cat-item-3"><a href="https://samnicholls.net/category/bioinf/sanger-qc/" title="Sanger QC Project">Sanger-QC</a>
</li>
	<li class="cat-item cat-item-61"><a href="https://samnicholls.net/category/bioinf/tools/">Tools</a>
	<ul class='children'>
	<li class="cat-item cat-item-185"><a href="https://samnicholls.net/category/bioinf/tools/chitin/">chitin</a>
</li>
	</ul>
</li>
</ul>
</li>
	<li class="cat-item cat-item-80"><a href="https://samnicholls.net/category/devops/">Devops</a>
</li>
	<li class="cat-item cat-item-114"><a href="https://samnicholls.net/category/event/">Event</a>
</li>
	<li class="cat-item cat-item-21"><a href="https://samnicholls.net/category/gadgets/">Gadgets</a>
</li>
	<li class="cat-item cat-item-176"><a href="https://samnicholls.net/category/hardware/">Hardware</a>
<ul class='children'>
	<li class="cat-item cat-item-223"><a href="https://samnicholls.net/category/hardware/beehive-monitor/">Beehive Monitor</a>
</li>
	<li class="cat-item cat-item-178"><a href="https://samnicholls.net/category/hardware/esp8266/">ESP8266</a>
</li>
	<li class="cat-item cat-item-236"><a href="https://samnicholls.net/category/hardware/lego-sequencer/">Lego Sequencer</a>
</li>
	<li class="cat-item cat-item-177"><a href="https://samnicholls.net/category/hardware/lightstick/">Lightstick</a>
</li>
</ul>
</li>
	<li class="cat-item cat-item-151"><a href="https://samnicholls.net/category/lab/">Lab</a>
<ul class='children'>
	<li class="cat-item cat-item-150"><a href="https://samnicholls.net/category/lab/protocol-guides/">Protocol Guides</a>
</li>
</ul>
</li>
	<li class="cat-item cat-item-5"><a href="https://samnicholls.net/category/meta/">Meta</a>
</li>
	<li class="cat-item cat-item-62"><a href="https://samnicholls.net/category/mysteries/">Mysteries</a>
</li>
	<li class="cat-item cat-item-22"><a href="https://samnicholls.net/category/personal/">Personal</a>
</li>
	<li class="cat-item cat-item-4"><a href="https://samnicholls.net/category/photo/">Photography</a>
</li>
	<li class="cat-item cat-item-143"><a href="https://samnicholls.net/category/programming/">Programming</a>
<ul class='children'>
	<li class="cat-item cat-item-145"><a href="https://samnicholls.net/category/programming/documentation/">Documentation</a>
</li>
	<li class="cat-item cat-item-144"><a href="https://samnicholls.net/category/programming/python/">Python</a>
</li>
</ul>
</li>
	<li class="cat-item cat-item-48"><a href="https://samnicholls.net/category/status-report/">Status Report</a>
</li>
	<li class="cat-item cat-item-60"><a href="https://samnicholls.net/category/sysadm/">System Administration</a>
</li>
	<li class="cat-item cat-item-1"><a href="https://samnicholls.net/category/uncategorised/">Uncategorised</a>
</li>
			</ul>

			</div>            </div>
		        </aside>
    </div>

</div> <!-- /container -->

<footer id="main-footer" class="bg-primary">
	<div id="footer-widgets" class="container">
		    </div>
</footer>



	<div style="display:none">
	</div>
<script type='text/javascript' src='https://samnicholls.net/wp-includes/js/comment-reply.min.js?ver=5.7.5' id='comment-reply-js'></script>
<script type='text/javascript' id='disqus_count-js-extra'>
/* <![CDATA[ */
var countVars = {"disqusShortname":"samposium-blog"};
/* ]]> */
</script>
<script type='text/javascript' src='https://samnicholls.net/wp-content/plugins/disqus-comment-system/public/js/comment_count.js?ver=3.0.17' id='disqus_count-js'></script>
<script type='text/javascript' id='disqus_embed-js-extra'>
/* <![CDATA[ */
var embedVars = {"disqusConfig":{"integration":"wordpress 3.0.17"},"disqusIdentifier":"165 http:\/\/blog.ironowl.io\/?p=165","disqusShortname":"samposium-blog","disqusTitle":"The Tolls of Bridge Building: Part III, Sample (Un)Improvement","disqusUrl":"https:\/\/samnicholls.net\/2015\/07\/31\/bridgebuilding-p3\/","postId":"165"};
/* ]]> */
</script>
<script type='text/javascript' src='https://samnicholls.net/wp-content/plugins/disqus-comment-system/public/js/comment_embed.js?ver=3.0.17' id='disqus_embed-js'></script>
<script type='text/javascript' src='https://s0.wp.com/wp-content/js/devicepx-jetpack.js?ver=202335' id='devicepx-js'></script>
<script type='text/javascript' src='https://samnicholls.net/wp-content/plugins/jetpack/_inc/twitter-timeline.js?ver=4.0.0' id='jetpack-twitter-timeline-js'></script>
<script type='text/javascript' src='https://samnicholls.net/wp-includes/js/wp-embed.min.js?ver=5.7.5' id='wp-embed-js'></script>
<script type='text/javascript' src='https://stats.wp.com/e-202335.js' async defer></script>
<script type='text/javascript'>
	_stq = window._stq || [];
	_stq.push([ 'view', {v:'ext',j:'1:4.9',blog:'101350222',post:'165',tz:'1',srv:'samnicholls.net'} ]);
	_stq.push([ 'clickTrackerInit', '101350222', '165' ]);
</script>

<script type="text/javascript">
(function() {
  if (navigator.userAgent.match(/IEMobile\/10\.0/)) {
    var msViewportStyle = document.createElement("style");
    msViewportStyle.appendChild(
      document.createTextNode("@-ms-viewport{width:auto!important}")
    );
    document.getElementsByTagName("head")[0].appendChild(msViewportStyle);
  }
})();

var collapsed = false;
jQuery( document ).ready(function($) {
    $('.navbar-toggle').click(function(){
        console.log(collapsed);
        if(collapsed) {
            $('.navbar-header > button').html('<i class="fa fa-bars"></i>');
        } else {
            $('.navbar-header > button').html('<i class="fa fa-times"></i>');
        }
        $('.navbar-collapse').toggle(200);
        collapsed = !collapsed;
    });
});
</script>
	
</body>

</html>
