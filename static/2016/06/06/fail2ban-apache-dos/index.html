<!DOCTYPE html>
<html lang="en-GB">

<head>
	<meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="pingback" href="https://samnicholls.net/xmlrpc.php">

	
	<title>Using fail2ban to mitigate simple DOS attacks against apache (or why I am a terrible sysop) &#8211; Samposium</title>
<meta name='robots' content='max-image-preview:large' />
<link rel='dns-prefetch' href='//s0.wp.com' />
<link rel='dns-prefetch' href='//fonts.googleapis.com' />
<link rel='dns-prefetch' href='//s.w.org' />
<link rel="alternate" type="application/rss+xml" title="Samposium &raquo; Feed" href="https://samnicholls.net/feed/" />
<link rel="alternate" type="application/rss+xml" title="Samposium &raquo; Comments Feed" href="https://samnicholls.net/comments/feed/" />
<link rel="alternate" type="application/rss+xml" title="Samposium &raquo; Using fail2ban to mitigate simple DOS attacks against apache (or why I am a terrible sysop) Comments Feed" href="https://samnicholls.net/2016/06/06/fail2ban-apache-dos/feed/" />
		<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/13.0.1\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/13.0.1\/svg\/","svgExt":".svg","source":{"concatemoji":"https:\/\/samnicholls.net\/wp-includes\/js\/wp-emoji-release.min.js?ver=5.7.5"}};
			!function(e,a,t){var n,r,o,i=a.createElement("canvas"),p=i.getContext&&i.getContext("2d");function s(e,t){var a=String.fromCharCode;p.clearRect(0,0,i.width,i.height),p.fillText(a.apply(this,e),0,0);e=i.toDataURL();return p.clearRect(0,0,i.width,i.height),p.fillText(a.apply(this,t),0,0),e===i.toDataURL()}function c(e){var t=a.createElement("script");t.src=e,t.defer=t.type="text/javascript",a.getElementsByTagName("head")[0].appendChild(t)}for(o=Array("flag","emoji"),t.supports={everything:!0,everythingExceptFlag:!0},r=0;r<o.length;r++)t.supports[o[r]]=function(e){if(!p||!p.fillText)return!1;switch(p.textBaseline="top",p.font="600 32px Arial",e){case"flag":return s([127987,65039,8205,9895,65039],[127987,65039,8203,9895,65039])?!1:!s([55356,56826,55356,56819],[55356,56826,8203,55356,56819])&&!s([55356,57332,56128,56423,56128,56418,56128,56421,56128,56430,56128,56423,56128,56447],[55356,57332,8203,56128,56423,8203,56128,56418,8203,56128,56421,8203,56128,56430,8203,56128,56423,8203,56128,56447]);case"emoji":return!s([55357,56424,8205,55356,57212],[55357,56424,8203,55356,57212])}return!1}(o[r]),t.supports.everything=t.supports.everything&&t.supports[o[r]],"flag"!==o[r]&&(t.supports.everythingExceptFlag=t.supports.everythingExceptFlag&&t.supports[o[r]]);t.supports.everythingExceptFlag=t.supports.everythingExceptFlag&&!t.supports.flag,t.DOMReady=!1,t.readyCallback=function(){t.DOMReady=!0},t.supports.everything||(n=function(){t.readyCallback()},a.addEventListener?(a.addEventListener("DOMContentLoaded",n,!1),e.addEventListener("load",n,!1)):(e.attachEvent("onload",n),a.attachEvent("onreadystatechange",function(){"complete"===a.readyState&&t.readyCallback()})),(n=t.source||{}).concatemoji?c(n.concatemoji):n.wpemoji&&n.twemoji&&(c(n.twemoji),c(n.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
	<link rel='stylesheet' id='crayon-css'  href='https://samnicholls.net/wp-content/plugins/crayon-syntax-highlighter/css/min/crayon.min.css?ver=_2.7.2_beta' type='text/css' media='all' />
<link rel='stylesheet' id='crayon-theme-github-css'  href='https://samnicholls.net/wp-content/plugins/crayon-syntax-highlighter/themes/github/github.css?ver=_2.7.2_beta' type='text/css' media='all' />
<link rel='stylesheet' id='crayon-font-monaco-css'  href='https://samnicholls.net/wp-content/plugins/crayon-syntax-highlighter/fonts/monaco.css?ver=_2.7.2_beta' type='text/css' media='all' />
<link rel='stylesheet' id='wp-block-library-css'  href='https://samnicholls.net/wp-includes/css/dist/block-library/style.min.css?ver=5.7.5' type='text/css' media='all' />
<link rel='stylesheet' id='css-style-css'  href='https://samnicholls.net/wp-content/themes/responsive-deluxe/css/style.css?ver=5.7.5' type='text/css' media='all' />
<link rel='stylesheet' id='child-style-css'  href='https://samnicholls.net/wp-content/themes/responsive-deluxe-child/style.css?ver=5.7.5' type='text/css' media='all' />
<link rel='stylesheet' id='lato-css'  href='//fonts.googleapis.com/css?family=Lato%3A400%2C700%2C400italic&#038;ver=5.7.5' type='text/css' media='all' />
<link rel='stylesheet' id='slabo-css'  href='//fonts.googleapis.com/css?family=Slabo+27px&#038;ver=5.7.5' type='text/css' media='all' />
<link rel='stylesheet' id='fa-css'  href='https://samnicholls.net/wp-content/themes/responsive-deluxe/css/font-awesome.css?ver=5.7.5' type='text/css' media='all' />
<link rel='stylesheet' id='rd-style-css'  href='https://samnicholls.net/wp-content/themes/responsive-deluxe-child/style.css?ver=5.7.5' type='text/css' media='all' />
<link rel='stylesheet' id='css-custom-css'  href='https://samnicholls.net/wp-content/themes/responsive-deluxe/css/custom.css?ver=5.7.5' type='text/css' media='all' />
<link rel='stylesheet' id='jetpack_css-css'  href='https://samnicholls.net/wp-content/plugins/jetpack/css/jetpack.css?ver=4.9' type='text/css' media='all' />
<script type='text/javascript' src='https://samnicholls.net/wp-includes/js/jquery/jquery.min.js?ver=3.5.1' id='jquery-core-js'></script>
<script type='text/javascript' src='https://samnicholls.net/wp-includes/js/jquery/jquery-migrate.min.js?ver=3.3.2' id='jquery-migrate-js'></script>
<script type='text/javascript' id='crayon_js-js-extra'>
/* <![CDATA[ */
var CrayonSyntaxSettings = {"version":"_2.7.2_beta","is_admin":"0","ajaxurl":"https:\/\/samnicholls.net\/wp-admin\/admin-ajax.php","prefix":"crayon-","setting":"crayon-setting","selected":"crayon-setting-selected","changed":"crayon-setting-changed","special":"crayon-setting-special","orig_value":"data-orig-value","debug":""};
var CrayonSyntaxStrings = {"copy":"Press %s to Copy, %s to Paste","minimize":"Click To Expand Code"};
/* ]]> */
</script>
<script type='text/javascript' src='https://samnicholls.net/wp-content/plugins/crayon-syntax-highlighter/js/min/crayon.min.js?ver=_2.7.2_beta' id='crayon_js-js'></script>
<script type='text/javascript' src='https://samnicholls.net/wp-content/plugins/fd-footnotes/fdfootnotes.js?ver=1.34' id='fdfootnote_script-js'></script>
<script type='text/javascript' src='https://samnicholls.net/wp-content/themes/responsive-deluxe/js/bootstrap.js?ver=5.7.5' id='bootstrap-js'></script>
<script type='text/javascript' src='https://samnicholls.net/wp-content/themes/responsive-deluxe/js/custom.js?ver=5.7.5' id='js-custom-js'></script>
<link rel="https://api.w.org/" href="https://samnicholls.net/wp-json/" /><link rel="alternate" type="application/json" href="https://samnicholls.net/wp-json/wp/v2/posts/745" /><link rel="EditURI" type="application/rsd+xml" title="RSD" href="https://samnicholls.net/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="https://samnicholls.net/wp-includes/wlwmanifest.xml" /> 
<meta name="generator" content="WordPress 5.7.5" />
<link rel="canonical" href="https://samnicholls.net/2016/06/06/fail2ban-apache-dos/" />
<link rel='shortlink' href='https://wp.me/p6RfP0-c1' />
<link rel="alternate" type="application/json+oembed" href="https://samnicholls.net/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fsamnicholls.net%2F2016%2F06%2F06%2Ffail2ban-apache-dos%2F" />
<link rel="alternate" type="text/xml+oembed" href="https://samnicholls.net/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fsamnicholls.net%2F2016%2F06%2F06%2Ffail2ban-apache-dos%2F&#038;format=xml" />
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-62206786-1', 'auto');
  ga('send', 'pageview');

</script>


<link rel='dns-prefetch' href='//v0.wordpress.com'>
<style type='text/css'>img#wpstats{display:none}</style>
<!-- Jetpack Open Graph Tags -->
<meta property="og:type" content="article" />
<meta property="og:title" content="Using fail2ban to mitigate simple DOS attacks against apache (or why I am a terrible sysop)" />
<meta property="og:url" content="https://samnicholls.net/2016/06/06/fail2ban-apache-dos/" />
<meta property="og:description" content="Earlier this afternoon, my server was upset. Here&#8217;s what happened, how it took so long to find out, and how I will try and stop it happening again. In particular, I provide configuration for â€¦" />
<meta property="article:published_time" content="2016-06-06T21:49:49+00:00" />
<meta property="article:modified_time" content="2016-06-15T19:40:45+00:00" />
<meta property="og:site_name" content="Samposium" />
<meta property="og:image" content="https://s0.wp.com/i/blank.jpg" />
<meta property="og:locale" content="en_GB" />
<meta name="twitter:card" content="summary" />
</head>

<body class="post-template-default single single-post postid-745 single-format-standard">


        
<header id="main-header">
    <nav class="navbar-default navbar-static-top navbar" role="navigation">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#rd-collapse">
                    <span class="fa fa-bars"></span>
                    <span class="sr-only screen-reader-text">Toggle navigation</span>
                </button>
                <a class="navbar-brand" href=" https://samnicholls.net/">Samposium</a>            </div>
            
            <div id="rd-collapse" class="collapse navbar-collapse">
            
            <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<html><body class="post-template-default single single-post postid-745 single-format-standard">

<div id="main-menu" class="navbar-nav nav"><ul>
<li class="page_item page-item-8"><a href="https://samnicholls.net/about/">About Me</a></li>
<li class="page_item page-item-11"><a href="https://samnicholls.net/talks/">Talks</a></li>
<li class="page_item page-item-15"><a href="https://samnicholls.net/things-i-have-learned/">Things I Have Learned</a></li>
</ul></div></body></html>
        </div>

        </div>
    </nav>
</header>

<div class="container">

    <div class="row"><!-- Content -->
<section class="col-md-8 content-container">
                          <article class="card post hentry post-745 type-post status-publish format-standard category-devops category-sysadm tag-apache tag-apache2 tag-attack tag-config tag-ddos tag-dos tag-fail2ban tag-fail2ban-regex tag-http-get-dos tag-jail-conf tag-ossec tag-security tag-xmlrpc" id="post-745">
                <header class="entry-header">
                        <h1 class="entry-title">Using fail2ban to mitigate simple DOS attacks against apache (or why I am a terrible sysop)</h1>                </header><!-- .entry-header -->

                <div class="meta-well">
                    <span style="margin-right:15px;" class=""><span class="fa fa-user"></span>&nbsp;&nbsp;&nbsp;<span class="author vcard"><a class="url fn n" href="https://samnicholls.net/about/">Sam Nicholls</a></span></span>

                    <span style="margin-right:15px;" class="entry-date published updated post-date"><span class="fa fa-clock-o"></span>&nbsp;&nbsp; <time class="entry-date published" datetime="2016-06-06T22:49:49+01:00">6th June 2016</time><time class="updated" datetime="2016-06-15T20:40:45+01:00">15th June 2016</time></span>                    <span style="margin-right:15px;" class=""><span class="fa fa-comments-o"></span>&nbsp;&nbsp; <a href="https://samnicholls.net/2016/06/06/fail2ban-apache-dos/#respond"><span class="dsq-postid" data-dsqidentifier="745 https://samnicholls.net/?p=745">No Comments yet</span></a></span>
                    <span class=""><span class="fa fa-folder-open"></span>&nbsp;&nbsp;&nbsp;<a href="https://samnicholls.net/category/devops/" rel="category tag">Devops</a>, <a href="https://samnicholls.net/category/sysadm/" rel="category tag">System Administration</a></span>
                </div>

                <div class="entry-content"><p class="message">If you aren&#8217;t interested in the dramatic reconstruction of the events that led me to try and configure a simple DOS jail with fail2ban, you can <a href="#jailconf">skip to the fail2ban apache DOS jail mitigation</a>.<br />If you just want to know what happened without the flair, <a href="#tldr">skip to the timeline</a>.</p>
<p>Earlier this afternoon, my server was upset. At <code>15:57</code>, a duo of IP addresses begun making rapid and repeated POST requests to an auxiliary component of WordPress, forcing apache to begin consuming significant amounts of system memory. Disappointingly this went undetected, and less than half an hour later, at <code>16:24</code>, the system ran out of memory, invoked the OOM killer and terminated <code>mysqld</code>. Thus at <code>16:24</code>, denial of service to all applications requiring access to a database was successful.</p>
<p>Although the server dutifully restarted <code>mysqld</code> less than a minute later, the attack continued. Access to <code>apache</code> was denied intermittently (by virtue of the number of requests) and the OOM killer terminated <code>mysqld</code> again at <code>16:35</code>. The database server daemon was respawned once more, only to be killed just short of half an hour later at <code>17:03</code>.</p>
<p>It wasn&#8217;t until <code>17:13</code> that I was notified of an issue, by means of a Linode anomaly notification, disk I/O had been unusually high for a two hour period. I was away from my terminal but used my phone to check my <code>netdata</code> instance. Indeed I could confirm a spike in disk activity but it appeared to have subsided. I had run some scripts and updates (which can occasionally trigger these notifications) in the previous two hours so assumed causation and dismissed the notification. Retrospectively, it would be a good idea to have some sort of check list to run through upon receipt of such a message, even if the cause seems obvious.</p>
<p>The attack continued for the next hour and a half, maintaining denial of the <code>mysqld</code> service (despite the respawner&#8217;s best effort), at <code>18:35</code> (two and a half hours after the attack began) I returned from the field to my terminal and decided to double check the origin of the high disk I/O. I loaded the <code>netdata</code> visualiser (<code>apache</code> seemed to be responsive) and load seemed a little higher than usual. Disk I/O was actually higher than usual, too. It would seem that I had become a victim of y-axis scaling; the spike I had dismissed as a one-off burst in activity earlier had masked the increase in average disk I/O. Something was happening.</p>
<p>I checked system memory, we were bursting at the seams. The <code>apache</code> process was battling to consume as much memory on the system as possible. <code>mysqld</code> appeared to be in a state of flux, so I tried to reach database backed applications; Phabricator, and my blog &#8211; both returned some form of upset &#8220;where is my database&#8221; response. I opened the <code>syslog</code> and searched for evidence that the out of memory killer had been swinging its hammer. At this point I realised this was a denial of service.</p>
<p>I located the source of the high disk I/O when I opened the <code>apache</code> access log. My terminal spewed information on <code>POST</code> requests to <code>xmlrpc.php</code> aimed at two WordPress sites hosted on my server. I immediately added <code>iptables</code> rules for both IP addresses, and two different IPs from the same block took over the attack. I checked the <code>whois</code> and discovered all the origin IPs were in the same assigned <code>/24</code> block, so I updated <code>iptables</code> with a rule to drop traffic from the whole block. The requests stopped and I restarted the seemingly mangled <code>mysqld</code> process.</p>
<p>I suspect the attack was not aimed at us particularly, but rather the result of a scan for WordPress sites (I am leaning towards for the purpose of spamming). However I was disappointed in my opsec-fu, not only did I prevent this from happening, but I failed to stop it happening for over two hours. I was running <code>OSSEC</code>, but any useful notifications failed to arrive in time as I had configured messages to be sent to a non-primary address that GMail must poll from intermittently. A level 12 notification was sent 28 minutes after the attack started as soon as the OOM was invoked for the first time, but the message was not pulled to my inbox until after the attack had been stopped.</p>
<p>The level of traffic was certainly abnormal and I was also frustrated that I had not considered configuring <code>fail2ban</code> or <code>iptables</code> to try and catch these sort of extreme cases. Admittedly, I had dabbled in this previously, but struggled to strike a balance with <code>iptables</code> that did not accidentally ban false positives attempting to use a client&#8217;s web application. Wanting to combat this happening in future, I set about to implement some mitigations:</p>
<h2>Mitigation Implementation</h2>
<p><a name="jailconf"></a></p>
<h3>Configure a crude fail2ban jail for apache DOS defence</h3>
<p>My first instinct was to prevent ridiculous numbers of requests to <code>apache</code> from the same IP being permitted in future. Naturally I wanted to tie this into <code>fail2ban</code>, the daemon I use to block access to <code>ssh</code>, the mail servers, <a href="https://samnicholls.net/2015/10/23/wrangling-wordpress/">WordPress administration</a>, and such. I found a <a href="https://www.garron.me/en/go2linux/fail2ban-protect-web-server-http-dos-attack.html">widely distributed jail configuration</a> for this purpose online but it did not work; it didn&#8217;t find any hosts to block. The hint is in the following error from <code>fail2ban.log</code> when reloading the service:</p>
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-64f105bca616d316598428" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea  class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
fail2ban.jail   : INFO   Creating new jail 'http-get-dos'
...
fail2ban.filter : ERROR  No 'host' group in '^ -.*GET'</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-64f105bca616d316598428-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105bca616d316598428-2">2</div><div class="crayon-num crayon-marked-num crayon-top crayon-bottom" data-line="crayon-64f105bca616d316598428-3">3</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-64f105bca616d316598428-1"><span class="crayon-v">fail2ban</span><span class="crayon-sy">.</span><span class="crayon-v">jail</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-e">INFO&nbsp;&nbsp; </span><span class="crayon-e">Creating </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-i">jail</span><span class="crayon-h"> </span><span class="crayon-s">'http-get-dos'</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105bca616d316598428-2"><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span></div><div class="crayon-line crayon-marked-line crayon-top crayon-bottom" id="crayon-64f105bca616d316598428-3"><span class="crayon-v">fail2ban</span><span class="crayon-sy">.</span><span class="crayon-v">filter</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-e">ERROR&nbsp;&nbsp;</span><span class="crayon-i">No</span><span class="crayon-h"> </span><span class="crayon-s">'host'</span><span class="crayon-h"> </span><span class="crayon-e">group </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-s">'^ -.*GET'</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0002 seconds] -->
<p></p>
<p>The regular expression provided by the filter (<code>failregex</code>) didn&#8217;t have a &#8216;host&#8217; group to collect the source IP with, so although <code>fail2ban</code> was capable of processing the <code>apache</code> <code>access.log</code> for lines containing <code>GET</code> requests, all the events were discarded. This is somewhat unfortunate considering the prevalence of the script (perhaps it was not intended for the <code>combined_vhost</code> formatted log, I don&#8217;t know). I cheated and added a <code>CustomLog</code> to my <code>apache</code> configuration to make parsing simple whilst also avoiding interference with the <code>LogFormat</code> of the prime <code>access.log</code> (whose format is probably expected to be the default by other tooling):</p>
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-64f105bca6176180258427" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea  class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
LogFormat "%t [%v:%p] [client %h] \"%r\" %&gt;s %b \"%{User-Agent}i\"" custom_vhost
CustomLog ${APACHE_LOG_DIR}/custom_access.log custom_vhost</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-64f105bca6176180258427-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105bca6176180258427-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-64f105bca6176180258427-1"><span class="crayon-i">LogFormat</span><span class="crayon-h"> </span><span class="crayon-s">"%t [%v:%p] [client %h] \"%r\" %&gt;s %b \"%{User-Agent}i\""</span><span class="crayon-h"> </span><span class="crayon-e">custom_vhost</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105bca6176180258427-2"><span class="crayon-e">CustomLog</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-sy">{</span><span class="crayon-v">APACHE_LOG_DIR</span><span class="crayon-sy">}</span><span class="crayon-o">/</span><span class="crayon-v">custom_access</span><span class="crayon-sy">.</span><span class="crayon-e">log </span><span class="crayon-v">custom_vhost</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0001 seconds] -->
<p></p>
<p>The <code>LogFormat</code> for the <code>CustomLog</code> above encapsulates the source IP in the same manner as the default <code>apache</code> <code>error.log</code>, with square brackets and the word &#8220;client&#8221;. I updated my <code>http-get-dos.conf</code> file to provide a host group to capture IPs as below (I&#8217;ve provided the relevant lines from <code>jail.local</code> for completeness):</p>
<p><script src="https://gist.github.com/SamStudio8/92507ad3e317edb9b869c20bb2623fcf.js?file=jail.local"></script></p>
<p><script src="https://gist.github.com/SamStudio8/92507ad3e317edb9b869c20bb2623fcf.js?file=http-get-dos.conf"></script></p>
<p>I tested the configuration with <code>fail2ban-regex</code> to confirm that IP addresses were now successfully captured:</p>
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-64f105bca617a880662351" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea  class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
$ fail2ban-regex /var/log/apache2/custom_access.log /etc/fail2ban/filter.d/http-get-dos.conf
[...]
Failregex
|- Regular expressions:
|  [1] \[[^]]+\] \[.*\] \[client &lt;HOST&gt;\] "GET .*
|
`- Number of matches:
   [1] 231 match(es)
[...]</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num crayon-marked-num crayon-top crayon-bottom" data-line="crayon-64f105bca617a880662351-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105bca617a880662351-2">2</div><div class="crayon-num" data-line="crayon-64f105bca617a880662351-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105bca617a880662351-4">4</div><div class="crayon-num" data-line="crayon-64f105bca617a880662351-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105bca617a880662351-6">6</div><div class="crayon-num" data-line="crayon-64f105bca617a880662351-7">7</div><div class="crayon-num crayon-marked-num crayon-top crayon-bottom crayon-striped-num" data-line="crayon-64f105bca617a880662351-8">8</div><div class="crayon-num" data-line="crayon-64f105bca617a880662351-9">9</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line crayon-marked-line crayon-top crayon-bottom" id="crayon-64f105bca617a880662351-1"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-v">fail2ban</span><span class="crayon-o">-</span><span class="crayon-v">regex</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-t">var</span><span class="crayon-o">/</span><span class="crayon-v">log</span><span class="crayon-o">/</span><span class="crayon-v">apache2</span><span class="crayon-o">/</span><span class="crayon-v">custom_access</span><span class="crayon-sy">.</span><span class="crayon-v">log</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-v">etc</span><span class="crayon-o">/</span><span class="crayon-v">fail2ban</span><span class="crayon-o">/</span><span class="crayon-v">filter</span><span class="crayon-sy">.</span><span class="crayon-v">d</span><span class="crayon-o">/</span><span class="crayon-v">http</span><span class="crayon-o">-</span><span class="crayon-v">get</span><span class="crayon-o">-</span><span class="crayon-v">dos</span><span class="crayon-sy">.</span><span class="crayon-i">conf</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105bca617a880662351-2"><span class="crayon-sy">[</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-64f105bca617a880662351-3"><span class="crayon-v">Failregex</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105bca617a880662351-4"><span class="crayon-o">|</span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-e">Regular </span><span class="crayon-v">expressions</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-64f105bca617a880662351-5"><span class="crayon-o">|</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-sy">\</span><span class="crayon-sy">[</span><span class="crayon-sy">[</span><span class="crayon-o">^</span><span class="crayon-sy">]</span><span class="crayon-sy">]</span><span class="crayon-o">+</span><span class="crayon-sy">\</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-sy">\</span><span class="crayon-sy">[</span><span class="crayon-sy">.</span><span class="crayon-o">*</span><span class="crayon-sy">\</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-sy">\</span><span class="crayon-sy">[</span><span class="crayon-v">client</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-v">HOST</span><span class="crayon-o">&gt;</span><span class="crayon-sy">\</span><span class="crayon-sy">]</span><span class="crayon-h"> </span>"<span class="crayon-i">GET</span><span class="crayon-h"> </span><span class="crayon-sy">.</span><span class="crayon-o">*</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105bca617a880662351-6"><span class="crayon-o">|</span></div><div class="crayon-line" id="crayon-64f105bca617a880662351-7"><span class="crayon-sy">`</span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-e">Number </span><span class="crayon-e">of </span><span class="crayon-v">matches</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-marked-line crayon-top crayon-bottom crayon-striped-line" id="crayon-64f105bca617a880662351-8"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-cn">231</span><span class="crayon-h"> </span><span class="crayon-e">match</span><span class="crayon-sy">(</span><span class="crayon-v">es</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-64f105bca617a880662351-9"><span class="crayon-sy">[</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">]</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0006 seconds] -->
<p></p>
<p>It works! However when I restarted <code>fail2ban</code>, I encountered an issue whereby clients were almost instantly banned when making only a handful of requests, which leads me to&#8230;</p>
<h3>How to badly configure fail2ban</h3>
<p>This took some time to track down, but I had the feeling that for some reason my <code>jail.conf</code> was not correctly overriding <code>maxretry</code> &#8211; the number of times an event can occur before the jail action is applied, which by default is <code>3</code>. I confirmed this by checking the <code>fail2ban.log</code> when restarting the service:</p>
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-64f105bca617c152858303" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea  class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
fail2ban.jail   : INFO   Creating new jail 'http-get-dos'
...
fail2ban.filter : INFO   Set maxRetry = 3</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-64f105bca617c152858303-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105bca617c152858303-2">2</div><div class="crayon-num crayon-marked-num crayon-top crayon-bottom" data-line="crayon-64f105bca617c152858303-3">3</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-64f105bca617c152858303-1"><span class="crayon-v">fail2ban</span><span class="crayon-sy">.</span><span class="crayon-v">jail</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-e">INFO&nbsp;&nbsp; </span><span class="crayon-e">Creating </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-i">jail</span><span class="crayon-h"> </span><span class="crayon-s">'http-get-dos'</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105bca617c152858303-2"><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span></div><div class="crayon-line crayon-marked-line crayon-top crayon-bottom" id="crayon-64f105bca617c152858303-3"><span class="crayon-v">fail2ban</span><span class="crayon-sy">.</span><span class="crayon-v">filter</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-e">INFO&nbsp;&nbsp; </span><span class="crayon-e">Set </span><span class="crayon-v">maxRetry</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">3</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0002 seconds] -->
<p></p>
<p>Turns out, the version of the <code>http-get-conf</code> jail I had copied from the internet into my <code>jail.conf</code> was an invalid configuration. <code>fail2ban</code> relies on the <a href="https://docs.python.org/2/library/configparser.html">Python <code>ConfigParser</code></a> which does not support use of the <code>#</code> character for an in-line comment. Thus lines such as the following are <strong>ignored</strong> (and the default is applied instead):</p>
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-64f105bca617f971397447" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea  class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
maxretry = 600 # 600 attempts in
findtime = 30  # 30 seconds (or less)
</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-64f105bca617f971397447-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105bca617f971397447-2">2</div><div class="crayon-num" data-line="crayon-64f105bca617f971397447-3">3</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-64f105bca617f971397447-1"><span class="crayon-v">maxretry</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">600</span><span class="crayon-h"> </span><span class="crayon-p"># 600 attempts in</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105bca617f971397447-2"><span class="crayon-v">findtime</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">30</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-p"># 30 seconds (or less)</span></div><div class="crayon-line" id="crayon-64f105bca617f971397447-3">&nbsp;</div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0001 seconds] -->
<p></p>
<p>Removing the offending comments (or switching them to correctly-styled inline comments with &#8216;;&#8217;) fixed the situation immediately. I must admit this had me stumped and seems pretty counter-intuitive especially as <code>fail2ban</code> doesn&#8217;t offer a warning or such on startup either. But indeed, <a href="http://manpages.ubuntu.com/manpages/trusty/man1/jail.conf.10.html">it appears in the documentation</a>, so <strong>RTFM</strong>, kids.</p>
<p>Note that my <code>jail.local</code> above has a jail for <code>http-post-dos</code>, too. The <code>http-post-dos.conf</code> is exactly the same as the GET counterpart, just the word <code>GET</code> is replaced with <code>POST</code> (who&#8217;d&#8217;ve thought). I&#8217;ve kept them separate as it means I can apply different rules (<code>maxretry</code> and <code>findtime</code>) to <code>GET</code> and <code>POST</code> requests. Note too, that even if I had been using <code>http-get-dos</code> today, this wouldn&#8217;t have saved me from denial of service, as the requests were <code>POST</code>s!</p>
<h3>Relay access denied when sending OSSEC notifications</h3>
<p>As mentioned, <code>OSSEC</code> was capable of sending notifications but they were not delivered until it was far too late. I altered the global <code>ossec.conf</code> to set the <code>email_to</code> field to something more suitable, but when I tested a notification, it was not received. When I checked the <code>ossec.log</code>, I found the following error:</p>
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-64f105bca6181367143410" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea  class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
ossec-maild(1223): ERROR: Error Sending email to xxx.xxx.xxx.xxx (smtp server)
</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-64f105bca6181367143410-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105bca6181367143410-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-64f105bca6181367143410-1"><span class="crayon-v">ossec</span><span class="crayon-o">-</span><span class="crayon-e">maild</span><span class="crayon-sy">(</span><span class="crayon-cn">1223</span><span class="crayon-sy">)</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">ERROR</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-e">Error </span><span class="crayon-e">Sending </span><span class="crayon-e">email </span><span class="crayon-st">to</span><span class="crayon-h"> </span><span class="crayon-v">xxx</span><span class="crayon-sy">.</span><span class="crayon-v">xxx</span><span class="crayon-sy">.</span><span class="crayon-v">xxx</span><span class="crayon-sy">.</span><span class="crayon-e">xxx</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-e">smtp </span><span class="crayon-v">server</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105bca6181367143410-2">&nbsp;</div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0002 seconds] -->
<p></p>
<p>I fiddled some more and in my confounding, located some <code>Relay access denied</code> errors from <code>postfix</code> in the <code>mail.log</code>. Various searches told me to update my <code>postfix</code> <code>main.cf</code> with a key that is not used for my version of <code>postfix</code>. This was not particularly helpful advice, but I figured from the <code>ossec-maild</code> error above that <code>OSSEC</code> must be going out to the internet and back to reach my SMTP server and external entities must be authorised correctly to send mail in this way. To fix this, I just updated the <code>smtp_server</code> value in the <code>global</code> <code>OSSEC</code> configuration to <code>localhost</code>:</p>
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-64f105bca6183996463401" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea  class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
&lt;ossec_config&gt;
  &lt;global&gt;
    &lt;email_notification&gt;yes&lt;/email_notification&gt;
    &lt;email_to&gt;someone@example.org&lt;/email_to&gt;
    &lt;smtp_server&gt;localhost&lt;/smtp_server&gt;
    &lt;email_from&gt;ossecm@example.org&lt;/email_from&gt;
  &lt;/global&gt;
...</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-64f105bca6183996463401-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105bca6183996463401-2">2</div><div class="crayon-num" data-line="crayon-64f105bca6183996463401-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105bca6183996463401-4">4</div><div class="crayon-num crayon-marked-num crayon-top crayon-bottom" data-line="crayon-64f105bca6183996463401-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105bca6183996463401-6">6</div><div class="crayon-num" data-line="crayon-64f105bca6183996463401-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105bca6183996463401-8">8</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-64f105bca6183996463401-1"><span class="crayon-o">&lt;</span><span class="crayon-v">ossec_config</span><span class="crayon-o">&gt;</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105bca6183996463401-2"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-o">&lt;</span><span class="crayon-m">global</span><span class="crayon-o">&gt;</span></div><div class="crayon-line" id="crayon-64f105bca6183996463401-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-o">&lt;</span><span class="crayon-v">email_notification</span><span class="crayon-o">&gt;</span><span class="crayon-v">yes</span><span class="crayon-o">&lt;</span><span class="crayon-o">/</span><span class="crayon-v">email_notification</span><span class="crayon-o">&gt;</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105bca6183996463401-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-o">&lt;</span><span class="crayon-v">email_to</span><span class="crayon-o">&gt;</span><span class="crayon-v">someone</span><span class="crayon-sy">@</span><span class="crayon-v">example</span><span class="crayon-sy">.</span><span class="crayon-v">org</span><span class="crayon-o">&lt;</span><span class="crayon-o">/</span><span class="crayon-v">email_to</span><span class="crayon-o">&gt;</span></div><div class="crayon-line crayon-marked-line crayon-top crayon-bottom" id="crayon-64f105bca6183996463401-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-o">&lt;</span><span class="crayon-v">smtp_server</span><span class="crayon-o">&gt;</span><span class="crayon-v">localhost</span><span class="crayon-o">&lt;</span><span class="crayon-o">/</span><span class="crayon-v">smtp_server</span><span class="crayon-o">&gt;</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105bca6183996463401-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-o">&lt;</span><span class="crayon-v">email_from</span><span class="crayon-o">&gt;</span><span class="crayon-v">ossecm</span><span class="crayon-sy">@</span><span class="crayon-v">example</span><span class="crayon-sy">.</span><span class="crayon-v">org</span><span class="crayon-o">&lt;</span><span class="crayon-o">/</span><span class="crayon-v">email_from</span><span class="crayon-o">&gt;</span></div><div class="crayon-line" id="crayon-64f105bca6183996463401-7"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-o">&lt;</span><span class="crayon-o">/</span><span class="crayon-m">global</span><span class="crayon-o">&gt;</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105bca6183996463401-8"><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0004 seconds] -->
<p></p>
<h3>Deny traffic to xmlrpc.php entirely</h3>
<p>WordPress provides an auxiliary script, <code>xmlrpc.php</code> which allows external entities to contact your WordPress instance over the <code>XML-RPC</code> protocol. This is typically used for processing pingbacks (a feature of WordPress where one blog can notify another that one of its posts has been mentioned), via the <a href="https://codex.wordpress.org/XML-RPC_Pingback_API">XML-RPC pingback API</a>, but the script <a href="https://codex.wordpress.org/XML-RPC_Support">also supports a WordPress API</a> that can be used to create new posts and the like. For me, I don&#8217;t particularly care about pingback notifications and so can mitigate this attack in future entirely by denying access to the file in question in the <code>apache</code> <code>VirtualHost</code> in question:</p>
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-64f105bca6186107192258" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea  class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
&lt;VirtualHost&gt;
...
    &lt;files xmlrpc.php&gt;
        order allow,deny
        deny from all
    &lt;/files&gt;
&lt;/VirtualHost&gt;</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-64f105bca6186107192258-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105bca6186107192258-2">2</div><div class="crayon-num crayon-marked-num crayon-top" data-line="crayon-64f105bca6186107192258-3">3</div><div class="crayon-num crayon-marked-num crayon-striped-num" data-line="crayon-64f105bca6186107192258-4">4</div><div class="crayon-num crayon-marked-num" data-line="crayon-64f105bca6186107192258-5">5</div><div class="crayon-num crayon-marked-num crayon-bottom crayon-striped-num" data-line="crayon-64f105bca6186107192258-6">6</div><div class="crayon-num" data-line="crayon-64f105bca6186107192258-7">7</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-64f105bca6186107192258-1"><span class="crayon-o">&lt;</span><span class="crayon-v">VirtualHost</span><span class="crayon-o">&gt;</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105bca6186107192258-2"><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span></div><div class="crayon-line crayon-marked-line crayon-top" id="crayon-64f105bca6186107192258-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-o">&lt;</span><span class="crayon-e">files </span><span class="crayon-v">xmlrpc</span><span class="crayon-sy">.</span><span class="crayon-v">php</span><span class="crayon-o">&gt;</span></div><div class="crayon-line crayon-marked-line crayon-striped-line" id="crayon-64f105bca6186107192258-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">order </span><span class="crayon-v">allow</span><span class="crayon-sy">,</span><span class="crayon-e">deny</span></div><div class="crayon-line crayon-marked-line" id="crayon-64f105bca6186107192258-5"><span class="crayon-e">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">deny </span><span class="crayon-e">from </span><span class="crayon-v">all</span></div><div class="crayon-line crayon-marked-line crayon-bottom crayon-striped-line" id="crayon-64f105bca6186107192258-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-o">&lt;</span><span class="crayon-o">/</span><span class="crayon-v">files</span><span class="crayon-o">&gt;</span></div><div class="crayon-line" id="crayon-64f105bca6186107192258-7"><span class="crayon-o">&lt;</span><span class="crayon-o">/</span><span class="crayon-v">VirtualHost</span><span class="crayon-o">&gt;</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0002 seconds] -->
<p></p>
<hr>
<p><a name="tldr"></a></p>
<h1>tl;dr</h1>
<h3>Timeline</h3>
<ul>
<li><code>1557 (+0'00")</code>: POSTs aimed at <code>xmlrpc.php</code> for two WordPress <code>VirtualHost</code> begin</li>
<li><code>1624 (+0'27")</code>: <code>mysqld</code> terminated by OOM killer</li>
<li><code>1625 (+0'28")</code>: <code>OSSEC</code> Level 12 Notification sent</li>
<li><code>1625 (+0'28")</code>: <code>mysqld</code> respawns but attack persists</li>
<li><code>1635 (+0'38")</code>: <code>mysqld</code> terminated by OOM killer</li>
<li><code>1636 (+0'39")</code>: <code>mysqld</code> respawns</li>
<li><code>1700 (+1'03")</code>: <code>OSSEC</code> Level 12 Notification sent</li>
<li><code>1703 (+1'06")</code>: <code>mysqld</code> terminated by OOM killer</li>
<li><code>1713 (+1'16")</code>: Disk IO 2-Hour anomaly notification sent from Linode</li>
<li><code>1713 (+1'16")</code>: Linode notification <code>X-Received</code> and acknowledged by out of office sysop</li>
<li><code>1835 (+2'38")</code>: Sysop login, <code>netdata</code> accessed </li>
<li><code>1837 (+2'40")</code>: <code>mysqld</code> terminated by OOM killer, error during respawn</li>
<li><code>1839 (+2'42")</code>: <code>iptables</code> updated to drop traffic from IPs, attack is halted briefly</li>
<li><code>1840 (+2'43")</code>: Attack continues from new IP, <code>iptables</code> updated to drop traffic from block</li>
<li><code>1841 (+2'44")</code>: Attack halted, load returns to normal,  <code>mysqld</code> service restarted</li>
<li><code>1842 (+2'45")</code>: All <code>OSSEC</code> notifications <code>X-Received</code> after poll from server</li>
</ul>
<h3>Attacker</h3>
<ul>
<li><code>POST</code> requests originate from IPs in an assigned <code>/24</code> block</li>
<li><code>whois</code> record served by LACNIC (Latin America and Caribbean NIC) </li>
<li>Owner company appears to be an &#8220;Offshore VPS Provider&#8221;</li>
<li>Owner address and phone number based in Seychelles</li>
<li>Owner website served via CloudFlare</li>
<li>GeoIP database places attacker addresses in Chile (or Moscow)</li>
<li><code>traceroute</code> shows the connection is located in Amsterdam (10ms away from <code>vlan3557.bb1.ams2.nl.m24</code>) &#8211; this is particularly amusing considering the <code>whois</code> owner is an &#8220;offshore VPS provider&#8221;, though it could easily be tunneled via Amsterdam</li>
</ul>
<h3>Suspected Purpose</h3>
<ul>
<li>Spam: Attacker potentially attempting to create false pingbacks (to link to their websites) or forge posts on the WordPress blogs in question</li>
<li>Scan hit-and-run: Scan yielded two <code>xmlrpc.php</code> endpoints that could be abused for automatic DOS </li>
</ul>
<h3>Impact</h3>
<ul>
<li>Intermittent <code>apache</code> stability for ~3 hours</li>
<li>Full service denial of <code>mysql</code> for ~2.25 hours</li>
<li>Intermittent disruption to email for ~2 hours</li>
</ul>
<h3>Failures</h3>
<ul>
<li>No monitoring or responsive control configured for high levels of requests to <code>apache</code></li>
<li><code>OSSEC</code> configured to deliver notifications to non-primary address causing messages that would have prompted action much sooner to not arrive within actionable timeframe</li>
<li>Failed to recognise (or consider) disk I/O anomaly message as a red herring for something more serious</li>
<li>Forgetting that the attack surface for WordPress is always bigger than you think</li>
</ul>
<h3>Positives</h3>
<ul>
<li>Recently installed <a href="https://github.com/firehol/netdata"><code>netdata</code></a> instance immediately helped narrow the cause down to <code>apache</code> based activity</li>
<li>Attack mitigated in less than five minutes once I actually got to my desk</li>
</ul>
<h3>Mitigations</h3>
<ul>
<li><code>OSSEC</code> reconfigured to send notifications to an account that does not need to poll from POP3 intermittently</li>
<li>Added simple <code>GET</code> and <code>POST</code> jails to <code>fail2ban</code> configuration to try and mitigate such attacks automatically in future</li>
<li>Drop traffic to offending WordPress script to reduce attack surface</li>
<li>Develop a check list to be followed after receipt of an anomaly notification</li>
<li>Develop a healthy paranoia against people who are out to get you and be inside your computer (or make it fall over)</li>
<li>Moan about WordPress</li>
</ul>
<h3>Mitigation Tips and Gotcha&#8217;s</h3>
<ul>
<li>Set your <code>OSSEC</code> notification <code>smtp_server</code> to <code>localhost</code> to bypass <code>relay access denied</code> errors</li>
<li>Make use of <code>fail2ban-regex &lt;log&gt; &lt;filter&gt;</code> to test your jails</li>
<li>NEVER use <code>#</code> for inline comments in <code>fail2ban</code> configurations, the entire line is ignored</li>
<li>If you are protecting yourself from <code>GET</code> attacks, have you forgotten <code>POST</code>?</li>
</ul>
</div>
                
                        <div class="tag-well"><span><span class="fa fa-tags"></span>&nbsp;&nbsp; <a href="https://samnicholls.net/tag/apache/" rel="tag">apache</a>,&nbsp; <a href="https://samnicholls.net/tag/apache2/" rel="tag">apache2</a>,&nbsp; <a href="https://samnicholls.net/tag/attack/" rel="tag">attack</a>,&nbsp; <a href="https://samnicholls.net/tag/config/" rel="tag">config</a>,&nbsp; <a href="https://samnicholls.net/tag/ddos/" rel="tag">ddos</a>,&nbsp; <a href="https://samnicholls.net/tag/dos/" rel="tag">dos</a>,&nbsp; <a href="https://samnicholls.net/tag/fail2ban/" rel="tag">fail2ban</a>,&nbsp; <a href="https://samnicholls.net/tag/fail2ban-regex/" rel="tag">fail2ban-regex</a>,&nbsp; <a href="https://samnicholls.net/tag/http-get-dos/" rel="tag">http-get-dos</a>,&nbsp; <a href="https://samnicholls.net/tag/jail-conf/" rel="tag">jail.conf</a>,&nbsp; <a href="https://samnicholls.net/tag/ossec/" rel="tag">ossec</a>,&nbsp; <a href="https://samnicholls.net/tag/security/" rel="tag">security</a>,&nbsp; <a href="https://samnicholls.net/tag/xmlrpc/" rel="tag">xmlrpc</a></span></div>
                
                <nav class="further-reading">
	<div class="previous">
		<span>Previous Post</span>
		<a href="https://samnicholls.net/2016/04/05/pubeng/">&#8220;It&#8217;s tough, this public engagement thing.&#8221;</a>
	</div>
	<div class="next">
		<span>Next Post</span>
		<a href="https://samnicholls.net/2016/06/12/status-may16/">Status Report: May 2016 (Metahaplomes: The graph that isn&#8217;t)</a>
	</div>
</nav>            </article>
                                <div class="card">

<div id="disqus_thread"></div>
                </div>
    
</section>

        <!-- Sidebar -->
        <aside class="col-md-4 sidebar-container">
		            <div id="widget-area" class="widget-area" role="complementary">
                <div id="custom_html-3" class="widget_text card widget widget_custom_html"><div class="textwidget custom-html-widget"><img src="https://pbs.twimg.com/profile_images/1044255545610436609/wt33ZbtU_400x400.jpg" height=120 style="margin-top: 20px; margin-right:10px; float: left;" alt="Sam Nicholls" />
<div style="padding-top:15px; line-height: normal"><b style="font-size: 1.2em">Sam Nicholls</b><br><span style="font-size: 0.9em;">Haplotype Wrangler at University of Birmingham.<br>I tell computers to do things, then I write about how it all went wrong.</span></div></div></div><div id="search-2" class="card widget widget_search"><form style="margin-top:15px" action="https://samnicholls.net/" id="searchform" method="get" role="form">
    <div class="form-group">
        <input type="text" class="form-control" name="s" id="s" placeholder="e.g. Search...">
    </div>
</form>
</div><div id="twitter_timeline-5" class="card widget widget_twitter_timeline"><a class="twitter-timeline" data-height="400" data-theme="light" data-link-color="#f96e5b" data-border-color="#e8e8e8" data-lang="EN" data-partner="jetpack" data-chrome="noheader nofooter noborders" href="https://twitter.com/samstudio8">My Tweets</a></div><div id="categories-5" class="card widget widget_categories"><h2>Categories</h2>
			<ul>
					<li class="cat-item cat-item-2"><a href="https://samnicholls.net/category/bioinf/">Bioinformatics</a>
<ul class='children'>
	<li class="cat-item cat-item-8"><a href="https://samnicholls.net/category/bioinf/au-phd/">AU-PhD</a>
</li>
	<li class="cat-item cat-item-3"><a href="https://samnicholls.net/category/bioinf/sanger-qc/" title="Sanger QC Project">Sanger-QC</a>
</li>
	<li class="cat-item cat-item-61"><a href="https://samnicholls.net/category/bioinf/tools/">Tools</a>
	<ul class='children'>
	<li class="cat-item cat-item-185"><a href="https://samnicholls.net/category/bioinf/tools/chitin/">chitin</a>
</li>
	</ul>
</li>
</ul>
</li>
	<li class="cat-item cat-item-80"><a href="https://samnicholls.net/category/devops/">Devops</a>
</li>
	<li class="cat-item cat-item-114"><a href="https://samnicholls.net/category/event/">Event</a>
</li>
	<li class="cat-item cat-item-21"><a href="https://samnicholls.net/category/gadgets/">Gadgets</a>
</li>
	<li class="cat-item cat-item-176"><a href="https://samnicholls.net/category/hardware/">Hardware</a>
<ul class='children'>
	<li class="cat-item cat-item-223"><a href="https://samnicholls.net/category/hardware/beehive-monitor/">Beehive Monitor</a>
</li>
	<li class="cat-item cat-item-178"><a href="https://samnicholls.net/category/hardware/esp8266/">ESP8266</a>
</li>
	<li class="cat-item cat-item-236"><a href="https://samnicholls.net/category/hardware/lego-sequencer/">Lego Sequencer</a>
</li>
	<li class="cat-item cat-item-177"><a href="https://samnicholls.net/category/hardware/lightstick/">Lightstick</a>
</li>
</ul>
</li>
	<li class="cat-item cat-item-151"><a href="https://samnicholls.net/category/lab/">Lab</a>
<ul class='children'>
	<li class="cat-item cat-item-150"><a href="https://samnicholls.net/category/lab/protocol-guides/">Protocol Guides</a>
</li>
</ul>
</li>
	<li class="cat-item cat-item-5"><a href="https://samnicholls.net/category/meta/">Meta</a>
</li>
	<li class="cat-item cat-item-62"><a href="https://samnicholls.net/category/mysteries/">Mysteries</a>
</li>
	<li class="cat-item cat-item-22"><a href="https://samnicholls.net/category/personal/">Personal</a>
</li>
	<li class="cat-item cat-item-4"><a href="https://samnicholls.net/category/photo/">Photography</a>
</li>
	<li class="cat-item cat-item-143"><a href="https://samnicholls.net/category/programming/">Programming</a>
<ul class='children'>
	<li class="cat-item cat-item-145"><a href="https://samnicholls.net/category/programming/documentation/">Documentation</a>
</li>
	<li class="cat-item cat-item-144"><a href="https://samnicholls.net/category/programming/python/">Python</a>
</li>
</ul>
</li>
	<li class="cat-item cat-item-48"><a href="https://samnicholls.net/category/status-report/">Status Report</a>
</li>
	<li class="cat-item cat-item-60"><a href="https://samnicholls.net/category/sysadm/">System Administration</a>
</li>
	<li class="cat-item cat-item-1"><a href="https://samnicholls.net/category/uncategorised/">Uncategorised</a>
</li>
			</ul>

			</div>            </div>
		        </aside>
    </div>

</div> <!-- /container -->

<footer id="main-footer" class="bg-primary">
	<div id="footer-widgets" class="container">
		    </div>
</footer>



	<div style="display:none">
	</div>
<script type='text/javascript' src='https://samnicholls.net/wp-includes/js/comment-reply.min.js?ver=5.7.5' id='comment-reply-js'></script>
<script type='text/javascript' id='disqus_count-js-extra'>
/* <![CDATA[ */
var countVars = {"disqusShortname":"samposium-blog"};
/* ]]> */
</script>
<script type='text/javascript' src='https://samnicholls.net/wp-content/plugins/disqus-comment-system/public/js/comment_count.js?ver=3.0.17' id='disqus_count-js'></script>
<script type='text/javascript' id='disqus_embed-js-extra'>
/* <![CDATA[ */
var embedVars = {"disqusConfig":{"integration":"wordpress 3.0.17"},"disqusIdentifier":"745 https:\/\/samnicholls.net\/?p=745","disqusShortname":"samposium-blog","disqusTitle":"Using fail2ban to mitigate simple DOS attacks against apache (or why I am a terrible sysop)","disqusUrl":"https:\/\/samnicholls.net\/2016\/06\/06\/fail2ban-apache-dos\/","postId":"745"};
/* ]]> */
</script>
<script type='text/javascript' src='https://samnicholls.net/wp-content/plugins/disqus-comment-system/public/js/comment_embed.js?ver=3.0.17' id='disqus_embed-js'></script>
<script type='text/javascript' src='https://s0.wp.com/wp-content/js/devicepx-jetpack.js?ver=202335' id='devicepx-js'></script>
<script type='text/javascript' src='https://samnicholls.net/wp-content/plugins/jetpack/_inc/twitter-timeline.js?ver=4.0.0' id='jetpack-twitter-timeline-js'></script>
<script type='text/javascript' src='https://samnicholls.net/wp-includes/js/wp-embed.min.js?ver=5.7.5' id='wp-embed-js'></script>
<script type='text/javascript' src='https://stats.wp.com/e-202335.js' async defer></script>
<script type='text/javascript'>
	_stq = window._stq || [];
	_stq.push([ 'view', {v:'ext',j:'1:4.9',blog:'101350222',post:'745',tz:'1',srv:'samnicholls.net'} ]);
	_stq.push([ 'clickTrackerInit', '101350222', '745' ]);
</script>

<script type="text/javascript">
(function() {
  if (navigator.userAgent.match(/IEMobile\/10\.0/)) {
    var msViewportStyle = document.createElement("style");
    msViewportStyle.appendChild(
      document.createTextNode("@-ms-viewport{width:auto!important}")
    );
    document.getElementsByTagName("head")[0].appendChild(msViewportStyle);
  }
})();

var collapsed = false;
jQuery( document ).ready(function($) {
    $('.navbar-toggle').click(function(){
        console.log(collapsed);
        if(collapsed) {
            $('.navbar-header > button').html('<i class="fa fa-bars"></i>');
        } else {
            $('.navbar-header > button').html('<i class="fa fa-times"></i>');
        }
        $('.navbar-collapse').toggle(200);
        collapsed = !collapsed;
    });
});
</script>
	
</body>

</html>
