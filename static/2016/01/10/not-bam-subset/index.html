<!DOCTYPE html>
<html lang="en-GB">

<head>
	<meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="pingback" href="https://samnicholls.net/xmlrpc.php">

	
	<title>How (not) to subset a BAM for GATK &#8211; Samposium</title>
<meta name='robots' content='max-image-preview:large' />
<link rel='dns-prefetch' href='//s0.wp.com' />
<link rel='dns-prefetch' href='//fonts.googleapis.com' />
<link rel='dns-prefetch' href='//s.w.org' />
<link rel="alternate" type="application/rss+xml" title="Samposium &raquo; Feed" href="https://samnicholls.net/feed/" />
<link rel="alternate" type="application/rss+xml" title="Samposium &raquo; Comments Feed" href="https://samnicholls.net/comments/feed/" />
<link rel="alternate" type="application/rss+xml" title="Samposium &raquo; How (not) to subset a BAM for GATK Comments Feed" href="https://samnicholls.net/2016/01/10/not-bam-subset/feed/" />
		<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/13.0.1\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/13.0.1\/svg\/","svgExt":".svg","source":{"concatemoji":"https:\/\/samnicholls.net\/wp-includes\/js\/wp-emoji-release.min.js?ver=5.7.5"}};
			!function(e,a,t){var n,r,o,i=a.createElement("canvas"),p=i.getContext&&i.getContext("2d");function s(e,t){var a=String.fromCharCode;p.clearRect(0,0,i.width,i.height),p.fillText(a.apply(this,e),0,0);e=i.toDataURL();return p.clearRect(0,0,i.width,i.height),p.fillText(a.apply(this,t),0,0),e===i.toDataURL()}function c(e){var t=a.createElement("script");t.src=e,t.defer=t.type="text/javascript",a.getElementsByTagName("head")[0].appendChild(t)}for(o=Array("flag","emoji"),t.supports={everything:!0,everythingExceptFlag:!0},r=0;r<o.length;r++)t.supports[o[r]]=function(e){if(!p||!p.fillText)return!1;switch(p.textBaseline="top",p.font="600 32px Arial",e){case"flag":return s([127987,65039,8205,9895,65039],[127987,65039,8203,9895,65039])?!1:!s([55356,56826,55356,56819],[55356,56826,8203,55356,56819])&&!s([55356,57332,56128,56423,56128,56418,56128,56421,56128,56430,56128,56423,56128,56447],[55356,57332,8203,56128,56423,8203,56128,56418,8203,56128,56421,8203,56128,56430,8203,56128,56423,8203,56128,56447]);case"emoji":return!s([55357,56424,8205,55356,57212],[55357,56424,8203,55356,57212])}return!1}(o[r]),t.supports.everything=t.supports.everything&&t.supports[o[r]],"flag"!==o[r]&&(t.supports.everythingExceptFlag=t.supports.everythingExceptFlag&&t.supports[o[r]]);t.supports.everythingExceptFlag=t.supports.everythingExceptFlag&&!t.supports.flag,t.DOMReady=!1,t.readyCallback=function(){t.DOMReady=!0},t.supports.everything||(n=function(){t.readyCallback()},a.addEventListener?(a.addEventListener("DOMContentLoaded",n,!1),e.addEventListener("load",n,!1)):(e.attachEvent("onload",n),a.attachEvent("onreadystatechange",function(){"complete"===a.readyState&&t.readyCallback()})),(n=t.source||{}).concatemoji?c(n.concatemoji):n.wpemoji&&n.twemoji&&(c(n.twemoji),c(n.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
	<link rel='stylesheet' id='crayon-css'  href='https://samnicholls.net/wp-content/plugins/crayon-syntax-highlighter/css/min/crayon.min.css?ver=_2.7.2_beta' type='text/css' media='all' />
<link rel='stylesheet' id='crayon-theme-github-css'  href='https://samnicholls.net/wp-content/plugins/crayon-syntax-highlighter/themes/github/github.css?ver=_2.7.2_beta' type='text/css' media='all' />
<link rel='stylesheet' id='crayon-font-monaco-css'  href='https://samnicholls.net/wp-content/plugins/crayon-syntax-highlighter/fonts/monaco.css?ver=_2.7.2_beta' type='text/css' media='all' />
<link rel='stylesheet' id='wp-block-library-css'  href='https://samnicholls.net/wp-includes/css/dist/block-library/style.min.css?ver=5.7.5' type='text/css' media='all' />
<link rel='stylesheet' id='css-style-css'  href='https://samnicholls.net/wp-content/themes/responsive-deluxe/css/style.css?ver=5.7.5' type='text/css' media='all' />
<link rel='stylesheet' id='child-style-css'  href='https://samnicholls.net/wp-content/themes/responsive-deluxe-child/style.css?ver=5.7.5' type='text/css' media='all' />
<link rel='stylesheet' id='lato-css'  href='//fonts.googleapis.com/css?family=Lato%3A400%2C700%2C400italic&#038;ver=5.7.5' type='text/css' media='all' />
<link rel='stylesheet' id='slabo-css'  href='//fonts.googleapis.com/css?family=Slabo+27px&#038;ver=5.7.5' type='text/css' media='all' />
<link rel='stylesheet' id='fa-css'  href='https://samnicholls.net/wp-content/themes/responsive-deluxe/css/font-awesome.css?ver=5.7.5' type='text/css' media='all' />
<link rel='stylesheet' id='rd-style-css'  href='https://samnicholls.net/wp-content/themes/responsive-deluxe-child/style.css?ver=5.7.5' type='text/css' media='all' />
<link rel='stylesheet' id='css-custom-css'  href='https://samnicholls.net/wp-content/themes/responsive-deluxe/css/custom.css?ver=5.7.5' type='text/css' media='all' />
<link rel='stylesheet' id='jetpack_css-css'  href='https://samnicholls.net/wp-content/plugins/jetpack/css/jetpack.css?ver=4.9' type='text/css' media='all' />
<script type='text/javascript' src='https://samnicholls.net/wp-includes/js/jquery/jquery.min.js?ver=3.5.1' id='jquery-core-js'></script>
<script type='text/javascript' src='https://samnicholls.net/wp-includes/js/jquery/jquery-migrate.min.js?ver=3.3.2' id='jquery-migrate-js'></script>
<script type='text/javascript' id='crayon_js-js-extra'>
/* <![CDATA[ */
var CrayonSyntaxSettings = {"version":"_2.7.2_beta","is_admin":"0","ajaxurl":"https:\/\/samnicholls.net\/wp-admin\/admin-ajax.php","prefix":"crayon-","setting":"crayon-setting","selected":"crayon-setting-selected","changed":"crayon-setting-changed","special":"crayon-setting-special","orig_value":"data-orig-value","debug":""};
var CrayonSyntaxStrings = {"copy":"Press %s to Copy, %s to Paste","minimize":"Click To Expand Code"};
/* ]]> */
</script>
<script type='text/javascript' src='https://samnicholls.net/wp-content/plugins/crayon-syntax-highlighter/js/min/crayon.min.js?ver=_2.7.2_beta' id='crayon_js-js'></script>
<script type='text/javascript' src='https://samnicholls.net/wp-content/plugins/fd-footnotes/fdfootnotes.js?ver=1.34' id='fdfootnote_script-js'></script>
<script type='text/javascript' src='https://samnicholls.net/wp-content/themes/responsive-deluxe/js/bootstrap.js?ver=5.7.5' id='bootstrap-js'></script>
<script type='text/javascript' src='https://samnicholls.net/wp-content/themes/responsive-deluxe/js/custom.js?ver=5.7.5' id='js-custom-js'></script>
<link rel="https://api.w.org/" href="https://samnicholls.net/wp-json/" /><link rel="alternate" type="application/json" href="https://samnicholls.net/wp-json/wp/v2/posts/385" /><link rel="EditURI" type="application/rsd+xml" title="RSD" href="https://samnicholls.net/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="https://samnicholls.net/wp-includes/wlwmanifest.xml" /> 
<meta name="generator" content="WordPress 5.7.5" />
<link rel="canonical" href="https://samnicholls.net/2016/01/10/not-bam-subset/" />
<link rel='shortlink' href='https://wp.me/p6RfP0-6d' />
<link rel="alternate" type="application/json+oembed" href="https://samnicholls.net/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fsamnicholls.net%2F2016%2F01%2F10%2Fnot-bam-subset%2F" />
<link rel="alternate" type="text/xml+oembed" href="https://samnicholls.net/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fsamnicholls.net%2F2016%2F01%2F10%2Fnot-bam-subset%2F&#038;format=xml" />
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-62206786-1', 'auto');
  ga('send', 'pageview');

</script>


<link rel='dns-prefetch' href='//v0.wordpress.com'>
<style type='text/css'>img#wpstats{display:none}</style>
<!-- Jetpack Open Graph Tags -->
<meta property="og:type" content="article" />
<meta property="og:title" content="How (not) to subset a BAM for GATK" />
<meta property="og:url" content="https://samnicholls.net/2016/01/10/not-bam-subset/" />
<meta property="og:description" content="I wanted a BAM that contained reads aligned to just one of the many contigs the file contained. As usual, I made this much more difficult than it really ought to have been." />
<meta property="article:published_time" content="2016-01-10T22:28:40+00:00" />
<meta property="article:modified_time" content="2018-07-29T15:17:25+00:00" />
<meta property="og:site_name" content="Samposium" />
<meta property="og:image" content="https://s0.wp.com/i/blank.jpg" />
<meta property="og:locale" content="en_GB" />
<meta name="twitter:card" content="summary" />
</head>

<body class="post-template-default single single-post postid-385 single-format-standard">


        
<header id="main-header">
    <nav class="navbar-default navbar-static-top navbar" role="navigation">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#rd-collapse">
                    <span class="fa fa-bars"></span>
                    <span class="sr-only screen-reader-text">Toggle navigation</span>
                </button>
                <a class="navbar-brand" href=" https://samnicholls.net/">Samposium</a>            </div>
            
            <div id="rd-collapse" class="collapse navbar-collapse">
            
            <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<html><body class="post-template-default single single-post postid-385 single-format-standard">

<div id="main-menu" class="navbar-nav nav"><ul>
<li class="page_item page-item-8"><a href="https://samnicholls.net/about/">About Me</a></li>
<li class="page_item page-item-11"><a href="https://samnicholls.net/talks/">Talks</a></li>
<li class="page_item page-item-15"><a href="https://samnicholls.net/things-i-have-learned/">Things I Have Learned</a></li>
</ul></div></body></html>
        </div>

        </div>
    </nav>
</header>

<div class="container">

    <div class="row"><!-- Content -->
<section class="col-md-8 content-container">
                          <article class="card post hentry post-385 type-post status-publish format-standard category-tools tag-bam tag-extract tag-gatk tag-intervals tag-pitfalls tag-pysam tag-rtfm tag-subset" id="post-385">
                <header class="entry-header">
                        <h1 class="entry-title">How (not) to subset a BAM for GATK</h1>                </header><!-- .entry-header -->

                <div class="meta-well">
                    <span style="margin-right:15px;" class=""><span class="fa fa-user"></span>&nbsp;&nbsp;&nbsp;<span class="author vcard"><a class="url fn n" href="https://samnicholls.net/about/">Sam Nicholls</a></span></span>

                    <span style="margin-right:15px;" class="entry-date published updated post-date"><span class="fa fa-clock-o"></span>&nbsp;&nbsp; <time class="entry-date published" datetime="2016-01-10T22:28:40+00:00">10th January 2016</time><time class="updated" datetime="2018-07-29T16:17:25+01:00">29th July 2018</time></span>                    <span style="margin-right:15px;" class=""><span class="fa fa-comments-o"></span>&nbsp;&nbsp; <a href="https://samnicholls.net/2016/01/10/not-bam-subset/#respond"><span class="dsq-postid" data-dsqidentifier="385 https://samnicholls.net/?p=385">No Comments yet</span></a></span>
                    <span class=""><span class="fa fa-folder-open"></span>&nbsp;&nbsp;&nbsp;<a href="https://samnicholls.net/category/bioinf/tools/" rel="category tag">Tools</a></span>
                </div>

                <div class="entry-content"><p>I wanted a BAM that contained reads aligned to just one of the many contigs the file contained. As usual, I made this much more difficult than it really ought to have been.</p>
<div class="message">This post takes a little look at manually handling BAM files with <code>pysam</code> and perhaps why it was not a good idea for the use case in question. For those who really just want to subset a BAM without the lesson, <a href="#correct">skip ahead</a>, or consult some <a href="https://www.broadinstitute.org/gatk/gatkdocs/org_broadinstitute_gatk_engine_CommandLineGATK.php#--intervals">appropriate documentation</a>.</div>
<h2>Wasting time with <code>RealignerTargetCreator</code>, large SQ headers and sparse BAMs</h2>
<p>I began by first pulling out the reads associated with a specific contig of interest and writing them to a new BAM with <a href="https://pysam.readthedocs.org/en/latest/"><code>pysam</code> (a htslib interface wrapper for Python)</a>. For a header, I prepended the original superset BAM&#8217;s header to the result by setting the <code>template</code> parameter to the new <code>AlignmentFile</code> constructor to the name of the open &#8220;super&#8221; <code>AlignmentFile</code>:</p>
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-64f105cf0ecea098992537" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea  class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
import pysam

# Open original "super" BAM containing all reads
super_bam = pysam.AlignmentFile("/path/to/my.bam")

# Open a new BAM for writing, using the old header
INTERESTING_CONTIG = "my_contig"
contig_bam = pysam.AlignmentFile(INTERESTING_CONTIG+".lazy.bam", "wb", template=super_bam)

# Write reads on the target contig to new file
for read in super_bam.fetch(INTERESTING_CONTIG):
    contig_bam.write(read)

# Housekeeping
super_bam.close()
contig_bam.close()</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-64f105cf0ecea098992537-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ecea098992537-2">2</div><div class="crayon-num" data-line="crayon-64f105cf0ecea098992537-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ecea098992537-4">4</div><div class="crayon-num" data-line="crayon-64f105cf0ecea098992537-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ecea098992537-6">6</div><div class="crayon-num" data-line="crayon-64f105cf0ecea098992537-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ecea098992537-8">8</div><div class="crayon-num" data-line="crayon-64f105cf0ecea098992537-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ecea098992537-10">10</div><div class="crayon-num" data-line="crayon-64f105cf0ecea098992537-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ecea098992537-12">12</div><div class="crayon-num" data-line="crayon-64f105cf0ecea098992537-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ecea098992537-14">14</div><div class="crayon-num" data-line="crayon-64f105cf0ecea098992537-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ecea098992537-16">16</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-64f105cf0ecea098992537-1"><span class="crayon-e">import </span><span class="crayon-v">pysam</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ecea098992537-2">&nbsp;</div><div class="crayon-line" id="crayon-64f105cf0ecea098992537-3"><span class="crayon-p"># Open original "super" BAM containing all reads</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ecea098992537-4"><span class="crayon-v">super_bam</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">pysam</span><span class="crayon-sy">.</span><span class="crayon-e">AlignmentFile</span><span class="crayon-sy">(</span><span class="crayon-s">"/path/to/my.bam"</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-64f105cf0ecea098992537-5">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ecea098992537-6"><span class="crayon-p"># Open a new BAM for writing, using the old header</span></div><div class="crayon-line" id="crayon-64f105cf0ecea098992537-7"><span class="crayon-v">INTERESTING_CONTIG</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">"my_contig"</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ecea098992537-8"><span class="crayon-v">contig_bam</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">pysam</span><span class="crayon-sy">.</span><span class="crayon-e">AlignmentFile</span><span class="crayon-sy">(</span><span class="crayon-v">INTERESTING_CONTIG</span><span class="crayon-o">+</span><span class="crayon-s">".lazy.bam"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"wb"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">template</span><span class="crayon-o">=</span><span class="crayon-v">super_bam</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-64f105cf0ecea098992537-9">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ecea098992537-10"><span class="crayon-p"># Write reads on the target contig to new file</span></div><div class="crayon-line" id="crayon-64f105cf0ecea098992537-11"><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">read </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">super_bam</span><span class="crayon-sy">.</span><span class="crayon-e">fetch</span><span class="crayon-sy">(</span><span class="crayon-v">INTERESTING_CONTIG</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ecea098992537-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">contig_bam</span><span class="crayon-sy">.</span><span class="crayon-e">write</span><span class="crayon-sy">(</span><span class="crayon-v">read</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-64f105cf0ecea098992537-13">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ecea098992537-14"><span class="crayon-p"># Housekeeping</span></div><div class="crayon-line" id="crayon-64f105cf0ecea098992537-15"><span class="crayon-v">super_bam</span><span class="crayon-sy">.</span><span class="crayon-e">close</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ecea098992537-16"><span class="crayon-v">contig_bam</span><span class="crayon-sy">.</span><span class="crayon-e">close</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0013 seconds] -->
<p></p>
<p>Although the script had extracted a subset of reads on a given contig as desired, I found downstream that GATK was wasting resources &#8211; or more specifically, many hours of my cluster time &#8211; processing the hundreds of thousands of other contigs (<code>@SQ</code> lines) listed in the header, despite there being no reads on those contigs.</p>
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-64f105cf0ecf2435517858" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
INFO  10:28:50,300 GenomeAnalysisEngine - Preparing for traversal over 1 BAM files 
INFO  10:28:51,282 GenomeAnalysisEngine - Done preparing for traversal 
INFO  10:28:51,283 ProgressMeter - [INITIALIZATION COMPLETE; STARTING PROCESSING] 
INFO  10:28:51,285 ProgressMeter -                 | processed |    time |    per 1M |           |   total | remaining 
INFO  10:28:51,285 ProgressMeter -        Location |     sites | elapsed |     sites | completed | runtime |   runtime 
INFO  10:29:21,290 ProgressMeter - NODE_558_length_1188_cov_10.499158:1201     83534.0    30.0 s       6.0 m        0.0%    42.6 h      42.6 h 
INFO  10:30:21,293 ProgressMeter - NODE_1558_length_375_cov_11.621333:401    243207.0    90.0 s       6.2 m        0.1%    44.4 h      44.4 h 
INFO  10:31:21,295 ProgressMeter - NODE_2578_length_1249_cov_7.622097:1201    379570.0     2.5 m       6.6 m        0.1%    47.4 h      47.3 h
[...]
INFO  10:22:06,562 ProgressMeter - NODE_1498866_length_119_cov_4.596639:101   4.32648722E8    47.9 h       6.6 m       99.9%    47.9 h       2.6 m 
INFO  10:23:06,574 ProgressMeter - NODE_1500560_length_51_cov_4.470588:101   4.32851674E8    47.9 h       6.6 m      100.0%    47.9 h      77.0 s 
INFO  10:24:06,584 ProgressMeter - NODE_1502759_length_114_cov_12.587719:101   4.33032727E8    47.9 h       6.6 m      100.0%    47.9 h       5.0 s 
INFO  10:24:11,379 ProgressMeter -            done   4.3304713E8    47.9 h       6.6 m      100.0%    47.9 h       0.0 s 
INFO  10:24:11,381 ProgressMeter - Total runtime 172520.10 secs, 2875.33 min, 47.92 hours</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-64f105cf0ecf2435517858-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ecf2435517858-2">2</div><div class="crayon-num" data-line="crayon-64f105cf0ecf2435517858-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ecf2435517858-4">4</div><div class="crayon-num" data-line="crayon-64f105cf0ecf2435517858-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ecf2435517858-6">6</div><div class="crayon-num" data-line="crayon-64f105cf0ecf2435517858-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ecf2435517858-8">8</div><div class="crayon-num" data-line="crayon-64f105cf0ecf2435517858-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ecf2435517858-10">10</div><div class="crayon-num" data-line="crayon-64f105cf0ecf2435517858-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ecf2435517858-12">12</div><div class="crayon-num" data-line="crayon-64f105cf0ecf2435517858-13">13</div><div class="crayon-num crayon-marked-num crayon-top crayon-bottom crayon-striped-num" data-line="crayon-64f105cf0ecf2435517858-14">14</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-64f105cf0ecf2435517858-1"><span class="crayon-i">INFO</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">10</span><span class="crayon-o">:</span><span class="crayon-cn">28</span><span class="crayon-o">:</span><span class="crayon-cn">50</span><span class="crayon-sy">,</span><span class="crayon-cn">300</span><span class="crayon-h"> </span><span class="crayon-v">GenomeAnalysisEngine</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-e">Preparing </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">traversal </span><span class="crayon-i">over</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-h"> </span><span class="crayon-e">BAM </span><span class="crayon-e">files </span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ecf2435517858-2"><span class="crayon-i">INFO</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">10</span><span class="crayon-o">:</span><span class="crayon-cn">28</span><span class="crayon-o">:</span><span class="crayon-cn">51</span><span class="crayon-sy">,</span><span class="crayon-cn">282</span><span class="crayon-h"> </span><span class="crayon-v">GenomeAnalysisEngine</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-e">Done </span><span class="crayon-e">preparing </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">traversal </span></div><div class="crayon-line" id="crayon-64f105cf0ecf2435517858-3"><span class="crayon-i">INFO</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">10</span><span class="crayon-o">:</span><span class="crayon-cn">28</span><span class="crayon-o">:</span><span class="crayon-cn">51</span><span class="crayon-sy">,</span><span class="crayon-cn">283</span><span class="crayon-h"> </span><span class="crayon-v">ProgressMeter</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-e">INITIALIZATION </span><span class="crayon-v">COMPLETE</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-e">STARTING </span><span class="crayon-v">PROCESSING</span><span class="crayon-sy">]</span><span class="crayon-h"> </span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ecf2435517858-4"><span class="crayon-i">INFO</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">10</span><span class="crayon-o">:</span><span class="crayon-cn">28</span><span class="crayon-o">:</span><span class="crayon-cn">51</span><span class="crayon-sy">,</span><span class="crayon-cn">285</span><span class="crayon-h"> </span><span class="crayon-v">ProgressMeter</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-v">processed</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">time</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-i">per</span><span class="crayon-h"> </span><span class="crayon-cn">1M</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-o">|</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-v">total</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-e">remaining </span></div><div class="crayon-line" id="crayon-64f105cf0ecf2435517858-5"><span class="crayon-i">INFO</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">10</span><span class="crayon-o">:</span><span class="crayon-cn">28</span><span class="crayon-o">:</span><span class="crayon-cn">51</span><span class="crayon-sy">,</span><span class="crayon-cn">285</span><span class="crayon-h"> </span><span class="crayon-v">ProgressMeter</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">Location</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">sites</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-v">elapsed</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">sites</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-v">completed</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-v">runtime</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-e">runtime </span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ecf2435517858-6"><span class="crayon-i">INFO</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">10</span><span class="crayon-o">:</span><span class="crayon-cn">29</span><span class="crayon-o">:</span><span class="crayon-cn">21</span><span class="crayon-sy">,</span><span class="crayon-cn">290</span><span class="crayon-h"> </span><span class="crayon-v">ProgressMeter</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-v">NODE_558_length_1188_cov_10</span><span class="crayon-sy">.</span><span class="crayon-cn">499158</span><span class="crayon-o">:</span><span class="crayon-cn">1201</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-cn">83534.0</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">30.0</span><span class="crayon-h"> </span><span class="crayon-i">s</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-cn">6.0</span><span class="crayon-h"> </span><span class="crayon-i">m</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">0.0</span><span class="crayon-o">%</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">42.6</span><span class="crayon-h"> </span><span class="crayon-i">h</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">42.6</span><span class="crayon-h"> </span><span class="crayon-i">h</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-64f105cf0ecf2435517858-7"><span class="crayon-i">INFO</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">10</span><span class="crayon-o">:</span><span class="crayon-cn">30</span><span class="crayon-o">:</span><span class="crayon-cn">21</span><span class="crayon-sy">,</span><span class="crayon-cn">293</span><span class="crayon-h"> </span><span class="crayon-v">ProgressMeter</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-v">NODE_1558_length_375_cov_11</span><span class="crayon-sy">.</span><span class="crayon-cn">621333</span><span class="crayon-o">:</span><span class="crayon-cn">401</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">243207.0</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">90.0</span><span class="crayon-h"> </span><span class="crayon-i">s</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-cn">6.2</span><span class="crayon-h"> </span><span class="crayon-i">m</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">0.1</span><span class="crayon-o">%</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">44.4</span><span class="crayon-h"> </span><span class="crayon-i">h</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">44.4</span><span class="crayon-h"> </span><span class="crayon-i">h</span><span class="crayon-h"> </span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ecf2435517858-8"><span class="crayon-i">INFO</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">10</span><span class="crayon-o">:</span><span class="crayon-cn">31</span><span class="crayon-o">:</span><span class="crayon-cn">21</span><span class="crayon-sy">,</span><span class="crayon-cn">295</span><span class="crayon-h"> </span><span class="crayon-v">ProgressMeter</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-v">NODE_2578_length_1249_cov_7</span><span class="crayon-sy">.</span><span class="crayon-cn">622097</span><span class="crayon-o">:</span><span class="crayon-cn">1201</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">379570.0</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-cn">2.5</span><span class="crayon-h"> </span><span class="crayon-i">m</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-cn">6.6</span><span class="crayon-h"> </span><span class="crayon-i">m</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">0.1</span><span class="crayon-o">%</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">47.4</span><span class="crayon-h"> </span><span class="crayon-i">h</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">47.3</span><span class="crayon-h"> </span><span class="crayon-i">h</span></div><div class="crayon-line" id="crayon-64f105cf0ecf2435517858-9"><span class="crayon-sy">[</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ecf2435517858-10"><span class="crayon-i">INFO</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">10</span><span class="crayon-o">:</span><span class="crayon-cn">22</span><span class="crayon-o">:</span><span class="crayon-cn">06</span><span class="crayon-sy">,</span><span class="crayon-cn">562</span><span class="crayon-h"> </span><span class="crayon-v">ProgressMeter</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-v">NODE_1498866_length_119_cov_4</span><span class="crayon-sy">.</span><span class="crayon-cn">596639</span><span class="crayon-o">:</span><span class="crayon-cn">101</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">4.32648722E8</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">47.9</span><span class="crayon-h"> </span><span class="crayon-i">h</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-cn">6.6</span><span class="crayon-h"> </span><span class="crayon-i">m</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-cn">99.9</span><span class="crayon-o">%</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">47.9</span><span class="crayon-h"> </span><span class="crayon-i">h</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-cn">2.6</span><span class="crayon-h"> </span><span class="crayon-i">m</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-64f105cf0ecf2435517858-11"><span class="crayon-i">INFO</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">10</span><span class="crayon-o">:</span><span class="crayon-cn">23</span><span class="crayon-o">:</span><span class="crayon-cn">06</span><span class="crayon-sy">,</span><span class="crayon-cn">574</span><span class="crayon-h"> </span><span class="crayon-v">ProgressMeter</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-v">NODE_1500560_length_51_cov_4</span><span class="crayon-sy">.</span><span class="crayon-cn">470588</span><span class="crayon-o">:</span><span class="crayon-cn">101</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">4.32851674E8</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">47.9</span><span class="crayon-h"> </span><span class="crayon-i">h</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-cn">6.6</span><span class="crayon-h"> </span><span class="crayon-i">m</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">100.0</span><span class="crayon-o">%</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">47.9</span><span class="crayon-h"> </span><span class="crayon-i">h</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">77.0</span><span class="crayon-h"> </span><span class="crayon-i">s</span><span class="crayon-h"> </span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ecf2435517858-12"><span class="crayon-i">INFO</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">10</span><span class="crayon-o">:</span><span class="crayon-cn">24</span><span class="crayon-o">:</span><span class="crayon-cn">06</span><span class="crayon-sy">,</span><span class="crayon-cn">584</span><span class="crayon-h"> </span><span class="crayon-v">ProgressMeter</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-v">NODE_1502759_length_114_cov_12</span><span class="crayon-sy">.</span><span class="crayon-cn">587719</span><span class="crayon-o">:</span><span class="crayon-cn">101</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">4.33032727E8</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">47.9</span><span class="crayon-h"> </span><span class="crayon-i">h</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-cn">6.6</span><span class="crayon-h"> </span><span class="crayon-i">m</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">100.0</span><span class="crayon-o">%</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">47.9</span><span class="crayon-h"> </span><span class="crayon-i">h</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-cn">5.0</span><span class="crayon-h"> </span><span class="crayon-i">s</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-64f105cf0ecf2435517858-13"><span class="crayon-i">INFO</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">10</span><span class="crayon-o">:</span><span class="crayon-cn">24</span><span class="crayon-o">:</span><span class="crayon-cn">11</span><span class="crayon-sy">,</span><span class="crayon-cn">379</span><span class="crayon-h"> </span><span class="crayon-v">ProgressMeter</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-i">done</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">4.3304713E8</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">47.9</span><span class="crayon-h"> </span><span class="crayon-i">h</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-cn">6.6</span><span class="crayon-h"> </span><span class="crayon-i">m</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">100.0</span><span class="crayon-o">%</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">47.9</span><span class="crayon-h"> </span><span class="crayon-i">h</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-cn">0.0</span><span class="crayon-h"> </span><span class="crayon-i">s</span><span class="crayon-h"> </span></div><div class="crayon-line crayon-marked-line crayon-top crayon-bottom crayon-striped-line" id="crayon-64f105cf0ecf2435517858-14"><span class="crayon-i">INFO</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">10</span><span class="crayon-o">:</span><span class="crayon-cn">24</span><span class="crayon-o">:</span><span class="crayon-cn">11</span><span class="crayon-sy">,</span><span class="crayon-cn">381</span><span class="crayon-h"> </span><span class="crayon-v">ProgressMeter</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-e">Total </span><span class="crayon-i">runtime</span><span class="crayon-h"> </span><span class="crayon-cn">172520.10</span><span class="crayon-h"> </span><span class="crayon-v">secs</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">2875.33</span><span class="crayon-h"> </span><span class="crayon-v">min</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">47.92</span><span class="crayon-h"> </span><span class="crayon-v">hours</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0026 seconds] -->
<p></p>
<p>Indeed, for the unsure, we can confirm that a small subset of reads were successfully extracted, but the entire header remains.</p>
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-64f105cf0ecf5688225544" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea  class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
$ samtools view -c Limpet-Magda.sorted.bam # The super BAM
365107681

$ samtools view -c NODE_912989_length_238_cov_5.743698.lazy.bam # The new subset BAM
98

$ samtools view -H NODE_912989_length_238_cov_5.743698.lazy.bam | grep -c "^@SQ"
730724</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-64f105cf0ecf5688225544-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ecf5688225544-2">2</div><div class="crayon-num" data-line="crayon-64f105cf0ecf5688225544-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ecf5688225544-4">4</div><div class="crayon-num" data-line="crayon-64f105cf0ecf5688225544-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ecf5688225544-6">6</div><div class="crayon-num" data-line="crayon-64f105cf0ecf5688225544-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ecf5688225544-8">8</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-64f105cf0ecf5688225544-1"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">samtools </span><span class="crayon-v">view</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">c</span><span class="crayon-h"> </span><span class="crayon-v">Limpet</span><span class="crayon-o">-</span><span class="crayon-v">Magda</span><span class="crayon-sy">.</span><span class="crayon-v">sorted</span><span class="crayon-sy">.</span><span class="crayon-v">bam</span><span class="crayon-h"> </span><span class="crayon-p"># The super BAM</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ecf5688225544-2"><span class="crayon-cn">365107681</span></div><div class="crayon-line" id="crayon-64f105cf0ecf5688225544-3">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ecf5688225544-4"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">samtools </span><span class="crayon-v">view</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">c</span><span class="crayon-h"> </span><span class="crayon-v">NODE_912989_length_238_cov_5</span><span class="crayon-sy">.</span><span class="crayon-cn">743698.lazy.bam</span><span class="crayon-h"> </span><span class="crayon-p"># The new subset BAM</span></div><div class="crayon-line" id="crayon-64f105cf0ecf5688225544-5"><span class="crayon-cn">98</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ecf5688225544-6">&nbsp;</div><div class="crayon-line" id="crayon-64f105cf0ecf5688225544-7"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">samtools </span><span class="crayon-v">view</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">H</span><span class="crayon-h"> </span><span class="crayon-v">NODE_912989_length_238_cov_5</span><span class="crayon-sy">.</span><span class="crayon-cn">743698.lazy.bam</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-v">grep</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">c</span><span class="crayon-h"> </span><span class="crayon-s">"^@SQ"</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ecf5688225544-8"><span class="crayon-cn">730724</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0003 seconds] -->
<p></p>
<p>This amortizes to around one read per half hour, at which rate I could probably have done the job myself by hand. Evidently, we&#8217;d need to provide a smaller header of our own.</p>
<h2>Invalidating reads with improper mates</h2>
<p>I went back to my <code>pysam</code> script and stripped out all sequence (<code>@SQ</code>) lines from the resulting header that did not match the single contig of interest, taking care to now set the <code>reference_id</code> and <code>next_reference_id</code> (the read mate) of each read to <code>0</code>: the first and only <code>@SQ</code> line in the new header, our target contig. For reads on the target contig, whose mate was mapped elsewhere, I updated the reference_id to <code>-1</code>: <em>i.e.</em> unmapped. This happened to cause unexpected behaviour downstream, in that I was not expecting everything to be broken:</p>
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-64f105cf0ecf8161860619" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea  class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
Exception in thread "main" htsjdk.samtools.SAMFormatException:
    SAM validation error: ERROR: Record 37, Read name &lt;READ NAME&gt;, Mate Alignment start should be 0 because reference name = *.</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-64f105cf0ecf8161860619-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ecf8161860619-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-64f105cf0ecf8161860619-1"><span class="crayon-e">Exception </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-i">thread</span><span class="crayon-h"> </span><span class="crayon-s">"main"</span><span class="crayon-h"> </span><span class="crayon-v">htsjdk</span><span class="crayon-sy">.</span><span class="crayon-v">samtools</span><span class="crayon-sy">.</span><span class="crayon-v">SAMFormatException</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ecf8161860619-2"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">SAM </span><span class="crayon-e">validation </span><span class="crayon-v">error</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">ERROR</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-i">Record</span><span class="crayon-h"> </span><span class="crayon-cn">37</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">Read </span><span class="crayon-v">name</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-e">READ </span><span class="crayon-v">NAME</span><span class="crayon-o">&gt;</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">Mate </span><span class="crayon-e">Alignment </span><span class="crayon-e">start </span><span class="crayon-e">should </span><span class="crayon-i">be</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-h"> </span><span class="crayon-e">because </span><span class="crayon-e">reference </span><span class="crayon-v">name</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-sy">.</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0003 seconds] -->
<p></p>
<p>It wouldn&#8217;t be until later whilst investigating issues with another tool that I would <a href="https://samnicholls.net/2015/08/27/bridgebuilding-p4/#friends">discover how to correctly update the bit flags and read attributes to mark reads as unmapped</a> as per the BAM specification. But in this instance, the error made me question whether I really wanted to dispose of the information held by reads whose mate appeared on another contig. Figuring this could come in handy later for scaffolding (or just satisfying my curiosity), I needed to find another way to subset the BAM.</p>
<h2>Attempting to read a <code>reference_id</code> greater than the number of SQ lines unsurprisingly causes samtools segmentation fault</h2>
<p>I returned to my hacky script once more. This time, my header was constructed such that it would contain <code>@SQ</code> sequence lines for not only the target contig, but any contig for which reads on the target contig have a mate appearing on too. I did this by discarding the sequence lines that were neither the target contig, or a mate to any reads on the target contig:</p>
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-64f105cf0ecfa592357786" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">Python</span></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea  class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
import pysam

super_bam = pysam.AlignmentFile("/path/to/my.bam")

# Define target contig and fetch its index in the SQ lines
INTERESTING_CONTIG = "my_contig"
INTERESTING_INDEX = super_bam.references.keys().index(INTERESTING_CONTIG)

# Copy the header but truncate the existing SQ lines
header = super_bam.header.copy()
header["SQ"] = []

# Keep a set of required SQ lines indices
# and add the SQ index of the target contig
required_indices = set()
required_indices.add(INTERESTING_INDEX)

# Parse the reads mapped to the target contig and add
# the index of the contig the mate pair appears on
# (if not the target contig, or unmapped)
for read in super_bam.fetch(INTERESTING_CONTIG):
    if read.next_reference_id &gt; 0:
        required_indices.add(read.next_reference_id)

# Populate the new header's SQ lines, extracting the
# original SQ data from the super_bam.header for each
# index harvested from the previous step
for ref_index in required_indices:
    header["SQ"].append( super_bam.header["SQ"][ref_index] )

# Open a new BAM for writing, with your new header
contig_bam = pysam.AlignmentFile("my_new.bam", "wb", header=header)</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-64f105cf0ecfa592357786-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ecfa592357786-2">2</div><div class="crayon-num" data-line="crayon-64f105cf0ecfa592357786-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ecfa592357786-4">4</div><div class="crayon-num" data-line="crayon-64f105cf0ecfa592357786-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ecfa592357786-6">6</div><div class="crayon-num" data-line="crayon-64f105cf0ecfa592357786-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ecfa592357786-8">8</div><div class="crayon-num" data-line="crayon-64f105cf0ecfa592357786-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ecfa592357786-10">10</div><div class="crayon-num" data-line="crayon-64f105cf0ecfa592357786-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ecfa592357786-12">12</div><div class="crayon-num" data-line="crayon-64f105cf0ecfa592357786-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ecfa592357786-14">14</div><div class="crayon-num" data-line="crayon-64f105cf0ecfa592357786-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ecfa592357786-16">16</div><div class="crayon-num" data-line="crayon-64f105cf0ecfa592357786-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ecfa592357786-18">18</div><div class="crayon-num" data-line="crayon-64f105cf0ecfa592357786-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ecfa592357786-20">20</div><div class="crayon-num" data-line="crayon-64f105cf0ecfa592357786-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ecfa592357786-22">22</div><div class="crayon-num" data-line="crayon-64f105cf0ecfa592357786-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ecfa592357786-24">24</div><div class="crayon-num" data-line="crayon-64f105cf0ecfa592357786-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ecfa592357786-26">26</div><div class="crayon-num" data-line="crayon-64f105cf0ecfa592357786-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ecfa592357786-28">28</div><div class="crayon-num" data-line="crayon-64f105cf0ecfa592357786-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ecfa592357786-30">30</div><div class="crayon-num" data-line="crayon-64f105cf0ecfa592357786-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ecfa592357786-32">32</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-64f105cf0ecfa592357786-1"><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-e">pysam</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ecfa592357786-2">&nbsp;</div><div class="crayon-line" id="crayon-64f105cf0ecfa592357786-3"><span class="crayon-v">super_bam</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">pysam</span><span class="crayon-sy">.</span><span class="crayon-e">AlignmentFile</span><span class="crayon-sy">(</span><span class="crayon-s">"/path/to/my.bam"</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ecfa592357786-4">&nbsp;</div><div class="crayon-line" id="crayon-64f105cf0ecfa592357786-5"><span class="crayon-c"># Define target contig and fetch its index in the SQ lines</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ecfa592357786-6"><span class="crayon-v">INTERESTING_CONTIG</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">"my_contig"</span></div><div class="crayon-line" id="crayon-64f105cf0ecfa592357786-7"><span class="crayon-v">INTERESTING_INDEX</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">super_bam</span><span class="crayon-sy">.</span><span class="crayon-v">references</span><span class="crayon-sy">.</span><span class="crayon-e">keys</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">index</span><span class="crayon-sy">(</span><span class="crayon-v">INTERESTING_CONTIG</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ecfa592357786-8">&nbsp;</div><div class="crayon-line" id="crayon-64f105cf0ecfa592357786-9"><span class="crayon-c"># Copy the header but truncate the existing SQ lines</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ecfa592357786-10"><span class="crayon-v">header</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">super_bam</span><span class="crayon-sy">.</span><span class="crayon-v">header</span><span class="crayon-sy">.</span><span class="crayon-k ">copy</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-64f105cf0ecfa592357786-11"><span class="crayon-v">header</span><span class="crayon-sy">[</span><span class="crayon-s">"SQ"</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ecfa592357786-12">&nbsp;</div><div class="crayon-line" id="crayon-64f105cf0ecfa592357786-13"><span class="crayon-c"># Keep a set of required SQ lines indices</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ecfa592357786-14"><span class="crayon-c"># and add the SQ index of the target contig</span></div><div class="crayon-line" id="crayon-64f105cf0ecfa592357786-15"><span class="crayon-v">required_indices</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-k ">set</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ecfa592357786-16"><span class="crayon-v">required_indices</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-v">INTERESTING_INDEX</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-64f105cf0ecfa592357786-17">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ecfa592357786-18"><span class="crayon-c"># Parse the reads mapped to the target contig and add</span></div><div class="crayon-line" id="crayon-64f105cf0ecfa592357786-19"><span class="crayon-c"># the index of the contig the mate pair appears on</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ecfa592357786-20"><span class="crayon-c"># (if not the target contig, or unmapped)</span></div><div class="crayon-line" id="crayon-64f105cf0ecfa592357786-21"><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">read </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">super_bam</span><span class="crayon-sy">.</span><span class="crayon-e">fetch</span><span class="crayon-sy">(</span><span class="crayon-v">INTERESTING_CONTIG</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ecfa592357786-22"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">read</span><span class="crayon-sy">.</span><span class="crayon-v">next_reference_id</span><span class="crayon-h"> </span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-64f105cf0ecfa592357786-23"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">required_indices</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-v">read</span><span class="crayon-sy">.</span><span class="crayon-v">next_reference_id</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ecfa592357786-24">&nbsp;</div><div class="crayon-line" id="crayon-64f105cf0ecfa592357786-25"><span class="crayon-c"># Populate the new header's SQ lines, extracting the</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ecfa592357786-26"><span class="crayon-c"># original SQ data from the super_bam.header for each</span></div><div class="crayon-line" id="crayon-64f105cf0ecfa592357786-27"><span class="crayon-c"># index harvested from the previous step</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ecfa592357786-28"><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">ref_index </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">required_indices</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-64f105cf0ecfa592357786-29"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">header</span><span class="crayon-sy">[</span><span class="crayon-s">"SQ"</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-h"> </span><span class="crayon-v">super_bam</span><span class="crayon-sy">.</span><span class="crayon-v">header</span><span class="crayon-sy">[</span><span class="crayon-s">"SQ"</span><span class="crayon-sy">]</span><span class="crayon-sy">[</span><span class="crayon-v">ref_index</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ecfa592357786-30">&nbsp;</div><div class="crayon-line" id="crayon-64f105cf0ecfa592357786-31"><span class="crayon-c"># Open a new BAM for writing, with your new header</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ecfa592357786-32"><span class="crayon-v">contig_bam</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">pysam</span><span class="crayon-sy">.</span><span class="crayon-e">AlignmentFile</span><span class="crayon-sy">(</span><span class="crayon-s">"my_new.bam"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"wb"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">header</span><span class="crayon-o">=</span><span class="crayon-v">header</span><span class="crayon-sy">)</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0031 seconds] -->
<p></p>
<p>This however displeased SAMtools greatly:</p>
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-64f105cf0ecfc735959669" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea  class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
$ samtools index NODE_912989_length_238_cov_5.743698.with_non-seq_header.bam 
Segmentation fault (core dumped)

$ samtools view -H NODE_912989_length_238_cov_5.743698.with_non-seq_header.bam 
@HD     VN:1.0  SO:coordinate
@SQ     SN:NODE_539672_length_126_cov_5.206349  LN:176
@SQ     SN:NODE_837244_length_378_cov_5.251323  LN:428
@SQ     SN:NODE_912989_length_238_cov_5.743698  LN:288
@SQ     SN:NODE_1101582_length_123_cov_4.081301 LN:173
@SQ     SN:NODE_1140726_length_2383_cov_9.494335        LN:2433
@RG     ID:Limpet-Magda SM:Limpet-Magda PU:Illumina     PL:Illumina
@PG     PN:bowtie2      ID:bowtie2      VN:2.2.3        CL:"[...]"

$ samtools view NODE_912989_length_238_cov_5.743698.with_non-seq_header.bam 
[main_samview] truncated file.</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-64f105cf0ecfc735959669-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ecfc735959669-2">2</div><div class="crayon-num" data-line="crayon-64f105cf0ecfc735959669-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ecfc735959669-4">4</div><div class="crayon-num" data-line="crayon-64f105cf0ecfc735959669-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ecfc735959669-6">6</div><div class="crayon-num" data-line="crayon-64f105cf0ecfc735959669-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ecfc735959669-8">8</div><div class="crayon-num" data-line="crayon-64f105cf0ecfc735959669-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ecfc735959669-10">10</div><div class="crayon-num" data-line="crayon-64f105cf0ecfc735959669-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ecfc735959669-12">12</div><div class="crayon-num" data-line="crayon-64f105cf0ecfc735959669-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ecfc735959669-14">14</div><div class="crayon-num" data-line="crayon-64f105cf0ecfc735959669-15">15</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-64f105cf0ecfc735959669-1"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">samtools </span><span class="crayon-e">index </span><span class="crayon-v">NODE_912989_length_238_cov_5</span><span class="crayon-sy">.</span><span class="crayon-cn">743698.with_non</span><span class="crayon-o">-</span><span class="crayon-v">seq_header</span><span class="crayon-sy">.</span><span class="crayon-e">bam </span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ecfc735959669-2"><span class="crayon-e">Segmentation </span><span class="crayon-e">fault</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-e">core </span><span class="crayon-v">dumped</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-64f105cf0ecfc735959669-3">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ecfc735959669-4"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">samtools </span><span class="crayon-v">view</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">H</span><span class="crayon-h"> </span><span class="crayon-v">NODE_912989_length_238_cov_5</span><span class="crayon-sy">.</span><span class="crayon-cn">743698.with_non</span><span class="crayon-o">-</span><span class="crayon-v">seq_header</span><span class="crayon-sy">.</span><span class="crayon-i">bam</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-64f105cf0ecfc735959669-5"><span class="crayon-sy">@</span><span class="crayon-e">HD&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">VN</span><span class="crayon-o">:</span><span class="crayon-cn">1.0</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">SO</span><span class="crayon-o">:</span><span class="crayon-i">coordinate</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ecfc735959669-6"><span class="crayon-sy">@</span><span class="crayon-e">SQ&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">SN</span><span class="crayon-o">:</span><span class="crayon-v">NODE_539672_length_126_cov_5</span><span class="crayon-sy">.</span><span class="crayon-cn">206349</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">LN</span><span class="crayon-o">:</span><span class="crayon-cn">176</span></div><div class="crayon-line" id="crayon-64f105cf0ecfc735959669-7"><span class="crayon-sy">@</span><span class="crayon-e">SQ&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">SN</span><span class="crayon-o">:</span><span class="crayon-v">NODE_837244_length_378_cov_5</span><span class="crayon-sy">.</span><span class="crayon-cn">251323</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">LN</span><span class="crayon-o">:</span><span class="crayon-cn">428</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ecfc735959669-8"><span class="crayon-sy">@</span><span class="crayon-e">SQ&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">SN</span><span class="crayon-o">:</span><span class="crayon-v">NODE_912989_length_238_cov_5</span><span class="crayon-sy">.</span><span class="crayon-cn">743698</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">LN</span><span class="crayon-o">:</span><span class="crayon-cn">288</span></div><div class="crayon-line" id="crayon-64f105cf0ecfc735959669-9"><span class="crayon-sy">@</span><span class="crayon-e">SQ&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">SN</span><span class="crayon-o">:</span><span class="crayon-v">NODE_1101582_length_123_cov_4</span><span class="crayon-sy">.</span><span class="crayon-cn">081301</span><span class="crayon-h"> </span><span class="crayon-v">LN</span><span class="crayon-o">:</span><span class="crayon-cn">173</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ecfc735959669-10"><span class="crayon-sy">@</span><span class="crayon-e">SQ&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">SN</span><span class="crayon-o">:</span><span class="crayon-v">NODE_1140726_length_2383_cov_9</span><span class="crayon-sy">.</span><span class="crayon-cn">494335</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">LN</span><span class="crayon-o">:</span><span class="crayon-cn">2433</span></div><div class="crayon-line" id="crayon-64f105cf0ecfc735959669-11"><span class="crayon-sy">@</span><span class="crayon-e">RG&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">ID</span><span class="crayon-o">:</span><span class="crayon-v">Limpet</span><span class="crayon-o">-</span><span class="crayon-e">Magda </span><span class="crayon-v">SM</span><span class="crayon-o">:</span><span class="crayon-v">Limpet</span><span class="crayon-o">-</span><span class="crayon-e">Magda </span><span class="crayon-v">PU</span><span class="crayon-o">:</span><span class="crayon-e">Illumina&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">PL</span><span class="crayon-o">:</span><span class="crayon-i">Illumina</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ecfc735959669-12"><span class="crayon-sy">@</span><span class="crayon-e">PG&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">PN</span><span class="crayon-o">:</span><span class="crayon-e">bowtie2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">ID</span><span class="crayon-o">:</span><span class="crayon-e">bowtie2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">VN</span><span class="crayon-o">:</span><span class="crayon-cn">2.2.3</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">CL</span><span class="crayon-o">:</span><span class="crayon-s">"[...]"</span></div><div class="crayon-line" id="crayon-64f105cf0ecfc735959669-13">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ecfc735959669-14"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">samtools </span><span class="crayon-e">view </span><span class="crayon-v">NODE_912989_length_238_cov_5</span><span class="crayon-sy">.</span><span class="crayon-cn">743698.with_non</span><span class="crayon-o">-</span><span class="crayon-v">seq_header</span><span class="crayon-sy">.</span><span class="crayon-i">bam</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-64f105cf0ecfc735959669-15"><span class="crayon-sy">[</span><span class="crayon-v">main_samview</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-e">truncated </span><span class="crayon-v">file</span><span class="crayon-sy">.</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0010 seconds] -->
<p></p>
<p>As I&#8217;d merely re-written the header, keeping each read&#8217;s <code>reference_id</code> and <code>next_reference_id</code> intact, I&#8217;d inadvertently created an invalid BAM file which causes samtools to seg fault when trying to parse it with <code>samtools view</code> or <code>samtools index</code>. Without getting too technical, <code>samtools</code> expects the length of the list of <code>@SQ</code> lines to equal the index of the largest <code>@SQ</code> line, <em>i.e.</em> the <code>@SQ</code> lines are consecutively numbered<sup id="fnref-385-3"><a href="#fn-385-3" class="jetpack-footnote">1</a></sup>. Values for both the <code>reference_id</code> and <code>next_reference_id</code> for each read are used by <code>samtools</code> not to refer to the <code>@SQ</code> line with some ID <code>i</code>, but rather the <code>i</code>&#8216;th <code>@SQ</code> line in the list of sequences. This is an important distinction, as having filtered out the majority of sequence lines (the example above contains just 5 of the ~730K original <code>@SQ</code> lines in the superset BAM), I had disturbed the numbering scheme, worse still, I&#8217;d made it almost certain that an error would occur when trying to read any file created in the same way.</p>
<p>In the above example, the contig of interest is <code>NODE_912989_length_238_cov_5.743698</code>, whose corresponding reads have a <code>reference_id</code> of <code>421586</code>. This is not the <code>@SQ</code> line with ID <code>421586</code>, but the 421586&#8217;th sequence in the list of all <code>@SQ</code> lines. Yet as the subset BAM&#8217;s first <code>@SQ</code> line, it is addressed as the 0&#8217;th sequence in the structure built by samtools during parsing. Later, when attempting to output information on the reads contained in the file, the <code>reference_id</code> of <code>421586</code> causes samtools to attempt to access invalid memory &#8212; the 421586&#8217;th element of a struct with only 5 entries.</p>
<p>samtools elegantly handles my stupidity by segfaulting.</p>
<h2>Unordered sequence header causes huge GATK errors</h2>
<p>Hacking on a hack, I simply re-numbered the <code>reference_id</code> and <code>next_reference_id</code> attributes of appropriate reads with consecutive integers to match their new <code>@SQ</code> lines. I appended the target contig to the sequence header first and translated IDs for corresponding reads to <code>0</code> as I had done earlier. When unseen contigs with mates to a target contig read were encountered, the contig was also appended to the new header and the <code>next_reference_id</code> was overwritten with a new incremental ID:</p>
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-64f105cf0ecff443240410" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">Python</span></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea  class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
import pysam

# Load superset BAM
super_bam = pysam.AlignmentFile("/path/to/my.bam")

# Construct an index reference
reference_index = {}
for i, reference in enumerate(super_bam.references):
    reference_index[reference] = i

# Define target contig and fetch its index in the SQ lines
INTERESTING_CONTIG = "my_contig"
INTERESTING_INDEX = references_index[INTERESTING_CONTIG]

# Copy the header but truncate the existing SQ lines
header = super_bam.header.copy()
header["SQ"] = []

# Maintain a map of sequence index translations
#  The key maps the old @SQ line index to the new
#  @SQ line index value for the subset header
header_sq_map = {} 

# As before, keep a set of required SQ lines indices
# We can append the target contig to the header
# and also per-emptively translate it to the 0th SQ
required_indices = set()
header["SQ"].append( super_bam.header["SQ"][INTERESTING_INDEX] )
header_sq_map[INTERESTING_INDEX] = 0

# Parse the reads mapped to the target contig and add
# the index of the contig the mate pair appears on
# (if not the target contig, or unmapped)
for read in super_bam.fetch(INTERESTING_CONTIG):
    if read.next_reference_id &gt; 0:
        required_indices.add(read.next_reference_id)

# Populate the new header's SQ lines, extracting the
# original SQ data from the super_bam.header for each
# index harvested from the previous step
# This time, we also add an entry in header_sq_map for
# translation on our second loop over the reads
for i, ref_index in enumerate(required_indices):
    header["SQ"].append( super_bam.header["SQ"][ref_index] )
    header_sq_map[ref_index] = i

# Open a new BAM for writing, with your new header
contig_bam = pysam.AlignmentFile("my_new.bam", "wb", header=header)

# Fetch, translate and write reads on the target contig to new BAM
for read in super_bam.fetch(INTERESTING_CONTIG):
    read.reference_id = header_sq_map[read.reference_id]
    read.next_reference_id = header_sq_map[read.next_reference_id]
    contig_bam.write(read)

contig_bam.close()
super_bam.close()</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-64f105cf0ecff443240410-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ecff443240410-2">2</div><div class="crayon-num" data-line="crayon-64f105cf0ecff443240410-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ecff443240410-4">4</div><div class="crayon-num" data-line="crayon-64f105cf0ecff443240410-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ecff443240410-6">6</div><div class="crayon-num" data-line="crayon-64f105cf0ecff443240410-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ecff443240410-8">8</div><div class="crayon-num" data-line="crayon-64f105cf0ecff443240410-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ecff443240410-10">10</div><div class="crayon-num" data-line="crayon-64f105cf0ecff443240410-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ecff443240410-12">12</div><div class="crayon-num" data-line="crayon-64f105cf0ecff443240410-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ecff443240410-14">14</div><div class="crayon-num" data-line="crayon-64f105cf0ecff443240410-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ecff443240410-16">16</div><div class="crayon-num" data-line="crayon-64f105cf0ecff443240410-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ecff443240410-18">18</div><div class="crayon-num" data-line="crayon-64f105cf0ecff443240410-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ecff443240410-20">20</div><div class="crayon-num" data-line="crayon-64f105cf0ecff443240410-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ecff443240410-22">22</div><div class="crayon-num" data-line="crayon-64f105cf0ecff443240410-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ecff443240410-24">24</div><div class="crayon-num" data-line="crayon-64f105cf0ecff443240410-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ecff443240410-26">26</div><div class="crayon-num" data-line="crayon-64f105cf0ecff443240410-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ecff443240410-28">28</div><div class="crayon-num" data-line="crayon-64f105cf0ecff443240410-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ecff443240410-30">30</div><div class="crayon-num" data-line="crayon-64f105cf0ecff443240410-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ecff443240410-32">32</div><div class="crayon-num" data-line="crayon-64f105cf0ecff443240410-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ecff443240410-34">34</div><div class="crayon-num" data-line="crayon-64f105cf0ecff443240410-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ecff443240410-36">36</div><div class="crayon-num" data-line="crayon-64f105cf0ecff443240410-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ecff443240410-38">38</div><div class="crayon-num" data-line="crayon-64f105cf0ecff443240410-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ecff443240410-40">40</div><div class="crayon-num" data-line="crayon-64f105cf0ecff443240410-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ecff443240410-42">42</div><div class="crayon-num" data-line="crayon-64f105cf0ecff443240410-43">43</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ecff443240410-44">44</div><div class="crayon-num" data-line="crayon-64f105cf0ecff443240410-45">45</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ecff443240410-46">46</div><div class="crayon-num" data-line="crayon-64f105cf0ecff443240410-47">47</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ecff443240410-48">48</div><div class="crayon-num" data-line="crayon-64f105cf0ecff443240410-49">49</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ecff443240410-50">50</div><div class="crayon-num" data-line="crayon-64f105cf0ecff443240410-51">51</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ecff443240410-52">52</div><div class="crayon-num" data-line="crayon-64f105cf0ecff443240410-53">53</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ecff443240410-54">54</div><div class="crayon-num" data-line="crayon-64f105cf0ecff443240410-55">55</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ecff443240410-56">56</div><div class="crayon-num" data-line="crayon-64f105cf0ecff443240410-57">57</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-64f105cf0ecff443240410-1"><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-v">pysam</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ecff443240410-2">&nbsp;</div><div class="crayon-line" id="crayon-64f105cf0ecff443240410-3"><span class="crayon-c"># Load superset BAM</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ecff443240410-4"><span class="crayon-v">super_bam</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">pysam</span><span class="crayon-sy">.</span><span class="crayon-e">AlignmentFile</span><span class="crayon-sy">(</span><span class="crayon-s">"/path/to/my.bam"</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-64f105cf0ecff443240410-5">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ecff443240410-6"><span class="crayon-c"># Construct an index reference</span></div><div class="crayon-line" id="crayon-64f105cf0ecff443240410-7"><span class="crayon-v">reference_index</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ecff443240410-8"><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">reference </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-k ">enumerate</span><span class="crayon-sy">(</span><span class="crayon-v">super_bam</span><span class="crayon-sy">.</span><span class="crayon-v">references</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-64f105cf0ecff443240410-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">reference_index</span><span class="crayon-sy">[</span><span class="crayon-v">reference</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">i</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ecff443240410-10">&nbsp;</div><div class="crayon-line" id="crayon-64f105cf0ecff443240410-11"><span class="crayon-c"># Define target contig and fetch its index in the SQ lines</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ecff443240410-12"><span class="crayon-v">INTERESTING_CONTIG</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">"my_contig"</span></div><div class="crayon-line" id="crayon-64f105cf0ecff443240410-13"><span class="crayon-v">INTERESTING_INDEX</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">references_index</span><span class="crayon-sy">[</span><span class="crayon-v">INTERESTING_CONTIG</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ecff443240410-14">&nbsp;</div><div class="crayon-line" id="crayon-64f105cf0ecff443240410-15"><span class="crayon-c"># Copy the header but truncate the existing SQ lines</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ecff443240410-16"><span class="crayon-v">header</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">super_bam</span><span class="crayon-sy">.</span><span class="crayon-v">header</span><span class="crayon-sy">.</span><span class="crayon-k ">copy</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-64f105cf0ecff443240410-17"><span class="crayon-v">header</span><span class="crayon-sy">[</span><span class="crayon-s">"SQ"</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ecff443240410-18">&nbsp;</div><div class="crayon-line" id="crayon-64f105cf0ecff443240410-19"><span class="crayon-c"># Maintain a map of sequence index translations</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ecff443240410-20"><span class="crayon-c">#&nbsp;&nbsp;The key maps the old @SQ line index to the new</span></div><div class="crayon-line" id="crayon-64f105cf0ecff443240410-21"><span class="crayon-c">#&nbsp;&nbsp;@SQ line index value for the subset header</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ecff443240410-22"><span class="crayon-v">header_sq_map</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-sy">}</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-64f105cf0ecff443240410-23">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ecff443240410-24"><span class="crayon-c"># As before, keep a set of required SQ lines indices</span></div><div class="crayon-line" id="crayon-64f105cf0ecff443240410-25"><span class="crayon-c"># We can append the target contig to the header</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ecff443240410-26"><span class="crayon-c"># and also per-emptively translate it to the 0th SQ</span></div><div class="crayon-line" id="crayon-64f105cf0ecff443240410-27"><span class="crayon-v">required_indices</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-k ">set</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ecff443240410-28"><span class="crayon-v">header</span><span class="crayon-sy">[</span><span class="crayon-s">"SQ"</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-h"> </span><span class="crayon-v">super_bam</span><span class="crayon-sy">.</span><span class="crayon-v">header</span><span class="crayon-sy">[</span><span class="crayon-s">"SQ"</span><span class="crayon-sy">]</span><span class="crayon-sy">[</span><span class="crayon-v">INTERESTING_INDEX</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-64f105cf0ecff443240410-29"><span class="crayon-v">header_sq_map</span><span class="crayon-sy">[</span><span class="crayon-v">INTERESTING_INDEX</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ecff443240410-30">&nbsp;</div><div class="crayon-line" id="crayon-64f105cf0ecff443240410-31"><span class="crayon-c"># Parse the reads mapped to the target contig and add</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ecff443240410-32"><span class="crayon-c"># the index of the contig the mate pair appears on</span></div><div class="crayon-line" id="crayon-64f105cf0ecff443240410-33"><span class="crayon-c"># (if not the target contig, or unmapped)</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ecff443240410-34"><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">read </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">super_bam</span><span class="crayon-sy">.</span><span class="crayon-e">fetch</span><span class="crayon-sy">(</span><span class="crayon-v">INTERESTING_CONTIG</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-64f105cf0ecff443240410-35"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">read</span><span class="crayon-sy">.</span><span class="crayon-v">next_reference_id</span><span class="crayon-h"> </span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ecff443240410-36"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">required_indices</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-v">read</span><span class="crayon-sy">.</span><span class="crayon-v">next_reference_id</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-64f105cf0ecff443240410-37">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ecff443240410-38"><span class="crayon-c"># Populate the new header's SQ lines, extracting the</span></div><div class="crayon-line" id="crayon-64f105cf0ecff443240410-39"><span class="crayon-c"># original SQ data from the super_bam.header for each</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ecff443240410-40"><span class="crayon-c"># index harvested from the previous step</span></div><div class="crayon-line" id="crayon-64f105cf0ecff443240410-41"><span class="crayon-c"># This time, we also add an entry in header_sq_map for</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ecff443240410-42"><span class="crayon-c"># translation on our second loop over the reads</span></div><div class="crayon-line" id="crayon-64f105cf0ecff443240410-43"><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">ref_index </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-k ">enumerate</span><span class="crayon-sy">(</span><span class="crayon-v">required_indices</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ecff443240410-44"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">header</span><span class="crayon-sy">[</span><span class="crayon-s">"SQ"</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-h"> </span><span class="crayon-v">super_bam</span><span class="crayon-sy">.</span><span class="crayon-v">header</span><span class="crayon-sy">[</span><span class="crayon-s">"SQ"</span><span class="crayon-sy">]</span><span class="crayon-sy">[</span><span class="crayon-v">ref_index</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-64f105cf0ecff443240410-45"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">header_sq_map</span><span class="crayon-sy">[</span><span class="crayon-v">ref_index</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">i</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ecff443240410-46">&nbsp;</div><div class="crayon-line" id="crayon-64f105cf0ecff443240410-47"><span class="crayon-c"># Open a new BAM for writing, with your new header</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ecff443240410-48"><span class="crayon-v">contig_bam</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">pysam</span><span class="crayon-sy">.</span><span class="crayon-e">AlignmentFile</span><span class="crayon-sy">(</span><span class="crayon-s">"my_new.bam"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"wb"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">header</span><span class="crayon-o">=</span><span class="crayon-v">header</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-64f105cf0ecff443240410-49">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ecff443240410-50"><span class="crayon-c"># Fetch, translate and write reads on the target contig to new BAM</span></div><div class="crayon-line" id="crayon-64f105cf0ecff443240410-51"><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">read </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">super_bam</span><span class="crayon-sy">.</span><span class="crayon-e">fetch</span><span class="crayon-sy">(</span><span class="crayon-v">INTERESTING_CONTIG</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ecff443240410-52"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">read</span><span class="crayon-sy">.</span><span class="crayon-v">reference_id</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">header_sq_map</span><span class="crayon-sy">[</span><span class="crayon-v">read</span><span class="crayon-sy">.</span><span class="crayon-v">reference_id</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-64f105cf0ecff443240410-53"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">read</span><span class="crayon-sy">.</span><span class="crayon-v">next_reference_id</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">header_sq_map</span><span class="crayon-sy">[</span><span class="crayon-v">read</span><span class="crayon-sy">.</span><span class="crayon-v">next_reference_id</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ecff443240410-54"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">contig_bam</span><span class="crayon-sy">.</span><span class="crayon-e">write</span><span class="crayon-sy">(</span><span class="crayon-v">read</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-64f105cf0ecff443240410-55">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ecff443240410-56"><span class="crayon-v">contig_bam</span><span class="crayon-sy">.</span><span class="crayon-e">close</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-64f105cf0ecff443240410-57"><span class="crayon-v">super_bam</span><span class="crayon-sy">.</span><span class="crayon-e">close</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0019 seconds] -->
<p></p>
<p>This didn&#8217;t appear to break samtools as before and after a quick trip through Picard&#8217;s <code>MarkDuplicates</code> I packed off 250 subset BAMs on an adventure through the GATK best practice pipeline. The trip abruptly cut short and I was left with a directory containing over 5GB of error logs:</p>
<blockquote><p>Input files reads and reference have incompatible contigs: The contig order in reads and reference is not the same; to fix this please see: (<a href="https://www.broadinstitute.org/gatk/guide/article?id=1328">https://www.broadinstitute.org/gatk/guide/article?id=1328</a>),  which describes reordering contigs in BAM and VCF files..</p></blockquote>
<p>The error helpfully went on to list each of the contigs in the current BAM, along with all ~730K contigs found in the reference FASTA, by name. It appeared GATK did not approve of my somewhat haphazard appending-as-first-encountered approach to the reads-with-mates-not-on-target problem. It appears that the order of the <code>@SQ</code> lines must match that of the appearance of the contigs themselves in the reference FASTA. Presumably this is to ensure quick and easy mapping between the <code>@SQ</code> lines in the BAM and the entries of the reference FASTA index and dictionary.</p>
<h2><code>ReorderSam</code> assumes the header is supposed to contain all contigs found in the reference</h2>
<p>As appears to be the norm, the GATK error text helpfully links a how-to article that may be of use and notes that the <code>Picard</code> toolkit offers a handy <code>ReorderSam</code> command that is capable of sorting <code>@SQ</code> lines to match the order in which contigs appear in a given reference FASTA, updating the reference IDs of reads and their mates as appropriate. Once again, invocation was simple:</p>
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-64f105cf0ed03957157029" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea  class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
java -jar picard.jar ReorderSam I=&lt;subset.bam&gt; R=&lt;ref.fa&gt; O=&lt;subset.sq_reordered.bam&gt;</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-64f105cf0ed03957157029-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-64f105cf0ed03957157029-1"><span class="crayon-v">java</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-e">jar </span><span class="crayon-v">picard</span><span class="crayon-sy">.</span><span class="crayon-e">jar </span><span class="crayon-i">ReorderSam</span><span class="crayon-h"> </span><span class="crayon-v">I</span><span class="crayon-o">=</span><span class="crayon-o">&lt;</span><span class="crayon-v">subset</span><span class="crayon-sy">.</span><span class="crayon-v">bam</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-v">R</span><span class="crayon-o">=</span><span class="crayon-o">&lt;</span><span class="crayon-v">ref</span><span class="crayon-sy">.</span><span class="crayon-v">fa</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-v">O</span><span class="crayon-o">=</span><span class="crayon-o">&lt;</span><span class="crayon-v">subset</span><span class="crayon-sy">.</span><span class="crayon-v">sq_reordered</span><span class="crayon-sy">.</span><span class="crayon-v">bam</span><span class="crayon-o">&gt;</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0002 seconds] -->
<p></p>
<p>But in bioinformatics simple problems rarely have simple solutions<sup id="fnref-385-1"><a href="#fn-385-1" class="jetpack-footnote">2</a></sup> and <code>ReorderSam</code> had basically reinstated the original superset BAM header:</p>
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-64f105cf0ed05064414457" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea  class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
$ samtools view -H test.bam | grep -c "^@SQ"
49
$ samtools view -H test.sq_reordered.bam | grep -c "^@SQ"
730724</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-64f105cf0ed05064414457-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ed05064414457-2">2</div><div class="crayon-num" data-line="crayon-64f105cf0ed05064414457-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ed05064414457-4">4</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-64f105cf0ed05064414457-1"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">samtools </span><span class="crayon-v">view</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">H</span><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-sy">.</span><span class="crayon-v">bam</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-v">grep</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">c</span><span class="crayon-h"> </span><span class="crayon-s">"^@SQ"</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ed05064414457-2"><span class="crayon-cn">49</span></div><div class="crayon-line" id="crayon-64f105cf0ed05064414457-3"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">samtools </span><span class="crayon-v">view</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">H</span><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-sy">.</span><span class="crayon-v">sq_reordered</span><span class="crayon-sy">.</span><span class="crayon-v">bam</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-v">grep</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">c</span><span class="crayon-h"> </span><span class="crayon-s">"^@SQ"</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ed05064414457-4"><span class="crayon-cn">730724</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0003 seconds] -->
<p></p>
<p>Whilst <code>ReorderSam</code> does indeed perform some re-ordering, I feel it is somewhat of a misnomer and perhaps <code>ReconcileSamRef</code><sup id="fnref-385-2"><a href="#fn-385-2" class="jetpack-footnote">3</a></sup> is a more fitting name for the tool. Evidently the tool is primarily used under the assumption that both the input BAM and reference have the same set of contigs, where one may be ordered lexicographically and the other by karyotype. Unfortunately, neither of the two boolean options that can be specified to <code>ReorderSam</code> had the functionality I needed, though one (<code>ALLOW_INCOMPLETE_DICT_CONCORDANCE=True</code>) performed the exact opposite; dropping <code>@SQ</code> lines from the source BAM if they did not appear in the reference. <strong>But we&#8217;ll return to this option</strong>.</p>
<h2>Sorted but not solved: GATK <code>IndelRealigner</code> upset by <code>@SQ</code> lines not matching reference FASTA after all</h2>
<p>We can solve the out of order problem rather trivially:</p>
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-64f105cf0ed07103989555" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea  class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
[...]

required_indices = set()
required_indices.add(INTERESTING_INDEX)

# As before parse the reads mapped to the target contig and
# add the index of the contig the mate pair appears on
# (if not the target contig, or unmapped)
for read in super_bam.fetch(INTERESTING_CONTIG):
    if read.next_reference_id &gt; 0:
        required_indices.add(read.next_reference_id)

# Populate the new header's SQ lines, extracting the
# original SQ data from the super_bam.header for each
# index harvested from the previous step
# This time, we also add an entry in header_sq_map for
# translation on our second loop over the reads
#   Note the sort applied to the required_indices set
#   that solves the issue with @SQ lines appearing
#   out of order against the reference FASTA
for i, ref_index in enumerate(sorted(required_indices)):
    header["SQ"].append( super_bam.header["SQ"][ref_index] )
    header_sq_map[ref_index] = i

[...]</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-64f105cf0ed07103989555-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ed07103989555-2">2</div><div class="crayon-num" data-line="crayon-64f105cf0ed07103989555-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ed07103989555-4">4</div><div class="crayon-num" data-line="crayon-64f105cf0ed07103989555-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ed07103989555-6">6</div><div class="crayon-num" data-line="crayon-64f105cf0ed07103989555-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ed07103989555-8">8</div><div class="crayon-num" data-line="crayon-64f105cf0ed07103989555-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ed07103989555-10">10</div><div class="crayon-num" data-line="crayon-64f105cf0ed07103989555-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ed07103989555-12">12</div><div class="crayon-num" data-line="crayon-64f105cf0ed07103989555-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ed07103989555-14">14</div><div class="crayon-num" data-line="crayon-64f105cf0ed07103989555-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ed07103989555-16">16</div><div class="crayon-num" data-line="crayon-64f105cf0ed07103989555-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ed07103989555-18">18</div><div class="crayon-num" data-line="crayon-64f105cf0ed07103989555-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ed07103989555-20">20</div><div class="crayon-num crayon-marked-num crayon-top crayon-bottom" data-line="crayon-64f105cf0ed07103989555-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ed07103989555-22">22</div><div class="crayon-num" data-line="crayon-64f105cf0ed07103989555-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ed07103989555-24">24</div><div class="crayon-num" data-line="crayon-64f105cf0ed07103989555-25">25</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-64f105cf0ed07103989555-1"><span class="crayon-sy">[</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ed07103989555-2">&nbsp;</div><div class="crayon-line" id="crayon-64f105cf0ed07103989555-3"><span class="crayon-v">required_indices</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">set</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ed07103989555-4"><span class="crayon-v">required_indices</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-v">INTERESTING_INDEX</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-64f105cf0ed07103989555-5">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ed07103989555-6"><span class="crayon-p"># As before parse the reads mapped to the target contig and</span></div><div class="crayon-line" id="crayon-64f105cf0ed07103989555-7"><span class="crayon-p"># add the index of the contig the mate pair appears on</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ed07103989555-8"><span class="crayon-p"># (if not the target contig, or unmapped)</span></div><div class="crayon-line" id="crayon-64f105cf0ed07103989555-9"><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">read </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">super_bam</span><span class="crayon-sy">.</span><span class="crayon-e">fetch</span><span class="crayon-sy">(</span><span class="crayon-v">INTERESTING_CONTIG</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ed07103989555-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">read</span><span class="crayon-sy">.</span><span class="crayon-v">next_reference_id</span><span class="crayon-h"> </span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-64f105cf0ed07103989555-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">required_indices</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-v">read</span><span class="crayon-sy">.</span><span class="crayon-v">next_reference_id</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ed07103989555-12">&nbsp;</div><div class="crayon-line" id="crayon-64f105cf0ed07103989555-13"><span class="crayon-p"># Populate the new header's SQ lines, extracting the</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ed07103989555-14"><span class="crayon-p"># original SQ data from the super_bam.header for each</span></div><div class="crayon-line" id="crayon-64f105cf0ed07103989555-15"><span class="crayon-p"># index harvested from the previous step</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ed07103989555-16"><span class="crayon-p"># This time, we also add an entry in header_sq_map for</span></div><div class="crayon-line" id="crayon-64f105cf0ed07103989555-17"><span class="crayon-p"># translation on our second loop over the reads</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ed07103989555-18"><span class="crayon-p">#&nbsp;&nbsp; Note the sort applied to the required_indices set</span></div><div class="crayon-line" id="crayon-64f105cf0ed07103989555-19"><span class="crayon-p">#&nbsp;&nbsp; that solves the issue with @SQ lines appearing</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ed07103989555-20"><span class="crayon-p">#&nbsp;&nbsp; out of order against the reference FASTA</span></div><div class="crayon-line crayon-marked-line crayon-top crayon-bottom" id="crayon-64f105cf0ed07103989555-21"><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">ref_index </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">enumerate</span><span class="crayon-sy">(</span><span class="crayon-e">sorted</span><span class="crayon-sy">(</span><span class="crayon-v">required_indices</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ed07103989555-22"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">header</span><span class="crayon-sy">[</span><span class="crayon-s">"SQ"</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-h"> </span><span class="crayon-v">super_bam</span><span class="crayon-sy">.</span><span class="crayon-v">header</span><span class="crayon-sy">[</span><span class="crayon-s">"SQ"</span><span class="crayon-sy">]</span><span class="crayon-sy">[</span><span class="crayon-v">ref_index</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-64f105cf0ed07103989555-23"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">header_sq_map</span><span class="crayon-sy">[</span><span class="crayon-v">ref_index</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-i">i</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ed07103989555-24">&nbsp;</div><div class="crayon-line" id="crayon-64f105cf0ed07103989555-25"><span class="crayon-sy">[</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">]</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0007 seconds] -->
<p></p>
<p>As we&#8217;ve been collecting the indices (that is, the entry at which a contig&#8217;s name appears in the <code>@SQ</code> header) all along, we can just use Python&#8217;s <code>sorted</code> built-in on the <code>required_indices</code> set. The ensures entries to the <code>header_sq_map</code> dictionary later used to reassign the <code>reference_id</code> and <code>next_reference_id</code> attributes of reads are created with incrementally assigned values in the order that those sequences should appear in the finished header. Tada!</p>
<p>One might have expected that to be the end of things, but whilst these files are now somewhat valid (and can be processed by Picard&#8217;s <code>MarkDuplicates</code> and GATK&#8217;s <code>RealignerTargetCreator</code> tools), they will typically fail a trip through Picard&#8217;s <code>ValidateSamFile</code>. This is a side-effect of our only interest being in reads that appear <em>on</em> the target contig. Although we retain information about mate pairs, including those on other contigs (whose sequence headers are also now included in the <code>@SQ</code> header), we discard the mates themselves along with any other read that does not fall on the specific contig that we target. Indeed, <code>ValidateSamFile</code> raises errors for each of these missing mates:</p>
<blockquote><p>ERROR: Read name &lt;RNAME&gt;, Mate not found for paired read</p></blockquote>
<p>Oddly, when I attempted to check whether these reads would fall foul of the <a href="https://samnicholls.net/2015/08/27/bridgebuilding-p4/">infamous <code>MalformedReadFilter</code></a> with <code>PrintReads</code> (<a href="https://samnicholls.net/2016/01/07/gatk-printreads-malformedreadfilter/">don&#8217;t forget, <code>PrintReads</code> automatically applies <code>MalformedReadFilter</code></a>) a completely different error surfaced<sup id="fnref-385-5"><a href="#fn-385-5" class="jetpack-footnote">4</a></sup>:</p>
<blockquote><p>Badly formed genome loc: Parameters to GenomeLocParser are incorrect: The contig index &lt;x&gt; is bad, doesn&#8217;t equal the contig index &lt;y&gt; of the contig from a string &lt;contig&gt;</p></blockquote>
<p>Busted. Although I&#8217;ve successfully ordered the subset of contigs to reflect the order in which they appear in the reference, appeasing both <code>MarkDuplicates</code> and <code>RealignerTargetCreator</code>, there&#8217;s no pulling the wool over the eyes of <code>PrintReads</code>. But as it turns out, <code>PrintReads</code> isn&#8217;t the only tool in the kit that is capable of seeing through our fraudulent activity. Given that <code>RealignerTargetCreator</code> completes successfully, one would naturally run the next step in the best practice pipeline: <a href="https://www.broadinstitute.org/gatk/gatkdocs/org_broadinstitute_gatk_tools_walkers_indels_IndelRealigner.php">the <code>IndelRealigner</code></a>, which gives exactly the same error.</p>
<h2>Same error, different walker: GATK <code>HaplotypeCaller</code> also upset by <code>@SQ</code> lines not matching reference FASTA verbatim</h2>
<p>So what if we were naughty? What if we just want this saga to be over and decide to throw best practice to the wind? We could just skip indel realignment entirely and jump straight to <a href="https://www.broadinstitute.org/gatk/gatkdocs/org_broadinstitute_gatk_tools_walkers_haplotypecaller_HaplotypeCaller.php">haplotype calling</a>, right? Sadly, GATK has you cornered now. Invoking the <code>HaplotypeCaller</code> with a file treated with our tool yields yet another error:</p>
<blockquote><p>Rod span &lt;contig&gt;:&lt;pos&gt; isn&#8217;t contained within the data shard &lt;contig&gt;:&lt;pos&gt;, meaning we wouldn&#8217;t get all of the data we need</p></blockquote>
<p>On the surface, this error doesn&#8217;t appear to give much away. The contig and position that could not be found is repeated twice in the message, but I guess the confusion comes from the jargon and the error boils down to something a pretty simple:</p>
<blockquote><p>Hey, I looked for contig:pos where contig:pos should be <strong>according to the reference</strong> and I could not find them, so I don&#8217;t have the data I need to do the stuff you told me to do. So, I&#8217;m going now. Bye.</p></blockquote>
<p>Yeah, it&#8217;s <code>HaplotypeCaller</code> telling us the same thing as <code>PrintReads</code> and <code>IndelRealigner</code>. Nobody wants our shoddily manufactured BAM file, it violates some underlying assumption that every <code>@SQ</code> line in the header should appear consecutively in the same order as they do in the reference FASTA (and by extension, the reference dictionary and index). Despite our best attempt to renumber the <code>reference_id</code> and <code>next_reference_id</code> attributes of the reads themselves to match a new ordering of just a subset of those <code>@SQ</code> lines, there appears to be no getting around this implicit requirement that the header and reference map 1:1.</p>
<p>I guess this is for the same reason that GATK requires a <code>.dict</code> and <code>.fai</code> file for references <a href="https://samnicholls.net/2015/11/11/grokking-gatk/">as I&#8217;ve discussed before</a>, it just makes things a little easier for developers (and their code). In this case, the assumption that each contig reference has a bijective mapping between the BAM header, reference index and reference dictionary means that look ups can simply rely on contig indices: <em>i.e.</em> the i&#8217;th <code>@SQ</code> line will also be the i&#8217;th entry of the reference index and dictionary.</p>
<p>So, this has been a great exercise in learning more about the BAM specification, <code>pysam</code> and the excessively orderly nature of the GATK, but how are we supposed to correctly subset a BAM? Surely there must be an easier way than <strong>all</strong> of this?</p>
<p>I downed tools, and did what I should have done much earlier, I <strong>read the manual</strong>.</p>
<p><a name="correct"></a></p>
<h1>How to <em>correctly</em> subset a BAM for analysis</h1>
<p>Who&#8217;d have thought, wanting to perform analysis on subsets of BAMs is actually quite a common use case that the <a href="https://twitter.com/gatk_dev">lovely GATK folks</a> have already considered? It turns out that &#8220;subsetting&#8221; was perhaps not the keyword to be looking for, but rather &#8220;intervals&#8221;. In fact a simple search immediately yields a <a href="http://gatkforums.broadinstitute.org/gatk/discussion/4133/when-should-i-use-l-to-pass-in-a-list-of-intervals">helpful GATK article on when to use interval lists for processing</a> and the GATK command line reference <a href="https://www.broadinstitute.org/gatk/gatkdocs/org_broadinstitute_gatk_engine_CommandLineGATK.php#--intervals">describes the <code>-L</code> or <code>--intervals</code> argument</a> that is accepted by many of the tools to support performing operations on specific parts (or <strong>intervals</strong>) of the BAM. The <code>-L</code> argument even crops up in the <a href="https://www.broadinstitute.org/gatk/guide/article?id=2800">very same pre-processing best practice documents</a> that I was purportedly following for indel realignment:</p>
<blockquote><p>[RealignerTargetCreator will be] Faster since RTC will only look for regions that need to be realigned within the input interval; no time wasted on the rest.</p></blockquote>
<p>Sure enough, I can just append the <code>-L</code> argument with the name of my target contig (as it appears in the <code>@SQ</code> header and reference) as a parameter to many of the tools provided by GATK. <code>-L</code> can also be specified multiple times, or even just reference a text file of intervals, too:</p>
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-64f105cf0ed0a382411542" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea  class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
java -jar GenomeAnalysisTK.jar -T RealignerTargetCreator \
                               -R &lt;REFERENCE FASTA&gt; \
                               -I &lt;INPUT BAM&gt; \
                               -o &lt;OUTPUT LIST&gt; \
                               -L &lt;CONTIG_1&gt; [-L &lt;CONTIG_2&gt; ... -L &lt;CONTIG_N&gt;]</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-64f105cf0ed0a382411542-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ed0a382411542-2">2</div><div class="crayon-num" data-line="crayon-64f105cf0ed0a382411542-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ed0a382411542-4">4</div><div class="crayon-num crayon-marked-num crayon-top crayon-bottom" data-line="crayon-64f105cf0ed0a382411542-5">5</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-64f105cf0ed0a382411542-1"><span class="crayon-v">java</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-e">jar </span><span class="crayon-v">GenomeAnalysisTK</span><span class="crayon-sy">.</span><span class="crayon-v">jar</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">T</span><span class="crayon-h"> </span><span class="crayon-i">RealignerTargetCreator</span><span class="crayon-h"> </span><span class="crayon-sy">\</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ed0a382411542-2"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-o">-</span><span class="crayon-v">R</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-e">REFERENCE </span><span class="crayon-v">FASTA</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-sy">\</span></div><div class="crayon-line" id="crayon-64f105cf0ed0a382411542-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-o">-</span><span class="crayon-v">I</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-e">INPUT </span><span class="crayon-v">BAM</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-sy">\</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ed0a382411542-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-o">-</span><span class="crayon-v">o</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-e">OUTPUT </span><span class="crayon-v">LIST</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-sy">\</span></div><div class="crayon-line crayon-marked-line crayon-top crayon-bottom" id="crayon-64f105cf0ed0a382411542-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-o">-</span><span class="crayon-v">L</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-v">CONTIG_1</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-o">-</span><span class="crayon-v">L</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-v">CONTIG_2</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">L</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-v">CONTIG_N</span><span class="crayon-o">&gt;</span><span class="crayon-sy">]</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0004 seconds] -->
<p></p>
<p>Re-running my example from earlier, specifying <code>-L NODE_912989_length_238_cov_5.743698</code> causes <code>RealignerTargetCreator</code> to run in a matter of minutes instead of almost two days (the actual processing is actually completed in less than a second according to the log below), with an input BAM of over 30GB. I should add that this handy option doesn&#8217;t seem to decrease the amount of memory required as the re-run still munched on 32.4GB of RAM &#8212; but I guess that&#8217;s little to worry about if the job completes in less than five minutes:</p>
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-64f105cf0ed0d982626860" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea  class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
INFO  01:02:57,559 SAMDataSource$SAMReaders - Initializing SAMRecords in serial 
INFO  01:04:24,346 SAMDataSource$SAMReaders - Done initializing BAM readers: total time 86.76 
INFO  01:04:24,464 IntervalUtils - Processing 288 bp from intervals 
INFO  01:04:28,548 GenomeAnalysisEngine - Preparing for traversal over 1 BAM files 
INFO  01:04:28,801 GenomeAnalysisEngine - Done preparing for traversal 
INFO  01:04:28,803 ProgressMeter - [INITIALIZATION COMPLETE; STARTING PROCESSING] 
INFO  01:04:28,804 ProgressMeter -                 | processed |    time |    per 1M |           |   total | remaining 
INFO  01:04:28,805 ProgressMeter -        Location |     sites | elapsed |     sites | completed | runtime |   runtime 
INFO  01:04:29,046 ProgressMeter -            done       288.0     0.0 s      14.1 m       69.4%     0.0 s       0.0 s 
INFO  01:04:29,049 ProgressMeter - Total runtime 0.25 secs, 0.00 min, 0.00 hours</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-64f105cf0ed0d982626860-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ed0d982626860-2">2</div><div class="crayon-num crayon-marked-num crayon-top crayon-bottom" data-line="crayon-64f105cf0ed0d982626860-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ed0d982626860-4">4</div><div class="crayon-num" data-line="crayon-64f105cf0ed0d982626860-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ed0d982626860-6">6</div><div class="crayon-num" data-line="crayon-64f105cf0ed0d982626860-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ed0d982626860-8">8</div><div class="crayon-num" data-line="crayon-64f105cf0ed0d982626860-9">9</div><div class="crayon-num crayon-marked-num crayon-top crayon-bottom crayon-striped-num" data-line="crayon-64f105cf0ed0d982626860-10">10</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-64f105cf0ed0d982626860-1"><span class="crayon-i">INFO</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">01</span><span class="crayon-o">:</span><span class="crayon-cn">02</span><span class="crayon-o">:</span><span class="crayon-cn">57</span><span class="crayon-sy">,</span><span class="crayon-cn">559</span><span class="crayon-h"> </span><span class="crayon-v">SAMDataSource</span><span class="crayon-sy">$</span><span class="crayon-v">SAMReaders</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-e">Initializing </span><span class="crayon-e">SAMRecords </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">serial </span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ed0d982626860-2"><span class="crayon-i">INFO</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">01</span><span class="crayon-o">:</span><span class="crayon-cn">04</span><span class="crayon-o">:</span><span class="crayon-cn">24</span><span class="crayon-sy">,</span><span class="crayon-cn">346</span><span class="crayon-h"> </span><span class="crayon-v">SAMDataSource</span><span class="crayon-sy">$</span><span class="crayon-v">SAMReaders</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-e">Done </span><span class="crayon-e">initializing </span><span class="crayon-e">BAM </span><span class="crayon-v">readers</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-e">total </span><span class="crayon-i">time</span><span class="crayon-h"> </span><span class="crayon-cn">86.76</span><span class="crayon-h"> </span></div><div class="crayon-line crayon-marked-line crayon-top crayon-bottom" id="crayon-64f105cf0ed0d982626860-3"><span class="crayon-i">INFO</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">01</span><span class="crayon-o">:</span><span class="crayon-cn">04</span><span class="crayon-o">:</span><span class="crayon-cn">24</span><span class="crayon-sy">,</span><span class="crayon-cn">464</span><span class="crayon-h"> </span><span class="crayon-v">IntervalUtils</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-i">Processing</span><span class="crayon-h"> </span><span class="crayon-cn">288</span><span class="crayon-h"> </span><span class="crayon-e">bp </span><span class="crayon-e">from </span><span class="crayon-e">intervals </span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ed0d982626860-4"><span class="crayon-i">INFO</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">01</span><span class="crayon-o">:</span><span class="crayon-cn">04</span><span class="crayon-o">:</span><span class="crayon-cn">28</span><span class="crayon-sy">,</span><span class="crayon-cn">548</span><span class="crayon-h"> </span><span class="crayon-v">GenomeAnalysisEngine</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-e">Preparing </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">traversal </span><span class="crayon-i">over</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-h"> </span><span class="crayon-e">BAM </span><span class="crayon-e">files </span></div><div class="crayon-line" id="crayon-64f105cf0ed0d982626860-5"><span class="crayon-i">INFO</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">01</span><span class="crayon-o">:</span><span class="crayon-cn">04</span><span class="crayon-o">:</span><span class="crayon-cn">28</span><span class="crayon-sy">,</span><span class="crayon-cn">801</span><span class="crayon-h"> </span><span class="crayon-v">GenomeAnalysisEngine</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-e">Done </span><span class="crayon-e">preparing </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">traversal </span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ed0d982626860-6"><span class="crayon-i">INFO</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">01</span><span class="crayon-o">:</span><span class="crayon-cn">04</span><span class="crayon-o">:</span><span class="crayon-cn">28</span><span class="crayon-sy">,</span><span class="crayon-cn">803</span><span class="crayon-h"> </span><span class="crayon-v">ProgressMeter</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-e">INITIALIZATION </span><span class="crayon-v">COMPLETE</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-e">STARTING </span><span class="crayon-v">PROCESSING</span><span class="crayon-sy">]</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-64f105cf0ed0d982626860-7"><span class="crayon-i">INFO</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">01</span><span class="crayon-o">:</span><span class="crayon-cn">04</span><span class="crayon-o">:</span><span class="crayon-cn">28</span><span class="crayon-sy">,</span><span class="crayon-cn">804</span><span class="crayon-h"> </span><span class="crayon-v">ProgressMeter</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-v">processed</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">time</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-i">per</span><span class="crayon-h"> </span><span class="crayon-cn">1M</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-o">|</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-v">total</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-e">remaining </span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ed0d982626860-8"><span class="crayon-i">INFO</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">01</span><span class="crayon-o">:</span><span class="crayon-cn">04</span><span class="crayon-o">:</span><span class="crayon-cn">28</span><span class="crayon-sy">,</span><span class="crayon-cn">805</span><span class="crayon-h"> </span><span class="crayon-v">ProgressMeter</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">Location</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">sites</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-v">elapsed</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">sites</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-v">completed</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-v">runtime</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-e">runtime </span></div><div class="crayon-line" id="crayon-64f105cf0ed0d982626860-9"><span class="crayon-i">INFO</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">01</span><span class="crayon-o">:</span><span class="crayon-cn">04</span><span class="crayon-o">:</span><span class="crayon-cn">29</span><span class="crayon-sy">,</span><span class="crayon-cn">046</span><span class="crayon-h"> </span><span class="crayon-v">ProgressMeter</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-i">done</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-cn">288.0</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-cn">0.0</span><span class="crayon-h"> </span><span class="crayon-i">s</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">14.1</span><span class="crayon-h"> </span><span class="crayon-i">m</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-cn">69.4</span><span class="crayon-o">%</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-cn">0.0</span><span class="crayon-h"> </span><span class="crayon-i">s</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-cn">0.0</span><span class="crayon-h"> </span><span class="crayon-i">s</span><span class="crayon-h"> </span></div><div class="crayon-line crayon-marked-line crayon-top crayon-bottom crayon-striped-line" id="crayon-64f105cf0ed0d982626860-10"><span class="crayon-i">INFO</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">01</span><span class="crayon-o">:</span><span class="crayon-cn">04</span><span class="crayon-o">:</span><span class="crayon-cn">29</span><span class="crayon-sy">,</span><span class="crayon-cn">049</span><span class="crayon-h"> </span><span class="crayon-v">ProgressMeter</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-e">Total </span><span class="crayon-i">runtime</span><span class="crayon-h"> </span><span class="crayon-cn">0.25</span><span class="crayon-h"> </span><span class="crayon-v">secs</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0.00</span><span class="crayon-h"> </span><span class="crayon-v">min</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0.00</span><span class="crayon-h"> </span><span class="crayon-v">hours</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0016 seconds] -->
<p></p>
<p>Excellent, I&#8217;m sure both my supervisor and system administrator will be pleased.</p>
<h3>What about extraction?</h3>
<p>It&#8217;s all well and good that we can concentrate processing on interesting contigs like this, but what if we <em>reeeaally</em> want to extract and store some reads for a specific contig like we have been trying, can we do it?</p>
<p><del datetime="2018-07-29T14:53:34+00:00">Sadly, it seems we&#8217;re fresh out of luck. We can abuse <code>PrintReads</code> to parse and write a new BAM, appending the <code>-L</code> argument to our command which will have the side effect of dropping reads that don&#8217;t fall on the contig(s) specified. As one would have expected, the output BAM is significantly smaller and demonstrates the correct number of reads (or at least, the read count matches that in the BAM we made for ourselves), so what&#8217;s the problem?</del></p>
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-64f105cf0ed0f069857434" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea  class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
$ java -jar GenomeAnalysisTK.jar -T PrintReads \
                                 -R contigs.fa \
                                 -I Limpet-Magda.sorted.bam \
                                 -o NODE_912989_length_238_cov_5.743698.subset.print.bam \
                                 -L NODE_912989_length_238_cov_5.743698

$ samtools view -c NODE_912989_length_238_cov_5.743698.subset.print.bam
98

$ samtools view -H NODE_912989_length_238_cov_5.743698.subset.print.bam | grep -c "^@SQ"
730724</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-64f105cf0ed0f069857434-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ed0f069857434-2">2</div><div class="crayon-num" data-line="crayon-64f105cf0ed0f069857434-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ed0f069857434-4">4</div><div class="crayon-num crayon-marked-num crayon-top crayon-bottom" data-line="crayon-64f105cf0ed0f069857434-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ed0f069857434-6">6</div><div class="crayon-num" data-line="crayon-64f105cf0ed0f069857434-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ed0f069857434-8">8</div><div class="crayon-num" data-line="crayon-64f105cf0ed0f069857434-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ed0f069857434-10">10</div><div class="crayon-num crayon-marked-num crayon-top crayon-bottom" data-line="crayon-64f105cf0ed0f069857434-11">11</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-64f105cf0ed0f069857434-1"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-v">java</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-e">jar </span><span class="crayon-v">GenomeAnalysisTK</span><span class="crayon-sy">.</span><span class="crayon-v">jar</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">T</span><span class="crayon-h"> </span><span class="crayon-i">PrintReads</span><span class="crayon-h"> </span><span class="crayon-sy">\</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ed0f069857434-2"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-o">-</span><span class="crayon-i">R</span><span class="crayon-h"> </span><span class="crayon-v">contigs</span><span class="crayon-sy">.</span><span class="crayon-i">fa</span><span class="crayon-h"> </span><span class="crayon-sy">\</span></div><div class="crayon-line" id="crayon-64f105cf0ed0f069857434-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-o">-</span><span class="crayon-i">I</span><span class="crayon-h"> </span><span class="crayon-v">Limpet</span><span class="crayon-o">-</span><span class="crayon-v">Magda</span><span class="crayon-sy">.</span><span class="crayon-v">sorted</span><span class="crayon-sy">.</span><span class="crayon-i">bam</span><span class="crayon-h"> </span><span class="crayon-sy">\</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ed0f069857434-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-o">-</span><span class="crayon-i">o</span><span class="crayon-h"> </span><span class="crayon-v">NODE_912989_length_238_cov_5</span><span class="crayon-sy">.</span><span class="crayon-cn">743698.subset.print.bam</span><span class="crayon-h"> </span><span class="crayon-sy">\</span></div><div class="crayon-line crayon-marked-line crayon-top crayon-bottom" id="crayon-64f105cf0ed0f069857434-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-o">-</span><span class="crayon-i">L</span><span class="crayon-h"> </span><span class="crayon-v">NODE_912989_length_238_cov_5</span><span class="crayon-sy">.</span><span class="crayon-cn">743698</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ed0f069857434-6">&nbsp;</div><div class="crayon-line" id="crayon-64f105cf0ed0f069857434-7"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">samtools </span><span class="crayon-v">view</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">c</span><span class="crayon-h"> </span><span class="crayon-v">NODE_912989_length_238_cov_5</span><span class="crayon-sy">.</span><span class="crayon-cn">743698.subset.print.bam</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ed0f069857434-8"><span class="crayon-cn">98</span></div><div class="crayon-line" id="crayon-64f105cf0ed0f069857434-9">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ed0f069857434-10"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">samtools </span><span class="crayon-v">view</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">H</span><span class="crayon-h"> </span><span class="crayon-v">NODE_912989_length_238_cov_5</span><span class="crayon-sy">.</span><span class="crayon-cn">743698.subset.print.bam</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-v">grep</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">c</span><span class="crayon-h"> </span><span class="crayon-s">"^@SQ"</span></div><div class="crayon-line crayon-marked-line crayon-top crayon-bottom" id="crayon-64f105cf0ed0f069857434-11"><span class="crayon-cn">730724</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0005 seconds] -->
<p></p>
<p><del datetime="2018-07-29T14:53:34+00:00"><br />
We&#8217;re back where we started with my own tool, a BAM with the right number of reads but a fully intact header that causes wasted resources. We&#8217;ve reached the crux. Unsurprisingly, for the reasons I&#8217;ve hypothesized, we just can&#8217;t be messing around with the <code>@SQ</code> header if we still want to use the same reference as that used with the super BAM. I briefly toyed with the thought of generating subsets of the reference FASTA itself, to match the new <code>@SQ</code> of each subset BAM. This would definitely appease the tools upset by our trickery, but we&#8217;d need to also generate FASTA indexes and dictionaries for each new reference and ensure to provide the right sub-reference for each sub-BAM when conducting analysis later. My bioinformaticy senses tingled, this sounds messy; a sticky plaster over a sticky plaster. I could already see another addendum to a long future blog post forming.</del></p>
<p><del><br />
For the time being, I&#8217;d achieved what I needed to do, at least in part. I&#8217;ve discovered how to focus efforts on specific intervals of interest with the <code>-L</code> argument, saving computational resources along with my own time and sanity. I can now get on with following the GATK best practice pipeline, and if I do encounter a use case that <span data-dobid="hdw">necessitate</span>s extraction of reads in the sense of what I initially set out to do, I can spin out a tool to just regenerate a new reference FASTA, dictionary and index[^8], as messy as that may sound.<br />
</del></p>
<p><del><br />
Though, before you leave here with the conclusion that I can&#8217;t even read, I should perhaps jump in to my own defence a little. The reason that I didn&#8217;t just set out to operate on a subset (interval!) of the alignment, was in trying to avoid having to define subregions at every step of the analysis pipeline. Although primarily out of laze, the idea was to also avoid having to store all of the reads that weren&#8217;t of interest to me in the first place, don&#8217;t forget, for our cluster <a href="https://samnicholls.net/2015/04/25/scratch/">disk space is as much of a scarce commodity</a> <a href="https://samnicholls.net/2015/02/13/ram/">as RAM</a>. I also wanted small BAMs (10-100Mb) that could be effortlessly transmitted to others without worrying about bandwidth, hosting or having to offer aftercare to people trapped underneath 365 million reads. Really, I just wanted to quickly and crudely look at some data for myself and I thought it would be easy to roll something small to do the trick with <code>pysam</code>[^7].</del></p>
<p><del datetime="2018-07-29T14:53:34+00:00">But I learned my lesson.</del></p>
<h3>Update: The following evening</h3>
<p><del datetime="2018-07-29T14:53:34+00:00"><br />
For what it&#8217;s worth, the <a href="https://twitter.com/gatk_dev/status/686616627408953345">GATK developers got in touch</a> and shared an article describing the <a href="http://gatkforums.broadinstitute.org/dsde/discussion/6760/tutorial-files-provenance-ashg15">generation of example files that contain a subset of reads</a> for a workshop. The tutorial suggests that as per my earlier suspicions, the best way to achieve extraction is to build a subset reference too. Interestingly, extraction and indexing of single contigs from a FASTA can both be done with <code>samtools faidx</code>, which I didn&#8217;t realise. The process overall is a little convoluted, for example the BAM header must be extracted (<code>samtools view -H</code>) and manually edited to prune <code>@SQ</code> lines, the BAM must then be converted to SAM to allow Picard <code>ReheaderSam</code> to apply the modified header (and back again later). As with my own example earlier, this process will still leave reads without a mate if the mate appears on a contig which has been filtered out. However, the tutorial does offer a <a href="http://broadinstitute.github.io/picard/command-line-overview.html#RevertSam">solution to this in the form of Picard&#8217;s <code>RevertSam</code> tool</a>, whose (albeit quite destructive) <code>SANITIZE</code> option will forcibly discard reads that cause the SAM to be invalid.</del></p>
<h3>Update: If you aren&#8217;t lazy</h3>
<p>If you&#8217;re happy to make a new reference and just want to extract a bunch of reads for a particular contig, you&#8217;re in luck. You can extract the contig with <code>samtools faidx</code> and use <code>ReorderSam</code>&#8216;s <code>ALLOW_INCOMPLETE_DICT_CONCORDANCE</code> option (<code>S=true</code> shorthand) to forcibly drop reads that don&#8217;t appear in your new reference. Ta-da!</p>
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-64f105cf0ed12915673250" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea  class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
samtools faidx ref.fa my_contig_name &gt; my_contig.fa
java -jar picard.jar CreateSequenceDictionary R=my_contig.fa O=my_contig.dict
java -jar picard.jar ReorderSam INPUT=super.bam OUTPUT=subset.bam REFERENCE=my_contig.fa S=true VERBOSITY=WARNING</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-64f105cf0ed12915673250-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ed12915673250-2">2</div><div class="crayon-num" data-line="crayon-64f105cf0ed12915673250-3">3</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-64f105cf0ed12915673250-1"><span class="crayon-e">samtools </span><span class="crayon-e">faidx </span><span class="crayon-v">ref</span><span class="crayon-sy">.</span><span class="crayon-e">fa </span><span class="crayon-v">my_contig_name</span><span class="crayon-h"> </span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-v">my_contig</span><span class="crayon-sy">.</span><span class="crayon-e">fa</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ed12915673250-2"><span class="crayon-v">java</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-e">jar </span><span class="crayon-v">picard</span><span class="crayon-sy">.</span><span class="crayon-e">jar </span><span class="crayon-i">CreateSequenceDictionary</span><span class="crayon-h"> </span><span class="crayon-v">R</span><span class="crayon-o">=</span><span class="crayon-v">my_contig</span><span class="crayon-sy">.</span><span class="crayon-i">fa</span><span class="crayon-h"> </span><span class="crayon-v">O</span><span class="crayon-o">=</span><span class="crayon-v">my_contig</span><span class="crayon-sy">.</span><span class="crayon-e">dict</span></div><div class="crayon-line" id="crayon-64f105cf0ed12915673250-3"><span class="crayon-v">java</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-e">jar </span><span class="crayon-v">picard</span><span class="crayon-sy">.</span><span class="crayon-e">jar </span><span class="crayon-e">ReorderSam </span><span class="crayon-v">INPUT</span><span class="crayon-o">=</span><span class="crayon-r">super</span><span class="crayon-sy">.</span><span class="crayon-e">bam </span><span class="crayon-v">OUTPUT</span><span class="crayon-o">=</span><span class="crayon-v">subset</span><span class="crayon-sy">.</span><span class="crayon-e">bam </span><span class="crayon-v">REFERENCE</span><span class="crayon-o">=</span><span class="crayon-v">my_contig</span><span class="crayon-sy">.</span><span class="crayon-i">fa</span><span class="crayon-h"> </span><span class="crayon-v">S</span><span class="crayon-o">=</span><span class="crayon-t">true</span><span class="crayon-h"> </span><span class="crayon-v">VERBOSITY</span><span class="crayon-o">=</span><span class="crayon-v">WARNING</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0004 seconds] -->
<p></p>
<p>Set the verbosity to <code>WARNING</code> to avoid thousands of <code>INFO</code> lines telling you about dropped contigs, and don&#8217;t forget to make your sequence dictionary first! Happy subsetting!</p>
<h1>tl;dr</h1>
<ul>
<li>Although <code>ReorderSam</code> does perform re-ordering, its name does not communicate its assumption that both the input BAM and reference FASTA share the same set of contigs, that just happen to be ordered differently</li>
<li>You simply cannot chop out swathes of the <code>@SQ</code> header, no matter how well you cover up your tracks</li>
<li>GATK insists you stop mucking about with the BAM header, consider them contaminated as soon as you touch them with your careless fingers</li>
<li>Use the <code>-L</code> parameter to use a GATK tool on a subset of reads in a large BAM</li>
<li><code>samtools faidx</code> can also extract a contig from a FASTA</li>
<li>Picard <code>RevertSam</code>&#8216;s <code>SANITIZE</code> option can be used to discard reads missing mates (amongst many other things)</li>
<li>Seriously, stop trying to do weird things with BAMs by yourself</li>
<li>But you could use <code>ReorderSam</code> with <code>S=true</code> if you are happy to make a new reference.</li>
</ul>
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-64f105cf0ed14730543563" class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 12px; margin-bottom: 12px; clear: none; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea  class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
$ time java -Xmx3G -jar ~/ware/GenomeAnalysisTK.jar -T PrintReads -I NODE_912989_length_238_cov_5.743698.good.bam -R contigs.fa
[...]
118.96user 2.49system 1:21.35elapsed 149%CPU (0avgtext+0avgdata 3172152maxresident)k</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-64f105cf0ed14730543563-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-64f105cf0ed14730543563-2">2</div><div class="crayon-num" data-line="crayon-64f105cf0ed14730543563-3">3</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-64f105cf0ed14730543563-1"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">time </span><span class="crayon-v">java</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">Xmx3G</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">jar</span><span class="crayon-h"> </span><span class="crayon-o">~</span><span class="crayon-o">/</span><span class="crayon-v">ware</span><span class="crayon-o">/</span><span class="crayon-v">GenomeAnalysisTK</span><span class="crayon-sy">.</span><span class="crayon-v">jar</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">T</span><span class="crayon-h"> </span><span class="crayon-v">PrintReads</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">I</span><span class="crayon-h"> </span><span class="crayon-v">NODE_912989_length_238_cov_5</span><span class="crayon-sy">.</span><span class="crayon-cn">743698.good.bam</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">R</span><span class="crayon-h"> </span><span class="crayon-v">contigs</span><span class="crayon-sy">.</span><span class="crayon-i">fa</span></div><div class="crayon-line crayon-striped-line" id="crayon-64f105cf0ed14730543563-2"><span class="crayon-sy">[</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-64f105cf0ed14730543563-3"><span class="crayon-cn">118.96user</span><span class="crayon-h"> </span><span class="crayon-cn">2.49system</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-o">:</span><span class="crayon-cn">21.35elapsed</span><span class="crayon-h"> </span><span class="crayon-cn">149</span><span class="crayon-o">%</span><span class="crayon-e">CPU</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-cn">0avgtext</span><span class="crayon-o">+</span><span class="crayon-cn">0avgdata</span><span class="crayon-h"> </span><span class="crayon-cn">3172152maxresident</span><span class="crayon-sy">)</span><span class="crayon-v">k</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0004 seconds] -->
<p></p>
<div class="footnotes">
<hr />
<ol>
<li id="fn-385-3">
Although this is somewhat of a tautology; the list&#8217;s length is expected to be equal to the greatest ID of the list, where the &#8220;ID&#8221; of a sequence directly corresponds to that sequence&#8217;s position in the list of all <code>@SQ</code> lines, hopefully it helps to explain why removing elements from that list was silly.&#160;<a href="#fnref-385-3">&#8617;</a>
</li>
<li id="fn-385-1">
This is especially true when you are <strong>doing it wrong</strong>™.&#160;<a href="#fnref-385-1">&#8617;</a>
</li>
<li id="fn-385-2">
Narrowly beating my other suggestion of <code>HarmonizeSamHeader</code>.&#160;<a href="#fnref-385-2">&#8617;</a>
</li>
<li id="fn-385-5">
Incidentally, for a 8.1Kb BAM and a 441Mb contig FASTA, I needed to set the Java virtual machine heap to 3GB. For the record I ran the command with <code>time</code><sup id="fnref-385-6"><a href="#fn-385-6" class="jetpack-footnote">5</a></sup>, note the seemingly insane use of 3172Mb of resident memory for what seems to be a trivial job on the surface.&#160;<a href="#fnref-385-5">&#8617;</a>
</li>
<li id="fn-385-6">
<p><a href="#fnref-385-6">&#8617;</a>
</li>
</ol>
</div>
</div>
                
                        <div class="tag-well"><span><span class="fa fa-tags"></span>&nbsp;&nbsp; <a href="https://samnicholls.net/tag/bam/" rel="tag">bam</a>,&nbsp; <a href="https://samnicholls.net/tag/extract/" rel="tag">extract</a>,&nbsp; <a href="https://samnicholls.net/tag/gatk/" rel="tag">GATK</a>,&nbsp; <a href="https://samnicholls.net/tag/intervals/" rel="tag">intervals</a>,&nbsp; <a href="https://samnicholls.net/tag/pitfalls/" rel="tag">pitfalls</a>,&nbsp; <a href="https://samnicholls.net/tag/pysam/" rel="tag">pysam</a>,&nbsp; <a href="https://samnicholls.net/tag/rtfm/" rel="tag">rtfm</a>,&nbsp; <a href="https://samnicholls.net/tag/subset/" rel="tag">subset</a></span></div>
                
                <nav class="further-reading">
	<div class="previous">
		<span>Previous Post</span>
		<a href="https://samnicholls.net/2016/01/07/gatk-printreads-malformedreadfilter/">Duplicate definition error with GATK PrintReads and MalformedReadFilter</a>
	</div>
	<div class="next">
		<span>Next Post</span>
		<a href="https://samnicholls.net/2016/01/14/how-to-switch-sata-raid-to-ahci-windows-10-xps-13/">How to switch SATA controller driver from RAID to AHCI on Windows 10 without a reinstall</a>
	</div>
</nav>            </article>
                                <div class="card">

<div id="disqus_thread"></div>
                </div>
    
</section>

        <!-- Sidebar -->
        <aside class="col-md-4 sidebar-container">
		            <div id="widget-area" class="widget-area" role="complementary">
                <div id="custom_html-3" class="widget_text card widget widget_custom_html"><div class="textwidget custom-html-widget"><img src="https://pbs.twimg.com/profile_images/1044255545610436609/wt33ZbtU_400x400.jpg" height=120 style="margin-top: 20px; margin-right:10px; float: left;" alt="Sam Nicholls" />
<div style="padding-top:15px; line-height: normal"><b style="font-size: 1.2em">Sam Nicholls</b><br><span style="font-size: 0.9em;">Haplotype Wrangler at University of Birmingham.<br>I tell computers to do things, then I write about how it all went wrong.</span></div></div></div><div id="search-2" class="card widget widget_search"><form style="margin-top:15px" action="https://samnicholls.net/" id="searchform" method="get" role="form">
    <div class="form-group">
        <input type="text" class="form-control" name="s" id="s" placeholder="e.g. Search...">
    </div>
</form>
</div><div id="twitter_timeline-5" class="card widget widget_twitter_timeline"><a class="twitter-timeline" data-height="400" data-theme="light" data-link-color="#f96e5b" data-border-color="#e8e8e8" data-lang="EN" data-partner="jetpack" data-chrome="noheader nofooter noborders" href="https://twitter.com/samstudio8">My Tweets</a></div><div id="categories-5" class="card widget widget_categories"><h2>Categories</h2>
			<ul>
					<li class="cat-item cat-item-2"><a href="https://samnicholls.net/category/bioinf/">Bioinformatics</a>
<ul class='children'>
	<li class="cat-item cat-item-8"><a href="https://samnicholls.net/category/bioinf/au-phd/">AU-PhD</a>
</li>
	<li class="cat-item cat-item-3"><a href="https://samnicholls.net/category/bioinf/sanger-qc/" title="Sanger QC Project">Sanger-QC</a>
</li>
	<li class="cat-item cat-item-61"><a href="https://samnicholls.net/category/bioinf/tools/">Tools</a>
	<ul class='children'>
	<li class="cat-item cat-item-185"><a href="https://samnicholls.net/category/bioinf/tools/chitin/">chitin</a>
</li>
	</ul>
</li>
</ul>
</li>
	<li class="cat-item cat-item-80"><a href="https://samnicholls.net/category/devops/">Devops</a>
</li>
	<li class="cat-item cat-item-114"><a href="https://samnicholls.net/category/event/">Event</a>
</li>
	<li class="cat-item cat-item-21"><a href="https://samnicholls.net/category/gadgets/">Gadgets</a>
</li>
	<li class="cat-item cat-item-176"><a href="https://samnicholls.net/category/hardware/">Hardware</a>
<ul class='children'>
	<li class="cat-item cat-item-223"><a href="https://samnicholls.net/category/hardware/beehive-monitor/">Beehive Monitor</a>
</li>
	<li class="cat-item cat-item-178"><a href="https://samnicholls.net/category/hardware/esp8266/">ESP8266</a>
</li>
	<li class="cat-item cat-item-236"><a href="https://samnicholls.net/category/hardware/lego-sequencer/">Lego Sequencer</a>
</li>
	<li class="cat-item cat-item-177"><a href="https://samnicholls.net/category/hardware/lightstick/">Lightstick</a>
</li>
</ul>
</li>
	<li class="cat-item cat-item-151"><a href="https://samnicholls.net/category/lab/">Lab</a>
<ul class='children'>
	<li class="cat-item cat-item-150"><a href="https://samnicholls.net/category/lab/protocol-guides/">Protocol Guides</a>
</li>
</ul>
</li>
	<li class="cat-item cat-item-5"><a href="https://samnicholls.net/category/meta/">Meta</a>
</li>
	<li class="cat-item cat-item-62"><a href="https://samnicholls.net/category/mysteries/">Mysteries</a>
</li>
	<li class="cat-item cat-item-22"><a href="https://samnicholls.net/category/personal/">Personal</a>
</li>
	<li class="cat-item cat-item-4"><a href="https://samnicholls.net/category/photo/">Photography</a>
</li>
	<li class="cat-item cat-item-143"><a href="https://samnicholls.net/category/programming/">Programming</a>
<ul class='children'>
	<li class="cat-item cat-item-145"><a href="https://samnicholls.net/category/programming/documentation/">Documentation</a>
</li>
	<li class="cat-item cat-item-144"><a href="https://samnicholls.net/category/programming/python/">Python</a>
</li>
</ul>
</li>
	<li class="cat-item cat-item-48"><a href="https://samnicholls.net/category/status-report/">Status Report</a>
</li>
	<li class="cat-item cat-item-60"><a href="https://samnicholls.net/category/sysadm/">System Administration</a>
</li>
	<li class="cat-item cat-item-1"><a href="https://samnicholls.net/category/uncategorised/">Uncategorised</a>
</li>
			</ul>

			</div>            </div>
		        </aside>
    </div>

</div> <!-- /container -->

<footer id="main-footer" class="bg-primary">
	<div id="footer-widgets" class="container">
		    </div>
</footer>



	<div style="display:none">
	</div>
<script type='text/javascript' src='https://samnicholls.net/wp-includes/js/comment-reply.min.js?ver=5.7.5' id='comment-reply-js'></script>
<script type='text/javascript' id='disqus_count-js-extra'>
/* <![CDATA[ */
var countVars = {"disqusShortname":"samposium-blog"};
/* ]]> */
</script>
<script type='text/javascript' src='https://samnicholls.net/wp-content/plugins/disqus-comment-system/public/js/comment_count.js?ver=3.0.17' id='disqus_count-js'></script>
<script type='text/javascript' id='disqus_embed-js-extra'>
/* <![CDATA[ */
var embedVars = {"disqusConfig":{"integration":"wordpress 3.0.17"},"disqusIdentifier":"385 https:\/\/samnicholls.net\/?p=385","disqusShortname":"samposium-blog","disqusTitle":"How (not) to subset a BAM for GATK","disqusUrl":"https:\/\/samnicholls.net\/2016\/01\/10\/not-bam-subset\/","postId":"385"};
/* ]]> */
</script>
<script type='text/javascript' src='https://samnicholls.net/wp-content/plugins/disqus-comment-system/public/js/comment_embed.js?ver=3.0.17' id='disqus_embed-js'></script>
<script type='text/javascript' src='https://s0.wp.com/wp-content/js/devicepx-jetpack.js?ver=202335' id='devicepx-js'></script>
<script type='text/javascript' src='https://samnicholls.net/wp-content/plugins/jetpack/_inc/twitter-timeline.js?ver=4.0.0' id='jetpack-twitter-timeline-js'></script>
<script type='text/javascript' src='https://samnicholls.net/wp-includes/js/wp-embed.min.js?ver=5.7.5' id='wp-embed-js'></script>
<script type='text/javascript' src='https://stats.wp.com/e-202335.js' async defer></script>
<script type='text/javascript'>
	_stq = window._stq || [];
	_stq.push([ 'view', {v:'ext',j:'1:4.9',blog:'101350222',post:'385',tz:'1',srv:'samnicholls.net'} ]);
	_stq.push([ 'clickTrackerInit', '101350222', '385' ]);
</script>

<script type="text/javascript">
(function() {
  if (navigator.userAgent.match(/IEMobile\/10\.0/)) {
    var msViewportStyle = document.createElement("style");
    msViewportStyle.appendChild(
      document.createTextNode("@-ms-viewport{width:auto!important}")
    );
    document.getElementsByTagName("head")[0].appendChild(msViewportStyle);
  }
})();

var collapsed = false;
jQuery( document ).ready(function($) {
    $('.navbar-toggle').click(function(){
        console.log(collapsed);
        if(collapsed) {
            $('.navbar-header > button').html('<i class="fa fa-bars"></i>');
        } else {
            $('.navbar-header > button').html('<i class="fa fa-times"></i>');
        }
        $('.navbar-collapse').toggle(200);
        collapsed = !collapsed;
    });
});
</script>
	
</body>

</html>
